<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Event Planner</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <metahttp-equiv="Expires" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
            color: #495057;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: visible;
        }

        .header {
            background: #e3f2fd;
            color: #1976d2;
            padding: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .header p {
            opacity: 0.7;
            font-size: 1rem;
        }

        .nav {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
        }

        .nav button {
            background: transparent;
            color: #6b7280;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .nav button:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .nav button.active {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .content {
            padding: 24px;
        }

        .data-section {
            display: none;
        }

        .data-section.active {
            display: block;
        }

        .data-section h2 {
            font-size: 1.5rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 20px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            font-weight: 600;
            color: #1d4ed8;
            margin-bottom: 4px;
        }

        .stat-card p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Search and Filter Controls */
        .search-controls {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .filter-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .filter-button:hover {
            background: #2563eb;
        }

        .clear-filters {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .clear-filters:hover {
            background: #4b5563;
        }

        .add-button {
            background: #16a34a;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .add-button:hover {
            background: #15803d;
        }

        .filter-summary {
            background: #e0f2fe;
            border: 1px solid #81d4fa;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.85rem;
            color: #0277bd;
            margin-bottom: 16px;
            display: none;
        }

        .filter-summary.active {
            display: block;
        }

        .filter-tag {
            background: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 4px;
            display: inline-block;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            overflow-y: visible;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            width: 100%;
            max-width: 100%;
        }

        .scroll-hint {
            background: #f3f4f6;
            color: #6b7280;
            text-align: center;
            padding: 8px;
            font-size: 0.8rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th {
            background: #f8f9fa;
            color: #374151;
            font-weight: 600;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
            white-space: nowrap;
            min-width: 100px;
        }

        .data-table td.description,
        .data-table td.additional_info {
            white-space: normal;
            max-width: 200px;
            word-wrap: break-word;
        }

        /* Social Media Links */
        .data-table a[href*="instagram.com"] {
            color: #E4405F !important;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .data-table a[href*="instagram.com"]:hover {
            color: #C13584 !important;
            text-decoration: underline;
        }

        .data-table a[href*="twitter.com"] {
            color: #1DA1F2 !important;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .data-table a[href*="twitter.com"]:hover {
            color: #0d8bd9 !important;
            text-decoration: underline;
        }

        .data-table a[href*="facebook.com"] {
            color: #1877F2 !important;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .data-table a[href*="facebook.com"]:hover {
            color: #166fe5 !important;
            text-decoration: underline;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr.hidden {
            display: none;
        }

        .badge {
            background: #dbeafe;
            color: #1d4ed8;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge.zero {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge.high {
            background: #dcfce7;
            color: #16a34a;
        }

        /* Source type badges */
        .badge-instagram {
            background: #fdf2f8;
            color: #be185d;
        }

        .badge-website {
            background: #eff6ff;
            color: #1d4ed8;
        }

        .badge-eventbrite {
            background: #f0fdf4;
            color: #166534;
        }

        .badge-facebook {
            background: #eff6ff;
            color: #1e40af;
        }

        .badge-meetup {
            background: #fef3c7;
            color: #d97706;
        }

        .badge-twitter {
            background: #f0f9ff;
            color: #0ea5e9;
        }

        .badge-youtube {
            background: #fef2f2;
            color: #dc2626;
        }

        .badge-tiktok {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .badge-other {
            background: #f9fafb;
            color: #6b7280;
        }

        /* Event type badges */
        .badge-photowalk {
            background: #f0f9ff;
            color: #0369a1;
            border: 1px solid #bae6fd;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-exhibition {
            background: #fef7ff;
            color: #9333ea;
            border: 1px solid #e9d5ff;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-tour {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-festival {
            background: #fff7ed;
            color: #ea580c;
            border: 1px solid #fed7aa;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-workshop {
            background: #fefce8;
            color: #ca8a04;
            border: 1px solid #fde047;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-cultural {
            background: #fdf4ff;
            color: #c026d3;
            border: 1px solid #f3e8ff;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-film {
            background: #1f2937;
            color: #f9fafb;
            border: 1px solid #374151;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-art {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-language {
            background: #ecfdf5;
            color: #059669;
            border: 1px solid #a7f3d0;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-default {
            background: #f8fafc;
            color: #64748b;
            border: 1px solid #e2e8f0;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        /* Action Buttons */
        .edit-btn, .delete-btn {
            background: none;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0 2px;
            transition: background-color 0.2s ease;
        }

        .edit-btn:hover {
            background: #dbeafe;
        }

        .delete-btn:hover {
            background: #fee2e2;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* No Results Message */
        .no-results {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-style: italic;
        }

        .no-results-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .search-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input {
                min-width: auto;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>🏛️ Event Planner Admin Dashboard</h1>
                    <p>Complete management interface for Cities and Venues</p>
                </div>
                <div style="text-align: right;">
                    <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
                        👤 {{ session.user_name or session.user_email or 'Local Development' }}
                    </div>
                    {% if request.host.startswith('localhost') or request.host.startswith('127.0.0.1') or request.host.startswith('10.') %}
                    <div style="color: #f39c12; font-size: 0.8rem; margin-bottom: 0.5rem;">
                        🔧 Local Dev Mode (OAuth Bypassed)
                    </div>
                    {% elif session.user_email %}
                    <div style="color: #27ae60; font-size: 0.8rem; margin-bottom: 0.5rem;">
                        🔐 Authenticated via Google OAuth
                    </div>
                    {% else %}
                    <div style="color: #e74c3c; font-size: 0.8rem; margin-bottom: 0.5rem;">
                        🔐 OAuth Required
                    </div>
                    {% endif %}
                    <a href="/auth/logout" style="color: #e74c3c; text-decoration: none; font-size: 0.9rem;">
                        🚪 Logout
                    </a>
                </div>
            </div>
        </div>

        <div class="nav">
            <button onclick="showSection('overview')" class="nav-btn active" id="nav-overview">📊 Overview</button>
            <button onclick="showSection('cities')" class="nav-btn" id="nav-cities">🏙️ Cities</button>
            <button onclick="showSection('venues')" class="nav-btn" id="nav-venues">🏛️ Venues</button>
            <button onclick="showSection('sources')" class="nav-btn" id="nav-sources">📱 Sources</button>
            <button onclick="showSection('events')" class="nav-btn" id="nav-events">🎭 Events</button>
        </div>

        <div class="content">
            <!-- Overview Section -->
            <div id="overview" class="data-section active">
                <h2>📊 System Overview</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="loading">Loading statistics...</div>
                </div>
            </div>

            <!-- Cities Section -->
            <div id="cities" class="data-section">
                <h2>🏙️ Cities Management</h2>
                
                <!-- Search and Filter Controls -->
                <div class="search-controls">
                    <input type="text" id="citySearch" class="search-input" placeholder="🔍 Search cities...">
                    <select id="cityCountryFilter" class="filter-select">
                        <option value="">All Countries</option>
                    </select>
                    <select id="cityVenueFilter" class="filter-select">
                        <option value="">All Venue Counts</option>
                        <option value="0">None (0)</option>
                        <option value="1-4">Few (1-4)</option>
                        <option value="5+">Many (5+)</option>
                    </select>
                    <button onclick="applyCityFilters()" class="filter-button">🔍 Filter</button>
                    <button onclick="clearCityFilters()" class="clear-filters">🗑️ Clear</button>
                    <button onclick="openAddCityModal()" class="add-button">➕ Add City</button>
                    <button onclick="exportCitiesFromDatabase()" class="add-button" style="background: #8b5cf6;">📤 Export from DB</button>
                        </div>

                <div id="cityFilterSummary" class="filter-summary"></div>
                
                <div class="table-container">
                    <div class="scroll-hint">← Scroll horizontally and vertically to see all data →</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>State</th>
                                <th>Country</th>
                                <th>Timezone</th>
                                <th>Display Name</th>
                                <th>Venues</th>
                                <th>Events</th>
                                <th>Created</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="citiesTable">
                            <tr><td colspan="11" class="loading">Loading cities...</td></tr>
                        </tbody>
                    </table>
                        </div>
            </div>

            <!-- Venues Section -->
            <div id="venues" class="data-section">
                <h2>🏛️ Venues Management</h2>
                
                <!-- Search and Filter Controls -->
                <div class="search-controls">
                    <input type="text" id="venueSearch" class="search-input" placeholder="🔍 Search venues...">
                    <select id="venueTypeFilter" class="filter-select">
                        <option value="">All Types</option>
                            </select>
                    <select id="venueCityFilter" class="filter-select">
                        <option value="">All Cities</option>
                            </select>
                    <select id="venueFeeFilter" class="filter-select">
                        <option value="">All Admission Fees</option>
                        <option value="free">Free Admission</option>
                        <option value="paid">Paid Admission</option>
                    </select>
                    <select id="venueSortBy" class="filter-select">
                        <option value="">Sort by...</option>
                        <option value="name">Name (A-Z)</option>
                        <option value="name_desc">Name (Z-A)</option>
                        <option value="updated_at_desc">Recently Updated</option>
                        <option value="updated_at">Oldest Updated</option>
                        <option value="created_at_desc">Recently Added</option>
                        <option value="created_at">Oldest Added</option>
                        <option value="venue_type">Type (A-Z)</option>
                        <option value="city_name">City (A-Z)</option>
                    </select>
                    <button onclick="applyVenueFilters()" class="filter-button">🔍 Filter</button>
                    <button onclick="clearVenueFilters()" class="clear-filters">🗑️ Clear</button>
                    <button onclick="openAddVenueModal()" class="add-button">➕ Add Venue</button>
                    <button onclick="manageJsonCopy()" class="add-button" style="background: #10b981;">📋 Manage venues.json</button>
                    <button onclick="exportVenuesFromDatabase()" class="add-button" style="background: #8b5cf6;">📤 Export from DB</button>
                        </div>

                <div id="venueFilterSummary" class="filter-summary"></div>
                
                <div class="table-container">
                    <div class="scroll-hint">← Scroll horizontally and vertically to see all data →</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <!-- Headers will be dynamically generated -->
                            </tr>
                        </thead>
                        <tbody id="venuesTable">
                            <tr><td colspan="20" class="loading">Loading venues...</td></tr>
                        </tbody>
                    </table>
                        </div>
            </div>

            <!-- Events Section -->
            <div id="events" class="data-section">
                <h2>🎭 Events Management</h2>
                
                <!-- Search and Filter Controls -->
                <div class="search-controls">
                    <input type="text" id="eventSearch" class="search-input" placeholder="🔍 Search events...">
                    <select id="eventTypeFilter" class="filter-select">
                        <option value="">All Types</option>
                    </select>
                    <select id="eventVenueFilter" class="filter-select">
                        <option value="">All Venues</option>
                    </select>
                    <button onclick="applyEventFilters()" class="filter-button">🔍 Filter</button>
                    <button onclick="clearEventFilters()" class="clear-filters">🗑️ Clear</button>
                    <button onclick="openAddEventModal()" class="add-button">➕ Add Event</button>
                </div>

                <div id="eventFilterSummary" class="filter-summary"></div>
                
                <div class="table-container">
                    <div class="scroll-hint">← Scroll horizontally and vertically to see all data →</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Venue</th>
                                <th>Start Date</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Description</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="eventsTable">
                            <tr><td colspan="10" class="loading">Loading events...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sources Section -->
            <div id="sources" class="data-section">
                <h2>📱 Sources Management</h2>
                
                <!-- Search and Filter Controls -->
                <div class="search-controls">
                    <input type="text" id="sourceSearch" class="search-input" placeholder="🔍 Search sources...">
                    <select id="sourceTypeFilter" class="filter-select">
                        <option value="">All Types</option>
                        <option value="instagram">Instagram</option>
                        <option value="website">Website</option>
                        <option value="eventbrite">Eventbrite</option>
                        <option value="facebook">Facebook</option>
                        <option value="meetup">Meetup</option>
                    </select>
                    <select id="sourceCityFilter" class="filter-select">
                        <option value="">All Cities</option>
                    </select>
                    <button onclick="applySourceFilters()" class="filter-button">🔍 Filter</button>
                    <button onclick="clearSourceFilters()" class="clear-filters">🗑️ Clear</button>
                    <button onclick="openAddSourceModal()" class="add-button">➕ Add Source</button>
                    <button onclick="exportSourcesFromDatabase()" class="add-button" style="background: #8b5cf6;">📤 Export from DB</button>
                </div>

                <div id="sourceFilterSummary" class="filter-summary"></div>
                
                <div class="table-container">
                    <div class="scroll-hint">← Scroll horizontally and vertically to see all data →</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Handle</th>
                                <th>Type</th>
                                <th>City</th>
                                <th>Event Types</th>
                                <th>Reliability</th>
                                <th>Frequency</th>
                                <th>Active</th>
                                <th>Events Found</th>
                                <th>Last Checked</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sourcesTable">
                            <tr><td colspan="12" class="loading">Loading sources...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

    <!-- Add City Modal -->
    <div id="addCityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New City</h3>
                <span class="close" onclick="closeModal('addCityModal')">&times;</span>
                        </div>
            <form id="addCityForm">
                <div class="form-group">
                    <label for="cityName">City Name *</label>
                    <input type="text" id="cityName" required>
                        </div>
                <div class="form-group">
                    <label for="cityState">State/Province</label>
                    <input type="text" id="cityState">
                        </div>
                <div class="form-group">
                    <label for="cityCountry">Country *</label>
                    <input type="text" id="cityCountry" required>
                        </div>
                <div class="form-group">
                    <label for="cityTimezone">Timezone</label>
                    <input type="text" id="cityTimezone" placeholder="e.g., America/New_York">
                        </div>
                <div class="form-group">
                    <label for="cityDisplayName">Display Name</label>
                    <input type="text" id="cityDisplayName">
                        </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCityModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add City</button>
                        </div>
            </form>
                        </div>
                        </div>
                        
    <!-- Add Venue Modal -->
    <div id="addVenueModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Add New Venue</h3>
                <span class="close" onclick="closeModal('addVenueModal')">&times;</span>
            </div>
            <form id="addVenueForm">
                <!-- Dynamic form fields will be generated here -->
                <div id="dynamicVenueFormFields"></div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addVenueModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Venue</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit City Modal -->
    <div id="editCityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit City</h3>
                <span class="close" onclick="closeModal('editCityModal')">&times;</span>
            </div>
            <form id="editCityForm">
                <input type="hidden" id="editCityId">
                <div class="form-group">
                    <label for="editCityName">City Name *</label>
                    <input type="text" id="editCityName" required>
                </div>
                <div class="form-group">
                    <label for="editCityState">State</label>
                    <input type="text" id="editCityState">
                </div>
                <div class="form-group">
                    <label for="editCityCountry">Country *</label>
                    <input type="text" id="editCityCountry" required>
                </div>
                <div class="form-group">
                    <label for="editCityTimezone">Timezone</label>
                    <input type="text" id="editCityTimezone">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editCityModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update City</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Venue Modal -->
    <div id="editVenueModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Edit Venue</h3>
                <span class="close" onclick="closeModal('editVenueModal')">&times;</span>
            </div>
            <form id="editVenueForm">
                <input type="hidden" id="editVenueId">
                <div class="form-group">
                    <label for="editVenueName">Venue Name *</label>
                    <input type="text" id="editVenueName" required>
                </div>
                <div class="form-group">
                    <label for="editVenueType">Venue Type *</label>
                    <select id="editVenueType" required>
                        <option value="">Select Type</option>
                        <option value="museum">Museum</option>
                        <option value="gallery">Gallery</option>
                        <option value="theater">Theater</option>
                        <option value="concert_hall">Concert Hall</option>
                        <option value="park">Park</option>
                        <option value="landmark">Landmark</option>
                        <option value="cultural_center">Cultural Center</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editVenueAddress">Address</label>
                    <input type="text" id="editVenueAddress">
                </div>
                <div class="form-group">
                    <label for="editVenueDescription">Description</label>
                    <textarea id="editVenueDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editVenueHours">Opening Hours</label>
                    <input type="text" id="editVenueHours">
                </div>
                <div class="form-group">
                    <label for="editVenuePhone">Phone Number</label>
                    <input type="text" id="editVenuePhone">
                </div>
                <div class="form-group">
                    <label for="editVenueEmail">Email</label>
                    <input type="email" id="editVenueEmail">
                </div>
                <div class="form-group">
                    <label for="editVenueWebsite">Website URL</label>
                    <input type="url" id="editVenueWebsite">
                </div>
                <div class="form-group">
                    <label for="editVenueAdmission">Admission Fee</label>
                    <input type="text" id="editVenueAdmission">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editVenueModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Venue</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="editEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Event</h3>
                <span class="close" onclick="closeModal('editEventModal')">&times;</span>
            </div>
            <form id="editEventForm">
                <input type="hidden" id="editEventId">
                <div class="form-group">
                    <label for="editEventTitle">Event Title *</label>
                    <input type="text" id="editEventTitle" required>
                </div>
                <div class="form-group">
                    <label for="editEventDescription">Description</label>
                    <textarea id="editEventDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editEventStartDate">Start Date *</label>
                    <input type="date" id="editEventStartDate" required>
                </div>
                <div class="form-group">
                    <label for="editEventStartTime">Start Time</label>
                    <input type="time" id="editEventStartTime">
                </div>
                <div class="form-group">
                    <label for="editEventEndTime">End Time</label>
                    <input type="time" id="editEventEndTime">
                </div>
                <div class="form-group">
                    <label for="editEventType">Event Type</label>
                    <input type="text" id="editEventType">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editEventModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Source Modal -->
    <div id="addSourceModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Add New Source</h3>
                <span class="close" onclick="closeModal('addSourceModal')">&times;</span>
            </div>
            <form id="addSourceForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="sourceInput">Instagram Handle or Website URL *</label>
                        <input type="text" id="sourceInput" required placeholder="e.g., @princetonphotoclub or https://example.com">
                        <small style="color: #666; font-size: 0.8em; display: block; margin-top: 5px;">Just paste the Instagram handle (@username) or website URL - we'll detect the type and fill in the rest!</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="sourceCity">City *</label>
                        <select id="sourceCity" required>
                            <option value="">Select City</option>
                        </select>
                    </div>
                </div>
                
                <!-- Hidden fields that will be auto-filled -->
                <input type="hidden" id="sourceName" value="">
                <input type="hidden" id="sourceHandle" value="">
                <input type="hidden" id="sourceType" value="">
                <input type="hidden" id="sourceUrl" value="">
                
                
                <div class="form-group">
                    <label for="sourceDescription">Description</label>
                    <textarea id="sourceDescription" rows="3" placeholder="Brief description of what this source posts..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="sourceReliability">Reliability Score (1-10)</label>
                        <input type="number" id="sourceReliability" min="1" max="10" step="0.1" value="5" placeholder="5.0">
                    </div>
                    <div class="form-group">
                        <label for="sourceFrequency">Posting Frequency</label>
                        <select id="sourceFrequency">
                            <option value="">Select Frequency</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="irregular">Irregular</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="sourceEventTypes">Event Types (comma-separated)</label>
                    <input type="text" id="sourceEventTypes" placeholder="photowalk, tour, exhibition, festival">
                </div>
                
                <div class="form-group">
                    <label for="sourceNotes">Notes</label>
                    <textarea id="sourceNotes" rows="2" placeholder="Special instructions, patterns, or additional info..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="sourceScrapingPattern">Scraping Pattern</label>
                    <textarea id="sourceScrapingPattern" rows="2" placeholder="How to check this source for events..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="sourceActive" checked> Active Source
                    </label>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addSourceModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Source</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Source Modal -->
    <div id="editSourceModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Edit Source</h3>
                <span class="close" onclick="closeModal('editSourceModal')">&times;</span>
            </div>
            <form id="editSourceForm">
                <input type="hidden" id="editSourceId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editSourceName">Source Name *</label>
                        <input type="text" id="editSourceName" required>
                    </div>
                    <div class="form-group">
                        <label for="editSourceHandle">Handle *</label>
                        <input type="text" id="editSourceHandle" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editSourceType">Source Type *</label>
                        <select id="editSourceType" required>
                            <option value="">Select Type</option>
                            <option value="instagram">Instagram</option>
                            <option value="website">Website</option>
                            <option value="eventbrite">Eventbrite</option>
                            <option value="facebook">Facebook</option>
                            <option value="meetup">Meetup</option>
                            <option value="twitter">Twitter</option>
                            <option value="youtube">YouTube</option>
                            <option value="tiktok">TikTok</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editSourceCity">City *</label>
                        <select id="editSourceCity" required>
                            <option value="">Select City</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editSourceUrl">URL</label>
                    <input type="url" id="editSourceUrl">
                </div>
                
                <div class="form-group">
                    <label for="editSourceDescription">Description</label>
                    <textarea id="editSourceDescription" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editSourceReliability">Reliability Score (1-10)</label>
                        <input type="number" id="editSourceReliability" min="1" max="10" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editSourceFrequency">Posting Frequency</label>
                        <select id="editSourceFrequency">
                            <option value="">Select Frequency</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="irregular">Irregular</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editSourceEventTypes">Event Types (comma-separated)</label>
                    <input type="text" id="editSourceEventTypes">
                </div>
                
                <div class="form-group">
                    <label for="editSourceNotes">Notes</label>
                    <textarea id="editSourceNotes" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editSourceScrapingPattern">Scraping Pattern</label>
                    <textarea id="editSourceScrapingPattern" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editSourceActive"> Active Source
                    </label>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editSourceModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Source</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        console.log('Minimal script test - starting...');
        
        // Simple test function
        async function loadOverview() {
            try {
                console.log('Loading overview statistics...');
                const statsGrid = document.getElementById('statsGrid');
                
                if (!statsGrid) {
                    console.error('statsGrid element not found!');
                    return;
                }
                
                const response = await fetch('/api/admin/stats');
                const stats = await response.json();
                
                statsGrid.innerHTML = 
                    '<div class="stat-card" onclick="showSection(\'cities\')" style="cursor: pointer;">' +
                        '<h3>' + stats.cities + '</h3>' +
                        '<p>🏙️ Cities</p>' +
                    '</div>' +
                    '<div class="stat-card" onclick="showSection(\'venues\')" style="cursor: pointer;">' +
                        '<h3>' + stats.venues + '</h3>' +
                        '<p>🏛️ Venues</p>' +
                    '</div>' +
                    '<div class="stat-card" onclick="showSection(\'sources\')" style="cursor: pointer;">' +
                        '<h3>' + (stats.sources || 0) + '</h3>' +
                        '<p>📱 Sources</p>' +
                    '</div>' +
                    '<div class="stat-card" onclick="showSection(\'events\')" style="cursor: pointer;">' +
                        '<h3>' + stats.events + '</h3>' +
                        '<p>🎭 Events</p>' +
                    '</div>';
                
                console.log('Statistics loaded successfully');
            } catch (error) {
                console.error('Error loading overview:', error);
                const statsGrid = document.getElementById('statsGrid');
                if (statsGrid) {
                    statsGrid.innerHTML = '<div class="no-results">❌ Failed to load statistics: ' + error.message + '</div>';
                }
            }
        }
        
        // Navigation functions
        function showSection(sectionName) {
            console.log('Switching to section:', sectionName);
            
            // Hide all sections
            document.querySelectorAll('.data-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            document.getElementById('nav-' + sectionName).classList.add('active');
            
            // Load data for the section
            switch(sectionName) {
                case 'overview':
                    loadOverview();
                    break;
                case 'cities':
                    loadCities();
                    break;
                case 'venues':
                    loadVenues();
                    break;
                case 'events':
                    loadEvents();
                    break;
                case 'sources':
                    loadSources();
                    break;
            }
            
            console.log('Section switched successfully');
        }
        
        // Load cities data
        async function loadCities() {
            try {
                console.log('Loading cities...');
                const response = await fetch('/api/admin/cities');
                const cities = await response.json();
                
                if (cities.error) throw new Error(cities.error);
                
                console.log('Cities loaded:', cities.length);
                
                // Store cities globally for filtering
                window.allCities = cities;
                window.filteredCities = [...cities];
                
                // Render the cities table
                renderCitiesTable();
                populateCityFilters();
                
            } catch (error) {
                console.error('Error loading cities:', error);
                const citiesTable = document.getElementById('citiesTable');
                if (citiesTable) {
                    citiesTable.innerHTML = '<tr><td colspan="11" class="no-results">❌ Failed to load cities: ' + error.message + '</td></tr>';
                }
            }
        }
        
        // Render cities table dynamically
        function renderCitiesTable() {
            const data = window.filteredCities || window.allCities || [];
            renderDynamicTable('citiesTable', data, 'cities');
        }
        
        // Populate city filters
        function populateCityFilters() {
            const countryFilter = document.getElementById('cityCountryFilter');
            if (!countryFilter || !window.allCities) return;
            
            const countries = [...new Set(window.allCities.map(city => city.country).filter(Boolean))].sort();
            
            countryFilter.innerHTML = '<option value="">All Countries</option>';
            countries.forEach(country => {
                countryFilter.innerHTML += '<option value="' + country + '">' + country + '</option>';
            });
        }
        
        // City filter functions
        function applyCityFilters() {
            if (!window.allCities) return;
            
            const searchTerm = document.getElementById('citySearch').value.toLowerCase();
            const countryFilter = document.getElementById('cityCountryFilter').value;
            const venueFilter = document.getElementById('cityVenueFilter').value;
            
            window.filteredCities = window.allCities.filter(city => {
                const matchesSearch = !searchTerm || 
                    city.name.toLowerCase().includes(searchTerm) ||
                    (city.state && city.state.toLowerCase().includes(searchTerm)) ||
                    city.country.toLowerCase().includes(searchTerm);
                
                const matchesCountry = !countryFilter || city.country === countryFilter;
                
                const matchesVenue = !venueFilter || (() => {
                    const count = city.venue_count || 0;
                    switch (venueFilter) {
                        case '0': return count === 0;
                        case '1-4': return count >= 1 && count <= 4;
                        case '5+': return count >= 5;
                        default: return true;
                    }
                })();
                
                return matchesSearch && matchesCountry && matchesVenue;
            });
            
            renderCitiesTable();
        }
        
        function clearCityFilters() {
            document.getElementById('citySearch').value = '';
            document.getElementById('cityCountryFilter').value = '';
            document.getElementById('cityVenueFilter').value = '';
            
            if (window.allCities) {
                window.filteredCities = [...window.allCities];
                renderCitiesTable();
            }
        }
        
        function openAddCityModal() {
            document.getElementById('addCityModal').style.display = 'block';
            // Clear form
            document.getElementById('addCityForm').reset();
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function editCity(id) {
            // Find the city data
            const city = window.allCities.find(c => c.id == id);
            if (!city) {
                alert('City not found');
                return;
            }
            
            // Populate the edit form
            document.getElementById('editCityId').value = city.id;
            document.getElementById('editCityName').value = city.name;
            document.getElementById('editCityState').value = city.state || '';
            document.getElementById('editCityCountry').value = city.country;
            document.getElementById('editCityTimezone').value = city.timezone || '';
            
            // Show the modal
            document.getElementById('editCityModal').style.display = 'block';
        }
        
        function deleteCity(id) {
            if (confirm('Are you sure you want to delete this city? This will also delete all associated venues and events.')) {
                handleDeleteCity(id);
            }
        }
        
        // Handle delete city API call
        async function handleDeleteCity(cityId) {
            try {
                console.log('Deleting city:', cityId);
                
                const response = await fetch('/api/admin/cities/' + cityId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('City deleted successfully:', result);
                    alert('City deleted successfully!');
                    
                    // Reload cities data
                    await loadCities();
                    
                } else {
                    console.error('Error deleting city:', result);
                    alert('Error deleting city: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error deleting city:', error);
                alert('Error deleting city: ' + error.message);
            }
        }
        
        // Load venues data
        async function loadVenues() {
            try {
                console.log('Loading venues...');
                const response = await fetch('/api/admin/venues');
                const venues = await response.json();
                
                if (venues.error) throw new Error(venues.error);
                
                console.log('Venues loaded:', venues.length);
                
                // Store venues globally for filtering
                window.allVenues = venues;
                window.filteredVenues = [...venues];
                
                // Render the venues table
                renderVenuesTable();
                populateVenueFilters();
                
            } catch (error) {
                console.error('Error loading venues:', error);
                const venuesTable = document.getElementById('venuesTable');
                if (venuesTable) {
                    venuesTable.innerHTML = '<tr><td colspan="20" class="no-results">❌ Failed to load venues: ' + error.message + '</td></tr>';
                }
            }
        }
        
        // Sorting functionality for dynamic tables
        function sortTable(tableId, field) {
            // Determine which data array to sort based on table ID
            let dataArray;
            let filteredArray;
            
            switch(tableId) {
                case 'citiesTable':
                    dataArray = window.allCities;
                    filteredArray = window.filteredCities;
                    break;
                case 'venuesTable':
                    dataArray = window.allVenues;
                    filteredArray = window.filteredVenues;
                    break;
                case 'eventsTable':
                    dataArray = window.allEvents;
                    filteredArray = window.filteredEvents;
                    break;
                case 'sourcesTable':
                    dataArray = window.allSources;
                    filteredArray = window.filteredSources;
                    break;
                default:
                    console.error('Unknown table ID for sorting:', tableId);
                    return;
            }
            
            if (!dataArray || !filteredArray) {
                console.error('Data arrays not available for sorting');
                return;
            }
            
            // Toggle sort direction (store in data attribute)
            const table = document.querySelector(`#${tableId}`).closest('table');
            const currentSort = table.dataset.currentSort;
            const currentField = table.dataset.currentField;
            
            let ascending = true;
            if (currentField === field && currentSort === 'asc') {
                ascending = false;
            }
            
            // Update table data attributes
            table.dataset.currentField = field;
            table.dataset.currentSort = ascending ? 'asc' : 'desc';
            
            // Sort the filtered data
            filteredArray.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                // Handle null/undefined values
                if (aVal === null || aVal === undefined) aVal = '';
                if (bVal === null || bVal === undefined) bVal = '';
                
                // Handle different data types
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                // Handle dates (ISO format)
                if (field.includes('_at') || field.includes('_date')) {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                // Compare values
                if (aVal < bVal) return ascending ? -1 : 1;
                if (aVal > bVal) return ascending ? 1 : -1;
                return 0;
            });
            
            // Update the corresponding all data array to maintain consistency
            const sortedIndices = filteredArray.map(item => dataArray.findIndex(original => original.id === item.id));
            const newAllArray = sortedIndices.map(index => dataArray[index]);
            Object.assign(dataArray, newAllArray);
            
            // Re-render the table
            const tableType = tableId.replace('Table', '');
            renderDynamicTable(tableId, filteredArray, tableType);
            
            // Update header arrows to show sort direction
            updateSortArrows(table, field, ascending);
        }
        
        function updateSortArrows(table, field, ascending) {
            // Remove all arrows first
            const headers = table.querySelectorAll('th');
            headers.forEach(header => {
                const text = header.textContent.replace(' ↕', '').replace(' ↑', '').replace(' ↓', '');
                header.textContent = text + ' ↕';
            });
            
            // Add arrow to current field
            const currentHeader = Array.from(headers).find(header => 
                header.textContent.includes(field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))
            );
            if (currentHeader) {
                const text = currentHeader.textContent.replace(' ↕', '').replace(' ↑', '').replace(' ↓', '');
                currentHeader.textContent = text + (ascending ? ' ↑' : ' ↓');
            }
        }
        
        function getEventTypeBadgeClass(eventType) {
            // Return appropriate badge class based on event type
            const type = eventType.toLowerCase();
            
            if (type.includes('photowalk') || type.includes('photo_walk')) {
                return 'badge-photowalk';
            } else if (type.includes('exhibition') || type.includes('gallery')) {
                return 'badge-exhibition';
            } else if (type.includes('tour')) {
                return 'badge-tour';
            } else if (type.includes('festival') || type.includes('event')) {
                return 'badge-festival';
            } else if (type.includes('workshop') || type.includes('class')) {
                return 'badge-workshop';
            } else if (type.includes('cultural') || type.includes('culture')) {
                return 'badge-cultural';
            } else if (type.includes('film') || type.includes('cinema')) {
                return 'badge-film';
            } else if (type.includes('art') || type.includes('creative')) {
                return 'badge-art';
            } else if (type.includes('language') || type.includes('french')) {
                return 'badge-language';
            } else {
                return 'badge-default';
            }
        }
        
        // Dynamic table rendering system
        function renderDynamicTable(tableId, data, tableType = 'default') {
            const tableBody = document.getElementById(tableId);
            if (!tableBody) return;
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="100" class="no-results">🔍 No data found</td></tr>';
                return;
            }
            
            // Get the first item to determine available fields dynamically
            const sampleItem = data[0];
            const availableFields = Object.keys(sampleItem);
            
            // Define field display preferences (order, visibility, formatting)
            const fieldConfig = getFieldConfig(tableType);
            
            // Filter and order fields based on configuration
            const orderedFields = fieldConfig.order.filter(field => availableFields.includes(field));
            
            // Add any new fields not in the config (for future-proofing)
            const newFields = availableFields.filter(field => !fieldConfig.order.includes(field));
            orderedFields.push(...newFields);
            
            // Generate table headers
            const tableHead = document.querySelector(`#${tableId}`).closest('table').querySelector('thead tr');
            if (tableHead) {
                let headerRow = '';
                
                orderedFields.forEach(field => {
                    const config = fieldConfig.fields[field] || { label: formatFieldName(field), visible: true };
                    if (config.visible !== false) {
                        if (config.sortable !== false) {
                            headerRow += `<th onclick="sortTable('${tableId}', '${field}')" style="cursor: pointer; user-select: none;" title="Click to sort">${config.label} ↕</th>`;
                        } else {
                            headerRow += `<th>${config.label}</th>`;
                        }
                    }
                });
                
                // Always include Actions header
                headerRow += '<th>Actions</th>';
                
                tableHead.innerHTML = headerRow;
            }
            
            // Generate data rows
            tableBody.innerHTML = data.map(item => {
                let row = `<tr id="${tableType}-row-${item.id}">`;
                
                orderedFields.forEach(field => {
                    const config = fieldConfig.fields[field] || { label: formatFieldName(field), visible: true };
                    if (config.visible !== false) {
                        const value = formatFieldValue(field, item[field], config);
                        row += `<td>${value}</td>`;
                    }
                });
                
                // Add actions column
                row += `<td>${generateActionButtons(item.id, tableType)}</td>`;
                
                row += '</tr>';
                return row;
            }).join('');
        }
        
        // Field configuration for different table types
        function getFieldConfig(tableType) {
            const configs = {
                venues: {
                    order: ['id', 'name', 'venue_type', 'city_name', 'address', 'opening_hours', 'phone_number', 'email', 'website_url', 'image_url', 'latitude', 'longitude', 'facebook_url', 'instagram_url', 'twitter_url', 'youtube_url', 'tiktok_url', 'holiday_hours', 'admission_fee', 'tour_info', 'description', 'additional_info', 'created_at', 'updated_at'],
                    fields: {
                        id: { label: 'ID', visible: true, sortable: true },
                        name: { label: 'Name', visible: true, sortable: true },
                        venue_type: { label: 'Type', visible: true, sortable: true },
                        city_name: { label: 'City', visible: true, sortable: true },
                        address: { label: 'Address', visible: true, sortable: true },
                        opening_hours: { label: 'Hours', visible: true, sortable: false },
                        phone_number: { label: 'Phone', visible: true, sortable: false },
                        email: { label: 'Email', visible: true, sortable: false },
                        website_url: { label: 'Website', visible: true, sortable: false },
                        image_url: { label: 'Image', visible: true, sortable: false },
                        latitude: { label: 'Latitude', visible: true, sortable: true },
                        longitude: { label: 'Longitude', visible: true, sortable: true },
                        facebook_url: { label: 'Facebook', visible: true, sortable: false },
                        instagram_url: { label: 'Instagram', visible: true, sortable: false },
                        twitter_url: { label: 'Twitter', visible: true, sortable: false },
                        youtube_url: { label: 'YouTube', visible: true, sortable: false },
                        tiktok_url: { label: 'TikTok', visible: true, sortable: false },
                        holiday_hours: { label: 'Holiday Hours', visible: true, sortable: false },
                        admission_fee: { label: 'Admission', visible: true, sortable: false },
                        tour_info: { label: 'Tour Info', visible: true, sortable: false },
                        description: { label: 'Description', visible: true, sortable: false },
                        additional_info: { label: 'Additional Info', visible: true, sortable: false },
                        created_at: { label: 'Created', visible: true, sortable: true },
                        updated_at: { label: 'Updated', visible: true, sortable: true }
                    }
                },
                sources: {
                    order: ['id', 'name', 'handle', 'source_type', 'city_name', 'event_types', 'reliability_score', 'posting_frequency', 'is_active', 'events_found_count', 'last_checked', 'created_at', 'updated_at'],
                    fields: {
                        id: { label: 'ID', visible: true, sortable: true },
                        name: { label: 'Name', visible: true, sortable: true },
                        handle: { label: 'Handle', visible: true, sortable: true },
                        source_type: { label: 'Type', visible: true, sortable: true },
                        city_name: { label: 'City', visible: true, sortable: true },
                        event_types: { label: 'Event Types', visible: true, sortable: false },
                        reliability_score: { label: 'Reliability', visible: true, sortable: true },
                        posting_frequency: { label: 'Frequency', visible: true, sortable: true },
                        is_active: { label: 'Active', visible: true, sortable: true },
                        events_found_count: { label: 'Events Found', visible: true, sortable: true },
                        last_checked: { label: 'Last Checked', visible: true, sortable: true },
                        created_at: { label: 'Created', visible: true, sortable: true },
                        updated_at: { label: 'Updated', visible: true, sortable: true }
                    }
                },
                events: {
                    order: ['id', 'title', 'description', 'start_date', 'start_time', 'end_date', 'end_time', 'event_type', 'venue_name', 'city_name', 'created_at', 'updated_at'],
                    fields: {
                        id: { label: 'ID', visible: true, sortable: true },
                        title: { label: 'Title', visible: true, sortable: true },
                        description: { label: 'Description', visible: true, sortable: false },
                        start_date: { label: 'Start Date', visible: true, sortable: true },
                        start_time: { label: 'Start Time', visible: true, sortable: true },
                        end_date: { label: 'End Date', visible: true, sortable: true },
                        end_time: { label: 'End Time', visible: true, sortable: true },
                        event_type: { label: 'Type', visible: true, sortable: true },
                        venue_name: { label: 'Venue', visible: true, sortable: true },
                        city_name: { label: 'City', visible: true, sortable: true },
                        created_at: { label: 'Created', visible: true, sortable: true },
                        updated_at: { label: 'Updated', visible: true, sortable: true }
                    }
                },
                cities: {
                    order: ['id', 'name', 'state', 'country', 'display_name', 'timezone', 'venue_count', 'event_count', 'created_at', 'updated_at'],
                    fields: {
                        id: { label: 'ID', visible: true, sortable: true },
                        name: { label: 'Name', visible: true, sortable: true },
                        state: { label: 'State', visible: true, sortable: true },
                        country: { label: 'Country', visible: true, sortable: true },
                        display_name: { label: 'Display Name', visible: true, sortable: true },
                        timezone: { label: 'Timezone', visible: true, sortable: true },
                        venue_count: { label: 'Venues', visible: true, sortable: true },
                        event_count: { label: 'Events', visible: true, sortable: true },
                        created_at: { label: 'Created', visible: true, sortable: true },
                        updated_at: { label: 'Updated', visible: true, sortable: true }
                    }
                }
            };
            
            return configs[tableType] || {
                order: ['id'],
                fields: { id: { label: 'ID', visible: true } }
            };
        }
        
        // Format field names for unknown fields
        function formatFieldName(fieldName) {
            return fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Format field values based on field type and configuration
        function formatFieldValue(fieldName, value, config = {}) {
            if (value === null || value === undefined || value === '') {
                return 'N/A';
            }
            
            // Special formatting for specific fields
            switch (fieldName) {
                case 'website_url':
                case 'url':
                    return `<a href="${value}" target="_blank" style="color: #1976d2; text-decoration: none;">${value}</a>`;
                
                case 'youtube_url':
                    // Handle both full URLs and channel names
                    if (value.startsWith('@')) {
                        // It's already a channel handle like @username
                        const channel = value.substring(1); // Remove @
                        return `<a href="https://www.youtube.com/@${channel}" target="_blank" style="color: #FF0000; text-decoration: none;">${value}</a>`;
                    } else if (value.includes('youtube.com')) {
                        // It's a full URL - extract the meaningful part
                        const channelMatch = value.match(/youtube\.com\/(?:c\/|user\/|@)?([^\/\?]+)/);
                        if (channelMatch) {
                            const channel = channelMatch[1];
                            // Clean up the channel name for display
                            const displayName = channel.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            return `<a href="${value}" target="_blank" style="color: #FF0000; text-decoration: none;">${displayName}</a>`;
                        }
                    }
                    return `<a href="${value}" target="_blank" style="color: #FF0000; text-decoration: none;">YouTube</a>`;
                
                case 'tiktok_url':
                    // Handle both full URLs and usernames
                    if (value.startsWith('@')) {
                        // It's already a username like @username
                        const username = value.substring(1); // Remove @
                        return `<a href="https://www.tiktok.com/@${username}" target="_blank" style="color: #000000; text-decoration: none;">${value}</a>`;
                    } else if (value.includes('tiktok.com')) {
                        // It's a full URL
                        const tiktokMatch = value.match(/tiktok\.com\/@([^\/\?]+)/);
                        if (tiktokMatch) {
                            const username = tiktokMatch[1];
                            return `<a href="${value}" target="_blank" style="color: #000000; text-decoration: none;">@${username}</a>`;
                        }
                    }
                    return `<a href="${value}" target="_blank" style="color: #000000; text-decoration: none;">TikTok</a>`;
                
                case 'facebook_url':
                    // Extract page name from Facebook URL
                    const facebookMatch = value.match(/facebook\.com\/([^\/\?]+)/);
                    if (facebookMatch) {
                        const pageName = facebookMatch[1];
                        return `<a href="${value}" target="_blank" style="color: #1877F2; text-decoration: none;">${pageName}</a>`;
                    }
                    return `<a href="${value}" target="_blank" style="color: #1877F2; text-decoration: none;">Facebook</a>`;
                
                case 'instagram_url':
                    // Handle both full URLs and @handles
                    if (value.startsWith('@')) {
                        // It's already a handle like @username
                        const handle = value.substring(1); // Remove @
                        return `<a href="https://www.instagram.com/${handle}/" target="_blank" style="color: #E4405F; text-decoration: none;">${value}</a>`;
                    } else if (value.includes('instagram.com')) {
                        // It's a full URL
                        const instagramMatch = value.match(/instagram\.com\/([^\/\?]+)/);
                        if (instagramMatch) {
                            const handle = instagramMatch[1];
                            return `<a href="https://www.instagram.com/${handle}/" target="_blank" style="color: #E4405F; text-decoration: none;">@${handle}</a>`;
                        }
                    }
                    return `<a href="${value}" target="_blank" style="color: #E4405F; text-decoration: none;">Instagram</a>`;
                
                case 'twitter_url':
                    // Handle both full URLs and @handles
                    if (value.startsWith('@')) {
                        // It's already a handle like @username
                        const handle = value.substring(1); // Remove @
                        return `<a href="https://twitter.com/${handle}" target="_blank" style="color: #1DA1F2; text-decoration: none;">${value}</a>`;
                    } else if (value.includes('twitter.com')) {
                        // It's a full URL
                        const twitterMatch = value.match(/twitter\.com\/([^\/\?]+)/);
                        if (twitterMatch) {
                            const handle = twitterMatch[1];
                            return `<a href="https://twitter.com/${handle}" target="_blank" style="color: #1DA1F2; text-decoration: none;">@${handle}</a>`;
                        }
                    }
                    return `<a href="${value}" target="_blank" style="color: #1DA1F2; text-decoration: none;">Twitter</a>`;
                
                case 'image_url':
                    return `<a href="${value}" target="_blank" style="color: #1976d2; text-decoration: none;">View</a>`;
                
                case 'handle':
                    if (value.startsWith('@') && value.includes('instagram')) {
                        const handle = value.replace('@', '');
                        return `<a href="https://www.instagram.com/${handle}" target="_blank" style="color: #E4405F; text-decoration: none;">${value}</a>`;
                    }
                    return value;
                
                case 'source_type':
                    return `<span class="badge badge-${value}">${value}</span>`;
                
                case 'venue_type':
                    return `<span class="badge">${value}</span>`;
                
                case 'event_type':
                    return `<span class="badge badge-event">${value}</span>`;
                
                case 'is_active':
                    return value ? '✅' : '❌';
                
                case 'reliability_score':
                    return `${value}/10`;
                
                case 'event_types':
                    // Handle event types as array or string with improved styling
                    if (Array.isArray(value)) {
                        // Already an array from the API
                        return value.map(type => {
                            const cleanType = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            const badgeClass = getEventTypeBadgeClass(type);
                            return `<span class="badge ${badgeClass}" title="${type}">${cleanType}</span>`;
                        }).join(' ');
                    } else if (value && typeof value === 'string') {
                        try {
                            // Try to parse as JSON array
                            const types = JSON.parse(value);
                            if (Array.isArray(types)) {
                                return types.map(type => {
                                    const cleanType = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    const badgeClass = getEventTypeBadgeClass(type);
                                    return `<span class="badge ${badgeClass}" title="${type}">${cleanType}</span>`;
                                }).join(' ');
                            }
                        } catch (e) {
                            // If not JSON, treat as comma-separated
                            return value.split(',').map(type => {
                                const cleanType = type.trim().replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                const badgeClass = getEventTypeBadgeClass(type.trim());
                                return `<span class="badge ${badgeClass}" title="${type.trim()}">${cleanType}</span>`;
                            }).join(' ');
                        }
                    }
                    return '';
                
                case 'created_at':
                case 'updated_at':
                case 'last_checked':
                case 'start_date':
                case 'end_date':
                    try {
                        return new Date(value).toLocaleDateString();
                    } catch (e) {
                        return value;
                    }
                
                case 'start_time':
                case 'end_time':
                    try {
                        return new Date(`2000-01-01T${value}`).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    } catch (e) {
                        return value;
                    }
                
                case 'description':
                case 'tour_info':
                case 'additional_info':
                    if (value.length > 100) {
                        return `<span title="${value}">${value.substring(0, 100)}...</span>`;
                    }
                    return value;
                
                case 'venue_count':
                case 'event_count':
                    const count = parseInt(value) || 0;
                    const badgeClass = count === 0 ? 'badge-zero' : count >= 5 ? 'badge-high' : 'badge';
                    return `<span class="badge ${badgeClass}">${count}</span>`;
                
                default:
                    return value;
            }
        }
        
        // Generate action buttons based on table type
        function generateActionButtons(id, tableType) {
            switch (tableType) {
                case 'venues':
                    return `<button onclick="editVenue(${id})" class="btn btn-sm btn-secondary">✏️</button> <button onclick="deleteVenue(${id})" class="btn btn-sm btn-danger">🗑️</button>`;
                case 'sources':
                    return `<button onclick="editSource(${id})" class="btn btn-sm btn-secondary">✏️</button> <button onclick="deleteSource(${id})" class="btn btn-sm btn-danger">🗑️</button>`;
                case 'events':
                    return `<button onclick="editEvent(${id})" class="btn btn-sm btn-secondary">✏️</button> <button onclick="deleteEvent(${id})" class="btn btn-sm btn-danger">🗑️</button>`;
                case 'cities':
                    return `<button onclick="editCity(${id})" class="btn btn-sm btn-secondary">✏️</button> <button onclick="deleteCity(${id})" class="btn btn-sm btn-danger">🗑️</button>`;
                default:
                    return `<button onclick="editItem(${id})" class="btn btn-sm btn-secondary">✏️</button>`;
            }
        }
        
        // Render venues table using dynamic system
        function renderVenuesTable() {
            const data = window.filteredVenues || window.allVenues || [];
            renderDynamicTable('venuesTable', data, 'venues');
        }
        
        // Populate venue filters
        function populateVenueFilters() {
            const typeFilter = document.getElementById('venueTypeFilter');
            const cityFilter = document.getElementById('venueCityFilter');
            
            if (!typeFilter || !cityFilter || !window.allVenues) return;
            
            const types = [...new Set(window.allVenues.map(venue => venue.venue_type).filter(Boolean))].sort();
            const cities = [...new Set(window.allVenues.map(venue => venue.city_name).filter(Boolean))].sort();
            
            typeFilter.innerHTML = '<option value="">All Types</option>';
            types.forEach(type => {
                typeFilter.innerHTML += '<option value="' + type + '">' + type + '</option>';
            });
            
            cityFilter.innerHTML = '<option value="">All Cities</option>';
            cities.forEach(city => {
                cityFilter.innerHTML += '<option value="' + city + '">' + city + '</option>';
            });
        }
        
        // Venue filter functions
        function applyVenueFilters() {
            if (!window.allVenues) return;
            
            const searchTerm = document.getElementById('venueSearch').value.toLowerCase();
            const typeFilter = document.getElementById('venueTypeFilter').value;
            const cityFilter = document.getElementById('venueCityFilter').value;
            const feeFilter = document.getElementById('venueFeeFilter').value;
            const sortBy = document.getElementById('venueSortBy').value;
            
            window.filteredVenues = window.allVenues.filter(venue => {
                const matchesSearch = !searchTerm || 
                    venue.name.toLowerCase().includes(searchTerm) ||
                    (venue.venue_type && venue.venue_type.toLowerCase().includes(searchTerm)) ||
                    (venue.address && venue.address.toLowerCase().includes(searchTerm)) ||
                    (venue.description && venue.description.toLowerCase().includes(searchTerm));
                
                const matchesType = !typeFilter || venue.venue_type === typeFilter;
                const matchesCity = !cityFilter || venue.city_name === cityFilter;
                
                // Fee filter logic
                let matchesFee = true;
                if (feeFilter === 'free') {
                    matchesFee = !venue.admission_fee || 
                                venue.admission_fee.toLowerCase().includes('free') ||
                                venue.admission_fee.toLowerCase().includes('no charge') ||
                                venue.admission_fee.toLowerCase().includes('complimentary') ||
                                venue.admission_fee === 'N/A';
                } else if (feeFilter === 'paid') {
                    matchesFee = venue.admission_fee && 
                               !venue.admission_fee.toLowerCase().includes('free') &&
                               !venue.admission_fee.toLowerCase().includes('no charge') &&
                               !venue.admission_fee.toLowerCase().includes('complimentary') &&
                               venue.admission_fee !== 'N/A';
                }
                
                return matchesSearch && matchesType && matchesCity && matchesFee;
            });
            
            // Apply sorting if specified
            if (sortBy) {
                window.filteredVenues.sort((a, b) => {
                    switch(sortBy) {
                        case 'name':
                            return (a.name || '').localeCompare(b.name || '');
                        case 'name_desc':
                            return (b.name || '').localeCompare(a.name || '');
                        case 'updated_at_desc':
                            return new Date(b.updated_at || 0) - new Date(a.updated_at || 0);
                        case 'updated_at':
                            return new Date(a.updated_at || 0) - new Date(b.updated_at || 0);
                        case 'created_at_desc':
                            return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                        case 'created_at':
                            return new Date(a.created_at || 0) - new Date(b.created_at || 0);
                        case 'venue_type':
                            return (a.venue_type || '').localeCompare(b.venue_type || '');
                        case 'city_name':
                            return (a.city_name || '').localeCompare(b.city_name || '');
                        default:
                            return 0;
                    }
                });
            }
            
            renderVenuesTable();
        }
        
        function clearVenueFilters() {
            document.getElementById('venueSearch').value = '';
            document.getElementById('venueTypeFilter').value = '';
            document.getElementById('venueCityFilter').value = '';
            document.getElementById('venueFeeFilter').value = '';
            document.getElementById('venueSortBy').value = '';
            
            if (window.allVenues) {
                window.filteredVenues = [...window.allVenues];
                renderVenuesTable();
            }
        }
        
        function openAddVenueModal() {
            // Generate dynamic form fields
            generateDynamicVenueForm();
            
            // Populate city dropdown
            populateVenueCityDropdown();
            
            // Clear form
            document.getElementById('addVenueForm').reset();
            
            // Show modal
            document.getElementById('addVenueModal').style.display = 'block';
        }
        
        function generateDynamicVenueForm() {
            const container = document.getElementById('dynamicVenueFormFields');
            if (!container) return;
            
            // Define all venue fields with their properties
            const venueFields = [
                {
                    id: 'venueName',
                    name: 'name',
                    label: 'Venue Name',
                    type: 'text',
                    required: true,
                    placeholder: 'Enter venue name',
                    special: 'smart_search' // Special handling for smart search button
                },
                {
                    id: 'venueType',
                    name: 'venue_type',
                    label: 'Venue Type',
                    type: 'select',
                    required: true,
                    options: [
                        { value: '', text: 'Select Type' },
                        { value: 'museum', text: 'Museum' },
                        { value: 'gallery', text: 'Gallery' },
                        { value: 'theater', text: 'Theater' },
                        { value: 'concert_hall', text: 'Concert Hall' },
                        { value: 'park', text: 'Park' },
                        { value: 'landmark', text: 'Landmark' },
                        { value: 'cultural_center', text: 'Cultural Center' },
                        { value: 'other', text: 'Other' }
                    ]
                },
                {
                    id: 'venueCity',
                    name: 'city_id',
                    label: 'City',
                    type: 'select',
                    required: true,
                    options: [{ value: '', text: 'Select City' }],
                    special: 'city_dropdown' // Special handling for city population
                },
                {
                    id: 'venueAddress',
                    name: 'address',
                    label: 'Address',
                    type: 'text',
                    placeholder: 'Full street address'
                },
                {
                    id: 'venueLatitude',
                    name: 'latitude',
                    label: 'Latitude',
                    type: 'number',
                    step: '0.000001',
                    placeholder: 'e.g., 38.9072'
                },
                {
                    id: 'venueLongitude',
                    name: 'longitude',
                    label: 'Longitude',
                    type: 'number',
                    step: '0.000001',
                    placeholder: 'e.g., -77.0369'
                },
                {
                    id: 'venueImageUrl',
                    name: 'image_url',
                    label: 'Image URL',
                    type: 'url',
                    placeholder: 'https://example.com/image.jpg'
                },
                {
                    id: 'venueDescription',
                    name: 'description',
                    label: 'Description',
                    type: 'textarea',
                    rows: 3,
                    placeholder: 'Brief description of the venue...'
                },
                {
                    id: 'venueOpeningHours',
                    name: 'opening_hours',
                    label: 'Opening Hours',
                    type: 'text',
                    placeholder: 'e.g., Mon-Fri: 9AM-5PM, Sat-Sun: 10AM-6PM'
                },
                {
                    id: 'venueHolidayHours',
                    name: 'holiday_hours',
                    label: 'Holiday Hours',
                    type: 'text',
                    placeholder: 'e.g., Closed on Thanksgiving and Christmas'
                },
                {
                    id: 'venuePhone',
                    name: 'phone_number',
                    label: 'Phone Number',
                    type: 'tel',
                    placeholder: 'e.g., (202) 555-0123'
                },
                {
                    id: 'venueEmail',
                    name: 'email',
                    label: 'Email',
                    type: 'email',
                    placeholder: 'info@venue.com'
                },
                {
                    id: 'venueWebsite',
                    name: 'website_url',
                    label: 'Website URL',
                    type: 'url',
                    placeholder: 'https://www.venue.com'
                },
                {
                    id: 'venueAdmission',
                    name: 'admission_fee',
                    label: 'Admission Fee',
                    type: 'text',
                    placeholder: 'e.g., Free, $20, $15-25'
                },
                {
                    id: 'venueTourInfo',
                    name: 'tour_info',
                    label: 'Tour Information',
                    type: 'textarea',
                    rows: 2,
                    placeholder: 'Information about tours, guided visits, etc.'
                },
                {
                    id: 'venueInstagram',
                    name: 'instagram_url',
                    label: 'Instagram',
                    type: 'text',
                    placeholder: '@venuehandle'
                },
                {
                    id: 'venueFacebook',
                    name: 'facebook_url',
                    label: 'Facebook',
                    type: 'url',
                    placeholder: 'https://facebook.com/venue'
                },
                {
                    id: 'venueTwitter',
                    name: 'twitter_url',
                    label: 'Twitter',
                    type: 'text',
                    placeholder: '@venuehandle'
                },
                {
                    id: 'venueYoutube',
                    name: 'youtube_url',
                    label: 'YouTube',
                    type: 'url',
                    placeholder: 'https://youtube.com/c/venue'
                },
                {
                    id: 'venueTiktok',
                    name: 'tiktok_url',
                    label: 'TikTok',
                    type: 'text',
                    placeholder: '@venuehandle'
                },
                {
                    id: 'venueAdditionalInfo',
                    name: 'additional_info',
                    label: 'Additional Information',
                    type: 'textarea',
                    rows: 3,
                    placeholder: 'Additional details (JSON format)'
                }
            ];
            
            let formHTML = '';
            
            venueFields.forEach(field => {
                formHTML += '<div class="form-group">';
                formHTML += `<label for="${field.id}">${field.label}${field.required ? ' *' : ''}</label>`;
                
                if (field.special === 'smart_search') {
                    formHTML += '<div style="display: flex; gap: 10px;">';
                    formHTML += `<input type="${field.type}" id="${field.id}" name="${field.name}" ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}" style="flex: 1;">`;
                    formHTML += '<button type="button" id="smartSearchBtn" onclick="smartSearchVenue()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">🔍 Smart Search</button>';
                    formHTML += '</div>';
                } else if (field.type === 'select') {
                    formHTML += `<select id="${field.id}" name="${field.name}" ${field.required ? 'required' : ''}>`;
                    field.options.forEach(option => {
                        formHTML += `<option value="${option.value}">${option.text}</option>`;
                    });
                    formHTML += '</select>';
                } else if (field.type === 'textarea') {
                    formHTML += `<textarea id="${field.id}" name="${field.name}" rows="${field.rows || 3}" placeholder="${field.placeholder || ''}"></textarea>`;
                } else {
                    formHTML += `<input type="${field.type}" id="${field.id}" name="${field.name}" ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}" ${field.step ? `step="${field.step}"` : ''}>`;
                }
                
                formHTML += '</div>';
            });
            
            container.innerHTML = formHTML;
        }
        
        function populateVenueCityDropdown() {
            const citySelect = document.getElementById('venueCity');
            if (!citySelect) return;
            
            // If cities aren't loaded yet, try to load them first
            if (!window.allCities) {
                console.log('Cities not loaded yet, loading cities...');
                loadCities().then(() => {
                    populateVenueCityDropdown(); // Try again after loading
                }).catch(error => {
                    console.error('Failed to load cities:', error);
                    citySelect.innerHTML = '<option value="">Loading cities...</option>';
                });
                return;
            }
            
            citySelect.innerHTML = '<option value="">Select City</option>';
            window.allCities.forEach(city => {
                citySelect.innerHTML += `<option value="${city.id}">${city.name}, ${city.country}</option>`;
            });
            
            console.log(`Populated city dropdown with ${window.allCities.length} cities`);
        }
        
        async function smartSearchVenue() {
            const venueName = document.getElementById('venueName').value.trim();
            const cityId = document.getElementById('venueCity').value;
            
            if (!venueName) {
                alert('Please enter a venue name first');
                return;
            }
            
            if (!cityId) {
                alert('Please select a city first');
                return;
            }
            
            // Find city name from selected city ID
            const selectedCity = window.allCities.find(city => city.id == cityId);
            if (!selectedCity) {
                alert('Selected city not found');
                return;
            }
            
            const smartSearchBtn = document.getElementById('smartSearchBtn');
            const originalText = smartSearchBtn.textContent;
            smartSearchBtn.textContent = '🔍 Searching...';
            smartSearchBtn.disabled = true;
            
            try {
                console.log('Starting smart search for:', venueName, 'in', selectedCity.name);
                
                const response = await fetch('/api/admin/smart-search-venue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        venue_name: venueName,
                        city_name: selectedCity.name,
                        city_id: parseInt(cityId)
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    console.log('Smart search successful:', result);
                    
                    // Populate form with AI-discovered details
                    populateFormWithVenueDetails(result.venue_details);
                    
                    alert('Venue details found and populated! Review and adjust as needed.');
                    
                } else {
                    console.error('Smart search failed:', result);
                    alert('Smart search failed: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error during smart search:', error);
                alert('Error during smart search: ' + error.message);
            } finally {
                smartSearchBtn.textContent = originalText;
                smartSearchBtn.disabled = false;
            }
        }
        
        function populateFormWithVenueDetails(venueDetails) {
            // Populate all form fields dynamically based on venue details
            const fieldMappings = {
                'name': 'venueName',
                'venue_type': 'venueType',
                'address': 'venueAddress',
                'latitude': 'venueLatitude',
                'longitude': 'venueLongitude',
                'image_url': 'venueImageUrl',
                'description': 'venueDescription',
                'opening_hours': 'venueOpeningHours',
                'holiday_hours': 'venueHolidayHours',
                'phone_number': 'venuePhone',
                'email': 'venueEmail',
                'website_url': 'venueWebsite',
                'admission_fee': 'venueAdmission',
                'tour_info': 'venueTourInfo',
                'instagram_url': 'venueInstagram',
                'facebook_url': 'venueFacebook',
                'twitter_url': 'venueTwitter',
                'youtube_url': 'venueYoutube',
                'tiktok_url': 'venueTiktok',
                'additional_info': 'venueAdditionalInfo'
            };
            
            // Populate each field if the data exists
            Object.entries(fieldMappings).forEach(([dataKey, fieldId]) => {
                const element = document.getElementById(fieldId);
                if (element && venueDetails[dataKey]) {
                    if (element.tagName === 'TEXTAREA' && typeof venueDetails[dataKey] === 'object') {
                        // Handle JSON objects for additional_info
                        element.value = JSON.stringify(venueDetails[dataKey], null, 2);
                    } else {
                        element.value = venueDetails[dataKey];
                    }
                }
            });
        }
        
        async function manageJsonCopy() {
            const action = confirm('JSON Management\n\n' +
                'Click OK to create a fresh venues.json from predefined_venues.json\n' +
                'Click Cancel to apply venues.json changes back to original\n\n' +
                'This allows safe editing without affecting the original file.');
            
            try {
                let endpoint, message;
                
                if (action) {
                    // Create venues.json
                    endpoint = '/api/admin/create-json-copy';
                    message = 'Creating fresh venues.json...';
                } else {
                    // Apply venues.json to original
                    endpoint = '/api/admin/apply-json-copy';
                    message = 'Applying venues.json changes to original file...';
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || message);
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error managing JSON copy:', error);
                alert('Error managing JSON copy: ' + error.message);
            }
        }
        
        async function exportVenuesFromDatabase() {
            const confirmed = confirm('Export Venues from Database\n\n' +
                'This will download all venues from the database as a JSON file.\n' +
                'Useful for production environments or creating backups.\n\n' +
                'Continue?');
            
            if (!confirmed) return;
            
            try {
                console.log('Starting venues export...');
                
                const response = await fetch('/api/admin/export-venues', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    // Get the filename from the response headers
                    const contentDisposition = response.headers.get('Content-Disposition');
                    const filename = contentDisposition ? 
                        contentDisposition.split('filename=')[1].replace(/"/g, '') : 
                        'venues_exported.json';
                    
                    // Create blob and download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert('✅ Export successful! File downloaded.');
                } else {
                    const result = await response.json();
                    alert('❌ Export failed: ' + result.error);
                }
                
            } catch (error) {
                console.error('Export error:', error);
                alert('❌ Export error: ' + error.message);
            }
        }

        async function exportCitiesFromDatabase() {
            const confirmed = confirm('Export Cities from Database\n\n' +
                'This will download all cities from the database as a JSON file.\n' +
                'Matches the cities.json format for easy replacement.\n\n' +
                'Continue?');
            
            if (!confirmed) return;
            
            try {
                console.log('Starting cities export...');
                
                const response = await fetch('/api/admin/export-cities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    // Get the filename from the response headers
                    const contentDisposition = response.headers.get('Content-Disposition');
                    const filename = contentDisposition ? 
                        contentDisposition.split('filename=')[1].replace(/"/g, '') : 
                        'cities_exported.json';
                    
                    // Create blob and download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert('✅ Export successful! File downloaded.');
                } else {
                    const result = await response.json();
                    alert('❌ Export failed: ' + result.error);
                }
                
            } catch (error) {
                console.error('Export error:', error);
                alert('❌ Export error: ' + error.message);
            }
        }

        async function exportSourcesFromDatabase() {
            const confirmed = confirm('Export Sources from Database\n\n' +
                'This will download all sources from the database as a JSON file.\n' +
                'Matches the sources.json format for easy replacement.\n\n' +
                'Continue?');
            
            if (!confirmed) return;
            
            try {
                console.log('Starting sources export...');
                
                const response = await fetch('/api/admin/export-sources', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    // Get the filename from the response headers
                    const contentDisposition = response.headers.get('Content-Disposition');
                    const filename = contentDisposition ? 
                        contentDisposition.split('filename=')[1].replace(/"/g, '') : 
                        'sources_exported.json';
                    
                    // Create blob and download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert('✅ Export successful! File downloaded.');
                } else {
                    const result = await response.json();
                    alert('❌ Export failed: ' + result.error);
                }
                
            } catch (error) {
                console.error('Export error:', error);
                alert('❌ Export error: ' + error.message);
            }
        }
        
        function editVenue(id) {
            // Find the venue data
            const venue = window.allVenues.find(v => v.id == id);
            if (!venue) {
                alert('Venue not found');
                return;
            }
            
            // Create edit form data
            const editData = {
                id: venue.id,
                name: prompt('Edit venue name:', venue.name) || venue.name,
                venue_type: prompt('Edit venue type:', venue.venue_type || '') || venue.venue_type,
                address: prompt('Edit address:', venue.address || '') || venue.address,
                description: prompt('Edit description:', venue.description || '') || venue.description,
                opening_hours: prompt('Edit opening hours:', venue.opening_hours || '') || venue.opening_hours,
                phone_number: prompt('Edit phone:', venue.phone_number || '') || venue.phone_number,
                email: prompt('Edit email:', venue.email || '') || venue.email,
                website_url: prompt('Edit website:', venue.website_url || '') || venue.website_url,
                admission_fee: prompt('Edit admission fee:', venue.admission_fee || '') || venue.admission_fee
            };
            
            // Send update request
            fetch('/api/admin/edit-venue', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(editData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Venue updated successfully!');
                    loadVenues(); // Reload data
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(error => {
                alert('Error updating venue: ' + error.message);
            });
        }
        
        function deleteVenue(id) {
            if (confirm('Are you sure you want to delete this venue? This will also delete all associated events.')) {
                fetch(`/api/delete-venue/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Venue deleted successfully!');
                        loadVenues(); // Reload data
                    } else {
                        alert('Error: ' + result.error);
                    }
                })
                .catch(error => {
                    alert('Error deleting venue: ' + error.message);
                });
            }
        }
        
        // Load events data
        async function loadEvents() {
            try {
                console.log('Loading events...');
                const response = await fetch('/api/admin/events');
                const events = await response.json();
                
                if (events.error) throw new Error(events.error);
                
                console.log('Events loaded:', events.length);
                
                // Store events globally for filtering
                window.allEvents = events;
                window.filteredEvents = [...events];
                
                // Render the events table
                renderEventsTable();
                populateEventFilters();
                
            } catch (error) {
                console.error('Error loading events:', error);
                const eventsTable = document.getElementById('eventsTable');
                if (eventsTable) {
                    eventsTable.innerHTML = '<tr><td colspan="10" class="no-results">❌ Failed to load events: ' + error.message + '</td></tr>';
                }
            }
        }
        
        function renderEventsTable() {
            const data = window.filteredEvents || window.allEvents || [];
            renderDynamicTable('eventsTable', data, 'events');
        }
        
        function editEvent(id) {
            // Find the event data
            const event = window.allEvents.find(e => e.id == id);
            if (!event) {
                alert('Event not found');
                return;
            }
            
            // Create edit form data
            const editData = {
                id: event.id,
                title: prompt('Edit event title:', event.title) || event.title,
                description: prompt('Edit description:', event.description || '') || event.description,
                start_date: prompt('Edit start date (YYYY-MM-DD):', event.start_date) || event.start_date,
                start_time: prompt('Edit start time (HH:MM):', event.start_time || '') || event.start_time,
                end_time: prompt('Edit end time (HH:MM):', event.end_time || '') || event.end_time,
                event_type: prompt('Edit event type:', event.event_type || '') || event.event_type
            };
            
            // Send update request
            fetch('/api/admin/edit-event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(editData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Event updated successfully!');
                    loadEvents(); // Reload data
                } else {
                    alert('Error: ' + result.error);
                }
            })
            .catch(error => {
                alert('Error updating event: ' + error.message);
            });
        }
        
        function deleteEvent(id) {
            if (confirm('Are you sure you want to delete this event?')) {
                fetch(`/api/delete-event/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Event deleted successfully!');
                        loadEvents(); // Reload data
                    } else {
                        alert('Error: ' + result.error);
                    }
                })
                .catch(error => {
                    alert('Error deleting event: ' + error.message);
                });
            }
        }
        
        // Event filter functions
        function applyEventFilters() {
            if (!window.allEvents) return;
            
            const searchTerm = document.getElementById('eventSearch').value.toLowerCase();
            const typeFilter = document.getElementById('eventTypeFilter').value;
            const venueFilter = document.getElementById('eventVenueFilter').value;
            
            window.filteredEvents = window.allEvents.filter(event => {
                const matchesSearch = !searchTerm || 
                    event.title.toLowerCase().includes(searchTerm) ||
                    (event.event_type && event.event_type.toLowerCase().includes(searchTerm)) ||
                    (event.description && event.description.toLowerCase().includes(searchTerm));
                
                const matchesType = !typeFilter || event.event_type === typeFilter;
                const matchesVenue = !venueFilter || event.venue_name === venueFilter;
                
                return matchesSearch && matchesType && matchesVenue;
            });
            
            renderEventsTable();
        }
        
        function clearEventFilters() {
            document.getElementById('eventSearch').value = '';
            document.getElementById('eventTypeFilter').value = '';
            document.getElementById('eventVenueFilter').value = '';
            
            if (window.allEvents) {
                window.filteredEvents = [...window.allEvents];
                renderEventsTable();
            }
        }
        
        function openAddEventModal() {
            alert('Add Event functionality will be implemented here');
        }
        
        // Populate event filters
        function populateEventFilters() {
            const typeFilter = document.getElementById('eventTypeFilter');
            const venueFilter = document.getElementById('eventVenueFilter');
            
            if (!typeFilter || !venueFilter || !window.allEvents) return;
            
            const types = [...new Set(window.allEvents.map(event => event.event_type).filter(Boolean))].sort();
            const venues = [...new Set(window.allEvents.map(event => event.venue_name).filter(Boolean))].sort();
            
            typeFilter.innerHTML = '<option value="">All Types</option>';
            types.forEach(type => {
                typeFilter.innerHTML += '<option value="' + type + '">' + type + '</option>';
            });
            
            venueFilter.innerHTML = '<option value="">All Venues</option>';
            venues.forEach(venue => {
                venueFilter.innerHTML += '<option value="' + venue + '">' + venue + '</option>';
            });
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, calling loadOverview...');
            loadOverview();
            
            // Also load cities so they're available for venue dropdown
            console.log('Loading cities for venue dropdown...');
            loadCities();
            
            // Add form submission handlers
            const addCityForm = document.getElementById('addCityForm');
            if (addCityForm) {
                addCityForm.addEventListener('submit', handleAddCity);
            }
            
            const addVenueForm = document.getElementById('addVenueForm');
            if (addVenueForm) {
                addVenueForm.addEventListener('submit', handleAddVenue);
            }
            
            // Add edit form submission handlers
            const editCityForm = document.getElementById('editCityForm');
            if (editCityForm) {
                editCityForm.addEventListener('submit', handleEditCity);
            }
            
            const editVenueForm = document.getElementById('editVenueForm');
            if (editVenueForm) {
                editVenueForm.addEventListener('submit', handleEditVenue);
            }
            
            const editEventForm = document.getElementById('editEventForm');
            if (editEventForm) {
                editEventForm.addEventListener('submit', handleEditEvent);
            }
            
            // Add search input event listeners for real-time filtering
            const citySearch = document.getElementById('citySearch');
            if (citySearch) {
                citySearch.addEventListener('input', applyCityFilters);
            }
            
            const venueSearch = document.getElementById('venueSearch');
            if (venueSearch) {
                venueSearch.addEventListener('input', applyVenueFilters);
            }
            
            const eventSearch = document.getElementById('eventSearch');
            if (eventSearch) {
                eventSearch.addEventListener('input', applyEventFilters);
            }
            
            // Add filter dropdown event listeners for real-time filtering
            const cityCountryFilter = document.getElementById('cityCountryFilter');
            if (cityCountryFilter) {
                cityCountryFilter.addEventListener('change', applyCityFilters);
            }
            
            const venueTypeFilter = document.getElementById('venueTypeFilter');
            if (venueTypeFilter) {
                venueTypeFilter.addEventListener('change', applyVenueFilters);
            }
            
            const venueCityFilter = document.getElementById('venueCityFilter');
            if (venueCityFilter) {
                venueCityFilter.addEventListener('change', applyVenueFilters);
            }
            
            const venueFeeFilter = document.getElementById('venueFeeFilter');
            if (venueFeeFilter) {
                venueFeeFilter.addEventListener('change', applyVenueFilters);
            }
            
            const venueSortBy = document.getElementById('venueSortBy');
            if (venueSortBy) {
                venueSortBy.addEventListener('change', applyVenueFilters);
            }
            
            const eventTypeFilter = document.getElementById('eventTypeFilter');
            if (eventTypeFilter) {
                eventTypeFilter.addEventListener('change', applyEventFilters);
            }
            
            const eventVenueFilter = document.getElementById('eventVenueFilter');
            if (eventVenueFilter) {
                eventVenueFilter.addEventListener('change', applyEventFilters);
            }
            
            // Add source filter event listeners for real-time filtering
            const sourceSearch = document.getElementById('sourceSearch');
            if (sourceSearch) {
                sourceSearch.addEventListener('input', applySourceFilters);
            }
            
            const sourceTypeFilter = document.getElementById('sourceTypeFilter');
            if (sourceTypeFilter) {
                sourceTypeFilter.addEventListener('change', applySourceFilters);
            }
            
            const sourceCityFilter = document.getElementById('sourceCityFilter');
            if (sourceCityFilter) {
                sourceCityFilter.addEventListener('change', applySourceFilters);
            }
        });
        
        // Handle add city form submission
        async function handleAddCity(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('cityName').value.trim(),
                state: document.getElementById('cityState').value.trim(),
                country: document.getElementById('cityCountry').value.trim(),
                timezone: document.getElementById('cityTimezone').value.trim()
            };
            
            // Validate required fields
            if (!formData.name || !formData.country) {
                alert('City name and country are required');
                return;
            }
            
            try {
                console.log('Adding city:', formData);
                
                const response = await fetch('/api/admin/add-city', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('City added successfully:', result);
                    alert('City added successfully!');
                    
                    // Close modal
                    closeModal('addCityModal');
                    
                    // Reload cities data
                    await loadCities();
                    
                    // Refresh all city dropdowns in other sections
                    refreshAllCityDropdowns();
                    
                } else {
                    console.error('Error adding city:', result);
                    alert('Error adding city: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error adding city:', error);
                alert('Error adding city: ' + error.message);
            }
        }
        
        // Handle add venue form submission
        async function handleAddVenue(event) {
            event.preventDefault();
            
            // Collect all form data dynamically
            const formData = {};
            const form = document.getElementById('addVenueForm');
            const formElements = form.querySelectorAll('input, select, textarea');
            
            formElements.forEach(element => {
                if (element.name && element.id) {
                    let value = element.value.trim();
                    
                    // Handle number fields
                    if (element.type === 'number' && value) {
                        value = parseFloat(value);
                    }
                    
                    // Handle city_id specifically
                    if (element.name === 'city_id' && value) {
                        value = parseInt(value);
                    }
                    
                    // Only include non-empty values
                    if (value !== '' && value !== null && value !== undefined) {
                        formData[element.name] = value;
                    }
                }
            });
            
            // Validate required fields
            if (!formData.name || !formData.venue_type || !formData.city_id) {
                alert('Venue name, type, and city are required');
                return;
            }
            
            try {
                console.log('Adding venue:', formData);
                
                const response = await fetch('/api/admin/add-venue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('Venue added successfully:', result);
                    alert('Venue added successfully!');
                    
                    // Close modal
                    closeModal('addVenueModal');
                    
                    // Reload venues data
                    await loadVenues();
                    
                } else {
                    console.error('Error adding venue:', result);
                    alert('Error adding venue: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error adding venue:', error);
                alert('Error adding venue: ' + error.message);
            }
        }
        
        // Handle edit form submissions
        async function handleEditCity(event) {
            event.preventDefault();
            
            const editData = {
                id: parseInt(document.getElementById('editCityId').value),
                name: document.getElementById('editCityName').value.trim(),
                state: document.getElementById('editCityState').value.trim(),
                country: document.getElementById('editCityCountry').value.trim(),
                timezone: document.getElementById('editCityTimezone').value.trim()
            };
            
            try {
                const response = await fetch('/api/admin/edit-city', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(editData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('City updated successfully!');
                    closeModal('editCityModal');
                    loadCities();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating city: ' + error.message);
            }
        }
        
        async function handleEditVenue(event) {
            event.preventDefault();
            
            const editData = {
                id: parseInt(document.getElementById('editVenueId').value),
                name: document.getElementById('editVenueName').value.trim(),
                venue_type: document.getElementById('editVenueType').value.trim(),
                address: document.getElementById('editVenueAddress').value.trim(),
                description: document.getElementById('editVenueDescription').value.trim(),
                opening_hours: document.getElementById('editVenueHours').value.trim(),
                phone_number: document.getElementById('editVenuePhone').value.trim(),
                email: document.getElementById('editVenueEmail').value.trim(),
                website_url: document.getElementById('editVenueWebsite').value.trim(),
                admission_fee: document.getElementById('editVenueAdmission').value.trim()
            };
            
            try {
                const response = await fetch('/api/admin/edit-venue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(editData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Venue updated successfully!');
                    closeModal('editVenueModal');
                    loadVenues();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating venue: ' + error.message);
            }
        }
        
        async function handleEditEvent(event) {
            event.preventDefault();
            
            const editData = {
                id: parseInt(document.getElementById('editEventId').value),
                title: document.getElementById('editEventTitle').value.trim(),
                description: document.getElementById('editEventDescription').value.trim(),
                start_date: document.getElementById('editEventStartDate').value,
                start_time: document.getElementById('editEventStartTime').value,
                end_time: document.getElementById('editEventEndTime').value,
                event_type: document.getElementById('editEventType').value.trim()
            };
            
            try {
                const response = await fetch('/api/admin/edit-event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(editData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Event updated successfully!');
                    closeModal('editEventModal');
                    loadEvents();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating event: ' + error.message);
            }
        }
        
        // Source Management Functions
        let allSources = [];
        
        async function loadSources() {
            try {
                console.log('Loading sources...');
                const response = await fetch('/api/admin/sources');
                
                if (!response.ok) {
                    throw new Error('Failed to load sources');
                }
                
                allSources = await response.json();
                console.log('Sources loaded:', allSources.length);
                
                renderSourcesTable();
                populateSourceFilters();
                
            } catch (error) {
                console.error('Error loading sources:', error);
                const tableBody = document.getElementById('sourcesTable');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="12" class="loading">Error loading sources</td></tr>';
                }
            }
        }
        
        function renderSourcesTable() {
            const data = window.filteredSources || allSources || [];
            renderDynamicTable('sourcesTable', data, 'sources');
        }
        
        function editSource(id) {
            const source = allSources.find(s => s.id == id);
            if (!source) {
                alert('Source not found');
                return;
            }
            
            // Populate edit form
            document.getElementById('editSourceId').value = source.id;
            document.getElementById('editSourceName').value = source.name;
            document.getElementById('editSourceHandle').value = source.handle;
            document.getElementById('editSourceType').value = source.source_type;
            document.getElementById('editSourceCity').value = source.city_id;
            document.getElementById('editSourceUrl').value = source.url || '';
            document.getElementById('editSourceDescription').value = source.description || '';
            document.getElementById('editSourceReliability').value = source.reliability_score || 5;
            document.getElementById('editSourceFrequency').value = source.posting_frequency || '';
            document.getElementById('editSourceEventTypes').value = source.event_types ? JSON.parse(source.event_types).join(', ') : '';
            document.getElementById('editSourceNotes').value = source.notes || '';
            document.getElementById('editSourceScrapingPattern').value = source.scraping_pattern || '';
            document.getElementById('editSourceActive').checked = source.is_active;
            
            document.getElementById('editSourceModal').style.display = 'block';
        }
        
        function deleteSource(id) {
            if (confirm('Are you sure you want to delete this source?')) {
                fetch(`/api/delete-source/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Source deleted successfully!');
                        loadSources();
                    } else {
                        alert('Error: ' + result.error);
                    }
                })
                .catch(error => {
                    alert('Error deleting source: ' + error.message);
                });
            }
        }
        
        function applySourceFilters() {
            if (!allSources) return;
            
            const searchTerm = document.getElementById('sourceSearch').value.toLowerCase();
            const typeFilter = document.getElementById('sourceTypeFilter').value;
            const cityFilter = document.getElementById('sourceCityFilter').value;
            
            window.filteredSources = allSources.filter(source => {
                const matchesSearch = !searchTerm || 
                    source.name.toLowerCase().includes(searchTerm) ||
                    source.handle.toLowerCase().includes(searchTerm) ||
                    (source.description && source.description.toLowerCase().includes(searchTerm));
                
                const matchesType = !typeFilter || source.source_type === typeFilter;
                const matchesCity = !cityFilter || source.city_id == cityFilter;
                
                return matchesSearch && matchesType && matchesCity;
            });
            
            // Update filter summary
            const summary = document.getElementById('sourceFilterSummary');
            if (summary) {
                const activeFilters = [];
                if (searchTerm) activeFilters.push(`Search: "${searchTerm}"`);
                if (typeFilter) activeFilters.push(`Type: ${typeFilter}`);
                if (cityFilter) activeFilters.push(`City: ${document.getElementById('sourceCityFilter').selectedOptions[0]?.text || cityFilter}`);
                
                summary.textContent = activeFilters.length > 0 ? 
                    `Showing ${window.filteredSources.length} of ${allSources.length} sources (${activeFilters.join(', ')})` : 
                    `Showing all ${allSources.length} sources`;
            }
            
            renderSourcesTable();
        }
        
        function clearSourceFilters() {
            document.getElementById('sourceSearch').value = '';
            document.getElementById('sourceTypeFilter').value = '';
            document.getElementById('sourceCityFilter').value = '';
            
            // Reset filtered sources to show all
            window.filteredSources = null;
            renderSourcesTable();
            
            const summary = document.getElementById('sourceFilterSummary');
            if (summary) {
                summary.textContent = `Showing all ${allSources.length} sources`;
            }
        }
        
        function openAddSourceModal() {
            // Load cities for the dropdown
            loadCitiesForSourceModal();
            document.getElementById('addSourceModal').style.display = 'block';
            document.getElementById('addSourceForm').reset();
        }
        
        // Function to refresh all city dropdowns when a new city is added
        function refreshAllCityDropdowns() {
            // Refresh source modal dropdown
            loadCitiesForSourceModal();
            
            // Refresh source filter dropdown (will be populated when sources are reloaded)
            if (window.allSources) {
                populateSourceFilters();
            }
        }
        
        function loadCitiesForSourceModal() {
            fetch('/api/admin/cities')
                .then(response => response.json())
                .then(cities => {
                    const citySelects = ['sourceCity', 'editSourceCity'];
                    citySelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (select) {
                            // Clear existing options except the first one
                            while (select.children.length > 1) {
                                select.removeChild(select.lastChild);
                            }
                            
                            cities.forEach(city => {
                                const option = document.createElement('option');
                                option.value = city.id;
                                option.textContent = city.display_name || `${city.name}, ${city.country}`;
                                select.appendChild(option);
                            });
                        }
                    });
                })
                .catch(error => console.error('Error loading cities:', error));
        }
        
        function populateSourceFilters() {
            const cityFilter = document.getElementById('sourceCityFilter');
            
            if (cityFilter) {
                // Clear existing options except the first one
                while (cityFilter.children.length > 1) {
                    cityFilter.removeChild(cityFilter.lastChild);
                }
                
                // Get unique cities from sources
                const cityMap = new Map();
                allSources.forEach(source => {
                    if (source.city_id && source.city_name) {
                        cityMap.set(source.city_id, source.city_name);
                    }
                });
                
                // Sort cities by name for better UX
                const sortedCities = Array.from(cityMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
                
                sortedCities.forEach(([cityId, cityName]) => {
                    const option = document.createElement('option');
                    option.value = cityId;
                    option.textContent = cityName;
                    cityFilter.appendChild(option);
                });
            }
        }
        
        // Form handlers
        document.getElementById('addSourceForm').addEventListener('submit', handleAddSource);
        document.getElementById('editSourceForm').addEventListener('submit', handleEditSource);
        
        function detectSourceType(input) {
            // Detect if input is Instagram handle or website URL
            if (input.startsWith('@')) {
                return {
                    type: 'instagram',
                    handle: input,
                    url: `https://www.instagram.com/${input.substring(1)}/`,
                    name: input.substring(1).replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                };
            } else if (input.includes('instagram.com')) {
                // Extract handle from Instagram URL
                const match = input.match(/instagram\.com\/([^\/\?]+)/);
                if (match) {
                    const handle = `@${match[1]}`;
                    return {
                        type: 'instagram',
                        handle: handle,
                        url: input,
                        name: match[1].replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                    };
                }
            } else if (input.startsWith('http://') || input.startsWith('https://')) {
                // Website URL
                const domain = new URL(input).hostname;
                return {
                    type: 'website',
                    handle: domain,
                    url: input,
                    name: domain.replace('www.', '').split('.')[0].replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                };
            } else {
                // Assume it's a handle without @
                return {
                    type: 'instagram',
                    handle: `@${input}`,
                    url: `https://www.instagram.com/${input}/`,
                    name: input.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                };
            }
        }

        async function handleAddSource(event) {
            event.preventDefault();
            
            const sourceInput = document.getElementById('sourceInput').value.trim();
            const cityId = parseInt(document.getElementById('sourceCity').value);
            
            if (!sourceInput || !cityId) {
                alert('Please enter a source handle/URL and select a city');
                return;
            }
            
            // Detect source type and auto-fill fields
            const detected = detectSourceType(sourceInput);
            
            const formData = {
                name: detected.name,
                handle: detected.handle,
                source_type: detected.type,
                city_id: cityId,
                url: detected.url,
                description: document.getElementById('sourceDescription').value.trim() || '',
                reliability_score: parseFloat(document.getElementById('sourceReliability').value) || 7.0,
                posting_frequency: document.getElementById('sourceFrequency').value || 'weekly',
                event_types: JSON.stringify(document.getElementById('sourceEventTypes').value.split(',').map(t => t.trim()).filter(t => t)),
                notes: document.getElementById('sourceNotes').value.trim() || '',
                scraping_pattern: document.getElementById('sourceScrapingPattern').value.trim() || '',
                is_active: document.getElementById('sourceActive').checked
            };
            
            try {
                const response = await fetch('/api/admin/add-source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Source added successfully!');
                    closeModal('addSourceModal');
                    loadSources();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error adding source: ' + error.message);
            }
        }
        
        async function handleEditSource(event) {
            event.preventDefault();
            
            const editData = {
                id: parseInt(document.getElementById('editSourceId').value),
                name: document.getElementById('editSourceName').value.trim(),
                handle: document.getElementById('editSourceHandle').value.trim(),
                source_type: document.getElementById('editSourceType').value,
                city_id: parseInt(document.getElementById('editSourceCity').value),
                url: document.getElementById('editSourceUrl').value.trim(),
                description: document.getElementById('editSourceDescription').value.trim(),
                reliability_score: parseFloat(document.getElementById('editSourceReliability').value),
                posting_frequency: document.getElementById('editSourceFrequency').value,
                event_types: JSON.stringify(document.getElementById('editSourceEventTypes').value.split(',').map(t => t.trim()).filter(t => t)),
                notes: document.getElementById('editSourceNotes').value.trim(),
                scraping_pattern: document.getElementById('editSourceScrapingPattern').value.trim(),
                is_active: document.getElementById('editSourceActive').checked
            };
            
            try {
                const response = await fetch('/api/admin/edit-source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(editData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Source updated successfully!');
                    closeModal('editSourceModal');
                    loadSources();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating source: ' + error.message);
            }
        }
        
        console.log('Minimal script test - loaded');
    </script>
</body>
</html>
