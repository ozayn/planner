<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Admin Dashboard - Event Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <metahttp-equiv="Expires" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
            color: #495057;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: visible;
        }

        .header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            padding: 32px 40px;
            color: #111827;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 4px;
            font-weight: 600;
            letter-spacing: -0.03em;
            color: #111827;
            line-height: 1.2;
        }

        .header p {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 400;
            letter-spacing: 0.01em;
            margin: 0;
        }

        .back-home-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #6b7280;
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .back-home-link:hover {
            color: #374151;
            background: rgba(0, 0, 0, 0.04);
            border-color: rgba(0, 0, 0, 0.08);
        }

        .logout-link {
            color: #6b7280;
            text-decoration: none;
            font-size: 0.8125rem;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid transparent;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 4px;
        }

        .logout-link:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.08);
            border-color: rgba(239, 68, 68, 0.15);
        }

        .nav {
            background: transparent;
            padding: 0 24px 16px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            gap: 4px;
        }

        .nav button {
            background: transparent;
            color: #6b7280;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .nav button:hover {
            background: rgba(0, 0, 0, 0.04);
            color: #374151;
        }

        .nav button.active {
            background: transparent;
            color: #111827;
            font-weight: 600;
        }

        .nav button.active::after {
            content: '';
            position: absolute;
            bottom: -16px;
            left: 0;
            right: 0;
            height: 2px;
            background: #111827;
            border-radius: 1px;
        }

        .content {
            padding: 24px;
        }

        .data-section {
            display: none !important;
        }

        .data-section.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .data-section h2 {
            font-size: 1.5rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 20px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 10px;
            padding: 28px 24px;
            text-align: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(180deg, #3b82f6 0%, #8b5cf6 100%);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: rgba(59, 130, 246, 0.2);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
            letter-spacing: -0.04em;
            line-height: 1;
        }

        .stat-card p {
            color: #6b7280;
            font-size: 0.8125rem;
            font-weight: 500;
            letter-spacing: 0.01em;
            text-transform: uppercase;
            margin: 0;
        }

        /* Search and Filter Controls */
        .search-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            border: 1.5px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-input::placeholder {
            color: #9ca3af;
        }

        .filter-select {
            padding: 10px 14px;
            border: 1.5px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 150px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-select:hover {
            border-color: rgba(0, 0, 0, 0.15);
            background: white;
        }

        /* Modern Minimal Button Styles */
        .filter-button {
            background: transparent;
            color: #3b82f6;
            border: 1.5px solid #3b82f6;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .filter-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: #3b82f6;
            transition: left 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }

        .filter-button:hover {
            color: white;
            border-color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
        }

        .filter-button:hover::before {
            left: 0;
        }

        .filter-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
        }

        .clear-filters {
            background: transparent;
            color: #6b7280;
            border: 1.5px solid #e5e7eb;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .clear-filters:hover {
            color: #374151;
            border-color: #d1d5db;
            background: #f9fafb;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .clear-filters:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }

        .add-button {
            background: rgba(22, 163, 74, 0.08);
            color: #16a34a;
            border: 1.5px solid rgba(22, 163, 74, 0.2);
            padding: 8px 18px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .add-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
            z-index: 1;
        }

        .add-button:hover {
            background: #16a34a;
            color: white;
            border-color: #16a34a;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
        }

        .add-button:hover::before {
            left: 100%;
        }

        .add-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(22, 163, 74, 0.25);
        }

        .add-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Override for colored add-buttons */
        .add-button[style*="background: #8b5cf6"],
        .add-button[style*="background:#8b5cf6"] {
            background: rgba(139, 92, 246, 0.08) !important;
            color: #8b5cf6 !important;
            border-color: rgba(139, 92, 246, 0.2) !important;
        }

        .add-button[style*="background: #8b5cf6"]:hover,
        .add-button[style*="background:#8b5cf6"]:hover {
            background: #8b5cf6 !important;
            color: white !important;
            border-color: #8b5cf6 !important;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3) !important;
        }

        .add-button[style*="background: #f59e0b"],
        .add-button[style*="background:#f59e0b"] {
            background: rgba(245, 158, 11, 0.08) !important;
            color: #f59e0b !important;
            border-color: rgba(245, 158, 11, 0.2) !important;
        }

        .add-button[style*="background: #f59e0b"]:hover,
        .add-button[style*="background:#f59e0b"]:hover {
            background: #f59e0b !important;
            color: white !important;
            border-color: #f59e0b !important;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3) !important;
        }

        .add-button[style*="background: #10b981"],
        .add-button[style*="background:#10b981"] {
            background: rgba(16, 185, 129, 0.08) !important;
            color: #10b981 !important;
            border-color: rgba(16, 185, 129, 0.2) !important;
        }

        .add-button[style*="background: #10b981"]:hover,
        .add-button[style*="background:#10b981"]:hover {
            background: #10b981 !important;
            color: white !important;
            border-color: #10b981 !important;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;
        }

        .add-button[style*="background: #ff8c42"],
        .add-button[style*="background:#ff8c42"] {
            background: rgba(255, 140, 66, 0.08) !important;
            color: #ff8c42 !important;
            border-color: rgba(255, 140, 66, 0.2) !important;
        }

        .add-button[style*="background: #ff8c42"]:hover,
        .add-button[style*="background:#ff8c42"]:hover {
            background: #ff8c42 !important;
            color: white !important;
            border-color: #ff8c42 !important;
            box-shadow: 0 4px 12px rgba(255, 140, 66, 0.3) !important;
        }

        .add-button[style*="background: #dc3545"],
        .add-button[style*="background:#dc3545"] {
            background: rgba(220, 53, 69, 0.08) !important;
            color: #dc3545 !important;
            border-color: rgba(220, 53, 69, 0.2) !important;
        }

        .add-button[style*="background: #dc3545"]:hover,
        .add-button[style*="background:#dc3545"]:hover {
            background: #dc3545 !important;
            color: white !important;
            border-color: #dc3545 !important;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3) !important;
        }

        .add-button[style*="background: #3b82f6"],
        .add-button[style*="background:#3b82f6"] {
            background: rgba(59, 130, 246, 0.08) !important;
            color: #3b82f6 !important;
            border-color: rgba(59, 130, 246, 0.2) !important;
        }

        .add-button[style*="background: #3b82f6"]:hover,
        .add-button[style*="background:#3b82f6"]:hover {
            background: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
        }

        /* Scraping button color overrides */
        .add-button[style*="background: #e91e63"],
        .add-button[style*="background:#e91e63"],
        .add-button[style*="background: #17a2b8"],
        .add-button[style*="background:#17a2b8"],
        .add-button[style*="background: #6f42c1"],
        .add-button[style*="background:#6f42c1"],
        .add-button[style*="background: #20c997"],
        .add-button[style*="background:#20c997"],
        .add-button[style*="background: #fd7e14"],
        .add-button[style*="background:#fd7e14"] {
            background: rgba(0, 0, 0, 0.04) !important;
            color: inherit !important;
            border-color: rgba(0, 0, 0, 0.1) !important;
        }

        .add-button[style*="background: #e91e63"]:hover,
        .add-button[style*="background:#e91e63"]:hover {
            background: #e91e63 !important;
            color: white !important;
            border-color: #e91e63 !important;
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3) !important;
        }

        .add-button[style*="background: #17a2b8"]:hover,
        .add-button[style*="background:#17a2b8"]:hover {
            background: #17a2b8 !important;
            color: white !important;
            border-color: #17a2b8 !important;
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3) !important;
        }

        .add-button[style*="background: #6f42c1"]:hover,
        .add-button[style*="background:#6f42c1"]:hover {
            background: #6f42c1 !important;
            color: white !important;
            border-color: #6f42c1 !important;
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3) !important;
        }

        .add-button[style*="background: #20c997"]:hover,
        .add-button[style*="background:#20c997"]:hover {
            background: #20c997 !important;
            color: white !important;
            border-color: #20c997 !important;
            box-shadow: 0 4px 12px rgba(32, 201, 151, 0.3) !important;
        }

        .add-button[style*="background: #fd7e14"]:hover,
        .add-button[style*="background:#fd7e14"]:hover {
            background: #fd7e14 !important;
            color: white !important;
            border-color: #fd7e14 !important;
            box-shadow: 0 4px 12px rgba(253, 126, 20, 0.3) !important;
        }

        .filter-summary {
            background: rgba(59, 130, 246, 0.06);
            border: 1px solid rgba(59, 130, 246, 0.15);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.875rem;
            color: #1e40af;
            margin-bottom: 16px;
            display: none;
            backdrop-filter: blur(10px);
        }

        .filter-summary.active {
            display: block;
        }

        .filter-tag {
            background: rgba(59, 130, 246, 0.12);
            color: #1e40af;
            border: 1px solid rgba(59, 130, 246, 0.2);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 4px;
            display: inline-block;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            width: 100%;
            max-width: 100%;
            min-height: 200px;
            max-height: 80vh;
            display: block !important;
        }

        .scroll-hint {
            background: #f3f4f6;
            color: #6b7280;
            text-align: center;
            padding: 8px;
            font-size: 0.8rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            font-size: 0.9rem;
            display: table !important;
            table-layout: auto;
        }

        .data-table th {
            background: #f8f9fa;
            color: #374151;
            font-weight: 600;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
            white-space: nowrap;
            min-width: 100px;
        }
        
        .data-table td.description,
        .data-table td.additional_info {
            min-width: 0 !important;
        }

        .data-table td.description,
        .data-table td.additional_info {
            white-space: nowrap !important;
            max-width: 60px !important;
            width: 60px !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            font-size: 0.7rem;
            padding: 8px 4px !important;
        }
        
        .data-table th.description,
        .data-table th.additional_info {
            max-width: 60px !important;
            width: 60px !important;
            padding: 8px 4px !important;
            font-size: 0.75rem;
        }

        /* Social Media Links */
        .data-table a[href*="instagram.com"] {
            color: #E4405F !important;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .data-table a[href*="instagram.com"]:hover {
            color: #C13584 !important;
            text-decoration: underline;
        }

        .data-table a[href*="twitter.com"] {
            color: #1DA1F2 !important;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .data-table a[href*="twitter.com"]:hover {
            color: #0d8bd9 !important;
            text-decoration: underline;
        }

        .data-table a[href*="facebook.com"] {
            color: #1877F2 !important;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .data-table a[href*="facebook.com"]:hover {
            color: #166fe5 !important;
            text-decoration: underline;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .data-table tr[onclick] {
            cursor: pointer;
        }
        
        .data-table tr[onclick]:hover {
            background-color: rgba(255, 140, 66, 0.1) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .data-table tr.hidden {
            display: none;
        }

        .badge {
            background: #dbeafe;
            color: #1d4ed8;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge.zero {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge.high {
            background: #dcfce7;
            color: #16a34a;
        }

        /* Source type badges */
        .badge-instagram {
            background: #fdf2f8;
            color: #be185d;
        }

        .badge-website {
            background: #eff6ff;
            color: #1d4ed8;
        }

        .badge-eventbrite {
            background: #f0fdf4;
            color: #166534;
        }

        .badge-facebook {
            background: #eff6ff;
            color: #1e40af;
        }

        .badge-meetup {
            background: #fef3c7;
            color: #d97706;
        }

        .badge-twitter {
            background: #f0f9ff;
            color: #0ea5e9;
        }

        .badge-youtube {
            background: #fef2f2;
            color: #dc2626;
        }

        .badge-tiktok {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .badge-other {
            background: #f9fafb;
            color: #6b7280;
        }

        /* Event type badges */
        .badge-photowalk {
            background: #f0f9ff;
            color: #0369a1;
            border: 1px solid #bae6fd;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-exhibition {
            background: #fef7ff;
            color: #9333ea;
            border: 1px solid #e9d5ff;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-tour {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-festival {
            background: #fff7ed;
            color: #ea580c;
            border: 1px solid #fed7aa;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-workshop {
            background: #fefce8;
            color: #ca8a04;
            border: 1px solid #fde047;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-cultural {
            background: #fdf4ff;
            color: #c026d3;
            border: 1px solid #f3e8ff;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-film {
            background: #1f2937;
            color: #f9fafb;
            border: 1px solid #374151;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-art {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-language {
            background: #ecfdf5;
            color: #059669;
            border: 1px solid #a7f3d0;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        .badge-default {
            background: #f8fafc;
            color: #64748b;
            border: 1px solid #e2e8f0;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            display: inline-block;
            margin: 0.125rem;
        }

        /* Closure status styles */
        .closure-status {
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            line-height: 1.25;
        }

        .closure-status.closure-open {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .closure-status.closure-closed {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .closure-status.closure-unknown {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fed7aa;
        }

        .closure-status small {
            opacity: 0.8;
            font-size: 0.75rem;
        }

        /* Action Buttons */
        /* Modern Minimal Table Action Buttons */
        .edit-btn, .delete-btn {
            background: transparent;
            border: 1px solid transparent;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            margin: 0 2px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            min-height: 32px;
        }

        .edit-btn:hover {
            background: rgba(59, 130, 246, 0.08);
            border-color: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.15);
        }

        .delete-btn:hover {
            background: rgba(220, 53, 69, 0.08);
            border-color: rgba(220, 53, 69, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.15);
        }

        .edit-btn:active, .delete-btn:active {
            transform: translateY(0);
        }

        /* Minimal Button Variants */
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8125rem;
            border-radius: 6px;
            font-weight: 500;
            min-height: 32px;
            min-width: 32px;
        }

        .btn-danger {
            background: transparent;
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.2);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-danger:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.25);
        }

        .btn-secondary {
            background: transparent;
            color: #6b7280;
            border: 1px solid rgba(107, 114, 128, 0.2);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-secondary:hover {
            background: #6b7280;
            color: white;
            border-color: #6b7280;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.25);
        }

        /* Icon-only minimal buttons for table actions */
        .icon-btn {
            background: transparent;
            border: 1px solid transparent;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9375rem;
            margin: 0 2px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            min-height: 32px;
            line-height: 1;
        }

        .icon-btn:hover {
            transform: translateY(-1px);
        }

        .icon-btn:active {
            transform: translateY(0);
        }

        .edit-icon-btn {
            color: #3b82f6;
        }

        .edit-icon-btn:hover {
            background: rgba(59, 130, 246, 0.08);
            border-color: rgba(59, 130, 246, 0.2);
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.15);
        }

        .delete-icon-btn {
            color: #dc3545;
        }

        .delete-icon-btn:hover {
            background: rgba(220, 53, 69, 0.08);
            border-color: rgba(220, 53, 69, 0.2);
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.15);
        }

        .calendar-btn {
            color: #ff8c42;
        }

        .calendar-btn:hover {
            background: rgba(255, 140, 66, 0.08);
            border-color: rgba(255, 140, 66, 0.2);
            box-shadow: 0 2px 6px rgba(255, 140, 66, 0.15);
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* No Results Message */
        .no-results {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-style: italic;
        }

        .no-results-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            flex-shrink: 0;
        }

        .modal-header h3 {
            margin: 0;
            color: #374151;
            font-size: 1.25rem;
        }

        .close {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .close:hover {
            color: #000;
            background: rgba(0, 0, 0, 0.05);
        }

        .close:active {
            background: rgba(0, 0, 0, 0.1);
        }

        #eventDetailsContent,
        #venueDetailsContent,
        #cityDetailsContent,
        #sourceDetailsContent {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .btn-primary {
            background: rgba(59, 130, 246, 0.08);
            color: #3b82f6;
            border: 1.5px solid rgba(59, 130, 246, 0.2);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-primary:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25);
        }


        /* Extracted Data Display Styles */
        .extracted-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        
        .extracted-data-grid > div {
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }
        
        .extracted-data-grid strong {
            color: #374151;
            display: block;
            margin-bottom: 4px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 6px;
            }

            .container {
                border-radius: 8px;
            }

            .header {
                padding: 16px 12px;
            }

            .header > div {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 10px !important;
            }

            .header > div > div:first-child {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 8px !important;
                width: 100%;
            }

            .header > div > div:last-child {
                width: 100%;
                align-items: flex-start !important;
            }

            .header h1 {
                font-size: 1.25rem;
                margin-bottom: 2px;
            }

            .header p {
                font-size: 0.75rem;
            }

            .back-home-link,
            .logout-link {
                min-height: 40px;
                display: inline-flex;
                align-items: center;
                padding: 6px 10px;
                font-size: 0.8125rem;
            }

            .nav {
                flex-wrap: wrap;
                gap: 4px;
                padding: 0 12px 12px 12px;
            }

            .nav button {
                padding: 8px 12px;
                font-size: 0.8125rem;
                min-height: 40px;
            }

            .nav button.active::after {
                bottom: -12px;
            }

            .content {
                padding: 12px;
            }

            .data-section h2 {
                font-size: 1.25rem !important;
                margin-bottom: 12px !important;
            }

            /* Compact search and filter containers */
            .search-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .search-input,
            .filter-select {
                min-width: auto;
                padding: 10px;
                font-size: 0.9375rem;
                min-height: 40px;
            }

            /* Compact action button sections */
            [style*="padding: 16px"] {
                padding: 10px 12px !important;
            }

            [style*="margin-top: 12px"] {
                margin-top: 8px !important;
            }

            [style*="gap: 8px"] {
                gap: 6px !important;
            }

            h4[style*="margin: 0 0 12px"] {
                margin: 0 0 8px !important;
                font-size: 12px !important;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-bottom: 16px;
            }

            .stat-card {
                padding: 20px 16px;
            }

            .stat-card h3 {
                font-size: 1.75rem;
            }

            .stat-card p {
                font-size: 0.75rem;
            }

            .filter-summary {
                padding: 8px 12px;
                margin-bottom: 12px;
                font-size: 0.8125rem;
            }

            .data-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -12px;
                padding: 0 12px;
            }

            .data-table {
                min-width: 600px;
                font-size: 0.8125rem;
            }

            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }

            .action-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
                min-height: 32px;
                min-width: 32px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 0.875rem;
                min-height: 40px;
            }

            .add-button {
                padding: 8px 14px;
                font-size: 0.8125rem;
            }

            .filter-button,
            .clear-filters {
                padding: 8px 16px;
                font-size: 0.8125rem;
            }

            .modal-content {
                width: 95%;
                margin: 5px auto;
                max-height: 95vh;
                padding: 0;
                border-radius: 12px;
            }

            .modal-header {
                padding: 16px;
            }

            .modal-header h3 {
                font-size: 1.125rem;
            }

            .close {
                font-size: 28px;
                width: 36px;
                height: 36px;
            }

            #eventDetailsContent,
            #venueDetailsContent,
            #cityDetailsContent,
            #sourceDetailsContent {
                padding: 16px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .extracted-data-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .form-group {
                margin-bottom: 12px;
            }

            .form-group label {
                font-size: 0.8125rem;
                margin-bottom: 4px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 12px;
                font-size: 16px; /* Prevents zoom on iOS */
                min-height: 44px; /* Better touch target */
                width: 100%;
                box-sizing: border-box;
            }
            
            /* Image upload modal specific mobile improvements */
            #imageUploadModal .modal-content {
                max-height: 100vh;
                height: 100vh;
                margin: 0;
                border-radius: 0;
            }
            
            #imageUploadModal .modal-content > div:first-of-type {
                padding: 12px;
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            #imageUploadModal .form-group {
                margin-bottom: 16px;
            }
            
            #imageUploadModal input[type="file"] {
                font-size: 14px;
                padding: 8px;
            }
            
            #imageUploadModal .modal-actions {
                display: flex;
                flex-direction: column;
                gap: 10px;
                padding: 12px;
                background: white;
            }
            
            #imageUploadModal .modal-actions .btn {
                width: 100%;
                min-height: 44px;
                font-size: 16px;
            }

            .modal-footer {
                flex-direction: column;
                gap: 8px;
                margin-top: 16px;
            }

            .modal-footer .btn {
                width: 100%;
            }

            .scroll-hint {
                font-size: 0.75rem;
                padding: 6px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 4px;
            }

            .header {
                padding: 12px 10px;
            }

            .header h1 {
                font-size: 1.125rem;
            }
            
            /* Image upload modal - extra small screens */
            #imageUploadModal .modal-content {
                width: 100%;
                height: 100vh;
                margin: 0;
                border-radius: 0;
            }
            
            #imageUploadModal .modal-header {
                padding: 12px;
            }
            
            #imageUploadModal .modal-header h3 {
                font-size: 1rem;
            }
            
            #imageUploadModal .form-group {
                margin-bottom: 14px;
            }
            
            #imageUploadModal .form-group label {
                font-size: 0.875rem;
            }
            
            #imageUploadModal .form-group input,
            #imageUploadModal .form-group select,
            #imageUploadModal .form-group textarea {
                padding: 12px;
                font-size: 16px;
                min-height: 44px;
                -webkit-appearance: none;
                appearance: none;
            }
            
            #imageUploadModal select {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23374151' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 12px center;
                padding-right: 36px;
            }
            
            #imageUploadModal small {
                font-size: 0.75rem;
                display: block;
                margin-top: 4px;
                line-height: 1.4;
            }
            
            #imageUploadModal .extracted-data-grid {
                grid-template-columns: 1fr;
            }
            
            #imageUploadModal h4,
            #imageUploadModal h5 {
                font-size: 1rem;
                margin-bottom: 12px;
            }

            .header p {
                font-size: 0.6875rem;
            }

            .content {
                padding: 10px;
            }

            .nav {
                padding: 0 10px 10px 10px;
                gap: 2px;
            }

            .nav button {
                padding: 6px 10px;
                font-size: 0.75rem;
                min-height: 36px;
            }

            .nav button.active::after {
                bottom: -10px;
            }

            .data-section h2 {
                font-size: 1.125rem !important;
                margin-bottom: 10px !important;
            }

            .stats-grid {
                gap: 8px;
            }

            .stat-card {
                padding: 16px 12px;
            }

            .stat-card h3 {
                font-size: 1.5rem;
            }

            .stat-card p {
                font-size: 0.6875rem;
            }

            .search-controls {
                gap: 6px;
            }

            .search-input,
            .filter-select {
                padding: 8px;
                font-size: 0.875rem;
                min-height: 36px;
            }

            [style*="padding: 16px"] {
                padding: 8px 10px !important;
            }

            [style*="padding: 10px 12px"] {
                padding: 8px 10px !important;
            }

            .data-table {
                font-size: 0.75rem;
            }

            .data-table th,
            .data-table td {
                padding: 6px 4px;
            }

            .action-btn {
                padding: 4px 8px;
                font-size: 0.6875rem;
                min-height: 28px;
                min-width: 28px;
            }

            #eventDetailsContent {
                padding: 12px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .event-details-header {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
                margin-bottom: 16px !important;
            }

            .event-details-header > div:first-child > div:first-child {
                padding: 16px !important;
            }

            .event-details-header h2 {
                font-size: 1.25rem !important;
            }

            .event-details-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
                margin-bottom: 16px !important;
            }

            .event-details-grid h4 {
                font-size: 0.875rem !important;
                margin-bottom: 8px !important;
            }

            .event-details-grid > div > div {
                padding: 10px !important;
                margin-bottom: 10px !important;
            }

            .event-details-grid > div > div > div {
                margin-bottom: 6px !important;
                font-size: 0.8125rem !important;
                line-height: 1.4 !important;
            }

            .event-details-header img {
                max-width: 100% !important;
                height: auto !important;
            }

            .venue-details-header,
            .city-details-header {
                padding: 16px !important;
                margin-bottom: 16px !important;
            }

            .venue-details-header h2,
            .city-details-header h2 {
                font-size: 1.25rem !important;
            }

            .venue-details-grid,
            .city-details-grid,
            .source-details-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
                margin-bottom: 16px !important;
            }

            .venue-details-grid h4,
            .city-details-grid h4,
            .source-details-grid h4 {
                font-size: 0.875rem !important;
                margin-bottom: 8px !important;
            }

            .venue-details-grid > div > div,
            .city-details-grid > div > div,
            .source-details-grid > div > div {
                padding: 10px !important;
                margin-bottom: 10px !important;
            }

            .venue-details-grid > div > div > div,
            .city-details-grid > div > div > div,
            .source-details-grid > div > div > div {
                margin-bottom: 6px !important;
                font-size: 0.8125rem !important;
                line-height: 1.4 !important;
            }

            .btn {
                padding: 8px 14px;
                font-size: 0.8125rem;
                min-height: 36px;
            }

            .add-button {
                padding: 6px 12px;
                font-size: 0.75rem;
            }

            .filter-button,
            .clear-filters {
                padding: 6px 12px;
                font-size: 0.75rem;
            }

            .modal {
                background-color: rgba(0, 0, 0, 0.7);
            }

            .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
                height: 100vh;
                padding: 0;
            }

            .modal-header {
                padding: 12px 16px;
                border-radius: 0;
            }

            .modal-header h3 {
                font-size: 1rem;
            }

            .close {
                font-size: 32px;
                width: 44px;
                height: 44px;
                color: #666;
            }

            #eventDetailsContent {
                padding: 12px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .form-group {
                margin-bottom: 10px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 8px;
                font-size: 0.875rem;
                min-height: 36px;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Mobile touch devices */
            button,
            .btn,
            .action-btn,
            .nav button {
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            }

            button:active,
            .btn:active,
            .action-btn:active,
            .nav button:active {
                transform: scale(0.98);
            }

            /* Better scrolling on mobile */
            .data-table-container {
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 24px;">
                    <a href="/" class="back-home-link">
                        <span style="opacity: 0.6;"></span> Home
                    </a>
                    <div>
                        <h1>Admin Dashboard</h1>
                        <p>Manage cities, venues, sources, and events</p>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">
                    <div style="color: #374151; font-size: 0.875rem; font-weight: 500;">
                        {{ session.user_name or session.user_email or 'Local Development' }}
                    </div>
                    {% if request.host.startswith('localhost') or request.host.startswith('127.0.0.1') or request.host.startswith('10.') %}
                    <div style="color: #f59e0b; font-size: 0.75rem; font-weight: 500; letter-spacing: 0.02em;">
                        Local Development
                    </div>
                    {% elif session.user_email %}
                    <div style="color: #10b981; font-size: 0.75rem; font-weight: 500; letter-spacing: 0.02em;">
                        Authenticated
                    </div>
                    {% else %}
                    <div style="color: #ef4444; font-size: 0.75rem; font-weight: 500; letter-spacing: 0.02em;">
                        Authentication Required
                    </div>
                    {% endif %}
                    <a href="/auth/logout" class="logout-link">Logout</a>
                </div>
            </div>
        </div>

        <div class="nav">
            <button onclick="showSection('overview')" class="nav-btn active" id="nav-overview">Overview</button>
            <button onclick="showSection('cities')" class="nav-btn" id="nav-cities">Cities</button>
            <button onclick="showSection('venues')" class="nav-btn" id="nav-venues">Venues</button>
            <button onclick="showSection('sources')" class="nav-btn" id="nav-sources">Sources</button>
            <button onclick="showSection('events')" class="nav-btn" id="nav-events">Events</button>
        </div>

        <div class="content">
            <!-- Overview Section -->
            <div id="overview" class="data-section active">
                <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin-bottom: 20px; letter-spacing: -0.03em;">Overview</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="loading">Loading statistics...</div>
                </div>
            </div>

            <!-- Cities Section -->
            <div id="cities" class="data-section">
                <h2 style="font-size: 1.75rem; font-weight: 600; color: #111827; margin-bottom: 24px; letter-spacing: -0.02em;"> Cities Management</h2>
                
                <!-- Search and Filter Controls -->
                <div style="padding: 16px; background: rgba(255, 255, 255, 0.6); border-radius: 10px; border: 1px solid rgba(0, 0, 0, 0.08); margin-bottom: 16px;">
                    <div class="search-controls">
                        <input type="text" id="citySearch" class="search-input" placeholder=" Search cities...">
                        <select id="cityCountryFilter" class="filter-select">
                            <option value="">All Countries</option>
                        </select>
                        <select id="cityVenueFilter" class="filter-select">
                            <option value="">All Venue Counts</option>
                            <option value="0">None (0)</option>
                            <option value="1-4">Few (1-4)</option>
                            <option value="5+">Many (5+)</option>
                        </select>
                        <button onclick="applyCityFilters()" class="filter-button"> Filter</button>
                        <button onclick="clearCityFilters()" class="clear-filters"> Clear</button>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="openAddCityModal()" class="add-button"> Add City</button>
                        <button onclick="exportCitiesFromDatabase()" class="add-button" style="background: #8b5cf6;"> Export from DB</button>
                    </div>
                </div>

                <div id="cityFilterSummary" class="filter-summary"></div>
                
                <div class="table-container">
                    <div class="scroll-hint"> Scroll horizontally and vertically to see all data </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>State</th>
                                <th>Country</th>
                                <th>Timezone</th>
                                <th>Display Name</th>
                                <th>Venues</th>
                                <th>Events</th>
                                <th>Created</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="citiesTable">
                            <tr><td colspan="11" class="loading">Loading cities...</td></tr>
                        </tbody>
                    </table>
                        </div>
            </div>

            <!-- Venues Section -->
            <div id="venues" class="data-section">
                <h2 style="font-size: 1.75rem; font-weight: 600; color: #111827; margin-bottom: 24px; letter-spacing: -0.02em;"> Venues Management</h2>
                
                <!-- Search and Filter Controls -->
                <div style="padding: 16px; background: rgba(255, 255, 255, 0.6); border-radius: 10px; border: 1px solid rgba(0, 0, 0, 0.08); margin-bottom: 16px;">
                    <div class="search-controls">
                        <input type="text" id="venueSearch" class="search-input" placeholder=" Search venues...">
                        <select id="venueTypeFilter" class="filter-select">
                            <option value="">All Types</option>
                                </select>
                        <select id="venueCityFilter" class="filter-select">
                            <option value="">All Cities</option>
                                </select>
                        <select id="venueFeeFilter" class="filter-select">
                            <option value="">All Admission Fees</option>
                            <option value="free">Free Admission</option>
                            <option value="paid">Paid Admission</option>
                        </select>
                        <select id="venueClosureFilter" class="filter-select">
                            <option value="">All Closure Status</option>
                            <option value="open"> Open</option>
                            <option value="closed"> Closed</option>
                            <option value="unknown"> Unknown</option>
                        </select>
                        <select id="venueSortBy" class="filter-select">
                            <option value="">Sort by...</option>
                            <option value="name">Name (A-Z)</option>
                            <option value="name_desc">Name (Z-A)</option>
                            <option value="updated_at_desc">Recently Updated</option>
                            <option value="updated_at">Oldest Updated</option>
                            <option value="created_at_desc">Recently Added</option>
                            <option value="created_at">Oldest Added</option>
                            <option value="venue_type">Type (A-Z)</option>
                            <option value="city_name">City (A-Z)</option>
                        </select>
                        <button onclick="applyVenueFilters()" class="filter-button"> Filter</button>
                        <button onclick="clearVenueFilters()" class="clear-filters"> Clear</button>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="openAddVenueModal()" class="add-button"> Add Venue</button>
                        <button onclick="manageJsonCopy()" class="add-button" style="background: #10b981;"> Manage venues.json</button>
                        <button onclick="exportVenuesFromDatabase()" class="add-button" style="background: #8b5cf6;"> Export from DB</button>
                    </div>
                </div>

                <div id="venueFilterSummary" class="filter-summary"></div>
                
                <div class="table-container">
                    <div class="scroll-hint"> Scroll horizontally and vertically to see all data </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <!-- Headers will be dynamically generated -->
                            </tr>
                        </thead>
                        <tbody id="venuesTable">
                            <tr><td colspan="20" class="loading">Loading venues...</td></tr>
                        </tbody>
                    </table>
                        </div>
            </div>

            <!-- Events Section -->
            <div id="events" class="data-section">
                <h2 style="font-size: 1.75rem; font-weight: 600; color: #111827; margin-bottom: 24px; letter-spacing: -0.02em;"> Events Management</h2>
                
                <!-- Search and Filter Controls -->
                <div style="padding: 16px; background: rgba(255, 255, 255, 0.6); border-radius: 10px; border: 1px solid rgba(0, 0, 0, 0.08); margin-bottom: 16px;">
                    <div class="search-controls">
                        <input type="text" id="eventSearch" class="search-input" placeholder=" Search events...">
                        <select id="eventTypeFilter" class="filter-select">
                            <option value="">All Types</option>
                        </select>
                        <select id="eventCityFilter" class="filter-select">
                            <option value="">All Cities</option>
                        </select>
                        <select id="eventVenueFilter" class="filter-select">
                            <option value="">All Venues</option>
                        </select>
                        <button onclick="applyEventFilters()" class="filter-button"> Filter</button>
                        <button onclick="clearEventFilters()" class="clear-filters"> Clear</button>
                    </div>
                    
                    <!-- Action Buttons - Organized into sections -->
                <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 12px;">
                    <!-- Create Events Section -->
                    <div style="padding: 16px; background: rgba(255, 255, 255, 0.6); border-radius: 10px; border: 1px solid rgba(59, 130, 246, 0.1);">
                        <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 13px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase;"> Create Events</h4>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="openAddEventModal()" class="add-button"> Add Event</button>
                            <button onclick="openUrlScraperModal()" class="add-button" style="background: #8b5cf6;"> From URL</button>
                            <button onclick="openCreateFromVenueModal()" class="add-button" style="background: #f59e0b;"> From Venue</button>
                            <button onclick="openImageUploadModal()" class="add-button" style="background: #10b981;"> Upload Image</button>
                        </div>
                    </div>
                    
                    <!-- Bulk Actions Section -->
                    <div style="padding: 16px; background: rgba(255, 255, 255, 0.6); border-radius: 10px; border: 1px solid rgba(220, 53, 69, 0.1);">
                        <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 13px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase;"> Bulk Actions</h4>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="exportSelectedEventsToCalendar()" class="add-button" style="background: #ff8c42;" id="bulkExportBtn" disabled> Export Selected</button>
                            <button onclick="deleteSelectedEvents()" class="add-button" style="background: #dc3545;" id="bulkDeleteBtn" disabled> Delete Selected</button>
                        </div>
                    </div>
                    
                    <!-- Event Scraping Section -->
                    <div style="padding: 16px; background: rgba(255, 255, 255, 0.6); border-radius: 10px; border: 1px solid rgba(0, 123, 255, 0.1);">
                        <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 13px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase;"> Event Scraping</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px;">
                            <button onclick="startHirshhornScraping()" class="add-button" style="background: #e91e63;"> Hirshhorn</button>
                            <button onclick="startNGAScraping()" class="add-button" style="background: #17a2b8;"> NGA</button>
                            <button onclick="startSAAMScraping()" class="add-button" style="background: #8b5cf6;"> SAAM</button>
                            <button onclick="startNPGScraping()" class="add-button" style="background: #ffc1d9;"> NPG</button>
                            <button onclick="startAsianArtScraping()" class="add-button" style="background: #d4a5f7;"> Asian Art</button>
                            <!-- DISABLED: African Art Museum scraper not working - see FUTURE_FIXES.md -->
                            <button onclick="startAfricanArtScraping()" class="add-button" style="background: #ff9f43; opacity: 0.5; cursor: not-allowed;" disabled title="Temporarily disabled - see FUTURE_FIXES.md"> African Art (Disabled)</button>
                            <button onclick="startSmithsonianScraping()" class="add-button" style="background: #dc3545;"> Smithsonian</button>
                            <button onclick="startMuseumScraping()" class="add-button" style="background: #6f42c1;"> Museums</button>
                            <button onclick="startAllVenuesScraping()" class="add-button" style="background: #20c997;"> All Venues</button>
                            <button onclick="startWebstersScraping()" class="add-button" style="background: #6f42c1;"> Webster's</button>
                            <button onclick="discoverNewVenues()" class="add-button" style="background: #fd7e14;"> Discover Venues</button>
                        </div>
                        <div id="scrapingStatus" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></div>
                    </div>
                    
                    <!-- Quick URL Event Creator -->
                    <div style="margin-top: 0; padding: 16px; background: rgba(255, 255, 255, 0.6); border-radius: 10px; border: 1px solid rgba(59, 130, 246, 0.1);">
                        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                            <label style="font-weight: 600; color: #374151; white-space: nowrap; font-size: 13px; letter-spacing: 0.3px;"> Quick Add from URL:</label>
                            <input type="url" id="quickEventUrl" placeholder="Paste event URL (e.g., nga.gov/calendar/...)" 
                                   style="flex: 1; min-width: 300px; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px;"
                                   onkeypress="if(event.key === 'Enter') quickCreateEventFromUrl();">
                            <select id="quickUrlCitySelect" style="padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; min-width: 150px;">
                                <option value="">Select City...</option>
                            </select>
                            <button onclick="quickCreateEventFromUrl()" class="add-button" style="background: #3b82f6; white-space: nowrap;">
                                 Quick Create
                            </button>
                        </div>
                        <div id="quickUrlStatus" style="margin-top: 8px; font-size: 13px; color: #64748b;"></div>
                    </div>
                </div>

                <div id="eventFilterSummary" class="filter-summary"></div>
                
                <div class="table-container">
                    <div class="scroll-hint"> Scroll horizontally and vertically to see all data </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <!-- Headers will be dynamically generated -->
                            </tr>
                        </thead>
                        <tbody id="eventsTable">
                            <tr><td colspan="12" class="loading">Loading events...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sources Section -->
            <div id="sources" class="data-section">
                <h2 style="font-size: 1.75rem; font-weight: 600; color: #111827; margin-bottom: 24px; letter-spacing: -0.02em;"> Sources Management</h2>
                
                <!-- Search and Filter Controls -->
                <div style="padding: 16px; background: rgba(255, 255, 255, 0.6); border-radius: 10px; border: 1px solid rgba(0, 0, 0, 0.08); margin-bottom: 16px;">
                    <div class="search-controls">
                        <input type="text" id="sourceSearch" class="search-input" placeholder=" Search sources...">
                        <select id="sourceTypeFilter" class="filter-select">
                            <option value="">All Types</option>
                            <option value="instagram">Instagram</option>
                            <option value="website">Website</option>
                            <option value="eventbrite">Eventbrite</option>
                            <option value="facebook">Facebook</option>
                            <option value="meetup">Meetup</option>
                        </select>
                        <select id="sourceCityFilter" class="filter-select">
                            <option value="">All Cities</option>
                        </select>
                        <button onclick="applySourceFilters()" class="filter-button"> Filter</button>
                        <button onclick="clearSourceFilters()" class="clear-filters"> Clear</button>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="openAddSourceModal()" class="add-button"> Add Source</button>
                        <button onclick="exportSourcesFromDatabase()" class="add-button" style="background: #8b5cf6;"> Export from DB</button>
                    </div>
                </div>

                <div id="sourceFilterSummary" class="filter-summary"></div>
                
                <div class="table-container">
                    <div class="scroll-hint"> Scroll horizontally and vertically to see all data </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <!-- Headers will be dynamically generated -->
                            </tr>
                        </thead>
                        <tbody id="sourcesTable">
                            <tr><td colspan="8" class="loading">Loading sources...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

    <!-- Add City Modal -->
    <div id="addCityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New City</h3>
                <span class="close" onclick="closeModal('addCityModal')">&times;</span>
                        </div>
            <form id="addCityForm">
                <div class="form-group">
                    <label for="cityName">City Name *</label>
                    <input type="text" id="cityName" required>
                        </div>
                <div class="form-group">
                    <label for="cityState">State/Province</label>
                    <input type="text" id="cityState">
                        </div>
                <div class="form-group">
                    <label for="cityCountry">Country *</label>
                    <input type="text" id="cityCountry" required>
                        </div>
                <div class="form-group">
                    <label for="cityTimezone">Timezone</label>
                    <input type="text" id="cityTimezone" placeholder="e.g., America/New_York">
                        </div>
                <div class="form-group">
                    <label for="cityDisplayName">Display Name</label>
                    <input type="text" id="cityDisplayName">
                        </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCityModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add City</button>
                        </div>
            </form>
                        </div>
                        </div>
                        
    <!-- Add Venue Modal -->
    <div id="addVenueModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Add New Venue</h3>
                <span class="close" onclick="closeModal('addVenueModal')">&times;</span>
            </div>
            <form id="addVenueForm">
                <!-- Dynamic form fields will be generated here -->
                <div id="dynamicVenueFormFields"></div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addVenueModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Venue</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit City Modal -->
    <div id="editCityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit City</h3>
                <span class="close" onclick="closeModal('editCityModal')">&times;</span>
            </div>
            <form id="editCityForm">
                <input type="hidden" id="editCityId">
                <div class="form-group">
                    <label for="editCityName">City Name *</label>
                    <input type="text" id="editCityName" required>
                </div>
                <div class="form-group">
                    <label for="editCityState">State</label>
                    <input type="text" id="editCityState">
                </div>
                <div class="form-group">
                    <label for="editCityCountry">Country *</label>
                    <input type="text" id="editCityCountry" required>
                </div>
                <div class="form-group">
                    <label for="editCityTimezone">Timezone</label>
                    <input type="text" id="editCityTimezone">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editCityModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update City</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Venue Modal -->
    <div id="editVenueModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Edit Venue</h3>
                <span class="close" onclick="closeModal('editVenueModal')">&times;</span>
            </div>
            <form id="editVenueForm">
                <input type="hidden" id="editVenueId">
                <div class="form-group">
                    <label for="editVenueName">Venue Name *</label>
                    <input type="text" id="editVenueName" required>
                </div>
                <div class="form-group">
                    <label for="editVenueType">Venue Type *</label>
                    <select id="editVenueType" required>
                        <option value="">Select Type</option>
                        <option value="museum">Museum</option>
                        <option value="gallery">Gallery</option>
                        <option value="theater">Theater</option>
                        <option value="concert_hall">Concert Hall</option>
                        <option value="park">Park</option>
                        <option value="landmark">Landmark</option>
                        <option value="cultural_center">Cultural Center</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editVenueAddress">Address</label>
                    <input type="text" id="editVenueAddress">
                </div>
                <div class="form-group">
                    <label for="editVenueDescription">Description</label>
                    <textarea id="editVenueDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editVenueHours">Opening Hours</label>
                    <input type="text" id="editVenueHours">
                </div>
                <div class="form-group">
                    <label for="editVenuePhone">Phone Number</label>
                    <input type="text" id="editVenuePhone">
                </div>
                <div class="form-group">
                    <label for="editVenueEmail">Email</label>
                    <input type="email" id="editVenueEmail">
                </div>
                <div class="form-group">
                    <label for="editVenueWebsite">Website URL</label>
                    <input type="url" id="editVenueWebsite">
                </div>
                <div class="form-group">
                    <label for="editVenueAdmission">Admission Fee</label>
                    <input type="text" id="editVenueAdmission">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editVenueModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Venue</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="editEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Event</h3>
                <span class="close" onclick="closeModal('editEventModal')">&times;</span>
            </div>
            <form id="editEventForm">
                <input type="hidden" id="editEventId">
                <div class="form-group">
                    <label for="editEventTitle">Event Title *</label>
                    <input type="text" id="editEventTitle" required>
                </div>
                <div class="form-group">
                    <label for="editEventDescription">Description</label>
                    <textarea id="editEventDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editEventStartDate">Start Date *</label>
                    <input type="date" id="editEventStartDate" required>
                </div>
                <div class="form-group">
                    <label for="editEventStartTime">Start Time</label>
                    <input type="time" id="editEventStartTime">
                </div>
                <div class="form-group">
                    <label for="editEventEndTime">End Time</label>
                    <input type="time" id="editEventEndTime">
                </div>
                <div class="form-group">
                    <label for="editEventType">Event Type</label>
                    <input type="text" id="editEventType" onchange="toggleExhibitionFields()">
                </div>
                
                <!-- Exhibition-specific fields (shown when event_type is 'exhibition') -->
                <div id="editExhibitionFields" style="display: none;">
                    <h4 style="margin: 20px 0 10px 0; color: #4a5568;"> Exhibition Details</h4>
                    <div class="form-group">
                        <label for="editExhibitionLocation">Exhibition Location (Gallery/Room)</label>
                        <input type="text" id="editExhibitionLocation" placeholder="e.g., Gallery 61, West Building">
                    </div>
                    <div class="form-group">
                        <label for="editCurator">Curator</label>
                        <input type="text" id="editCurator" placeholder="e.g., John Smith">
                    </div>
                    <div class="form-group">
                        <label for="editAdmissionPrice">Admission Price</label>
                        <input type="number" id="editAdmissionPrice" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="editArtists">Artists (comma-separated)</label>
                        <input type="text" id="editArtists" placeholder="e.g., Kehinde Wiley, Amy Sherald">
                    </div>
                    <div class="form-group">
                        <label for="editExhibitionType">Exhibition Type</label>
                        <select id="editExhibitionType">
                            <option value="">Select Type</option>
                            <option value="solo">Solo</option>
                            <option value="group">Group</option>
                            <option value="retrospective">Retrospective</option>
                            <option value="permanent collection">Permanent Collection</option>
                            <option value="traveling">Traveling</option>
                            <option value="special">Special</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editCollectionPeriod">Collection Period</label>
                        <input type="text" id="editCollectionPeriod" placeholder="e.g., Modern Art, Contemporary, Renaissance">
                    </div>
                    <div class="form-group">
                        <label for="editNumberOfArtworks">Number of Artworks</label>
                        <input type="number" id="editNumberOfArtworks" min="0" placeholder="e.g., 50">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editOpeningReceptionDate">Opening Reception Date</label>
                            <input type="date" id="editOpeningReceptionDate">
                        </div>
                        <div class="form-group">
                            <label for="editOpeningReceptionTime">Opening Reception Time</label>
                            <input type="time" id="editOpeningReceptionTime">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editIsPermanent"> Permanent Collection
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="editRelatedExhibitions">Related Exhibitions (comma-separated titles or IDs)</label>
                        <input type="text" id="editRelatedExhibitions" placeholder="e.g., Black American Portraits, Family Album">
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editEventModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Source Modal -->
    <div id="addSourceModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Add New Source</h3>
                <span class="close" onclick="closeModal('addSourceModal')">&times;</span>
            </div>
            <form id="addSourceForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="sourceInput">Instagram Handle or Website URL *</label>
                        <input type="text" id="sourceInput" required placeholder="e.g., @princetonphotoclub or https://example.com">
                        <small style="color: #666; font-size: 0.8em; display: block; margin-top: 5px;">Just paste the Instagram handle (@username) or website URL - we'll detect the type and fill in the rest!</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="sourceCity">City *</label>
                        <select id="sourceCity" required>
                            <option value="">Select City</option>
                        </select>
                    </div>
                </div>
                
                <!-- Hidden fields that will be auto-filled -->
                <input type="hidden" id="sourceName" value="">
                <input type="hidden" id="sourceHandle" value="">
                <input type="hidden" id="sourceType" value="">
                <input type="hidden" id="sourceUrl" value="">
                
                
                <div class="form-group">
                    <label for="sourceDescription">Description</label>
                    <textarea id="sourceDescription" rows="3" placeholder="Brief description of what this source posts..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="sourceReliability">Reliability Score (1-10)</label>
                        <input type="number" id="sourceReliability" min="1" max="10" step="0.1" value="5" placeholder="5.0">
                    </div>
                    <div class="form-group">
                        <label for="sourceFrequency">Posting Frequency</label>
                        <select id="sourceFrequency">
                            <option value="">Select Frequency</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="irregular">Irregular</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="sourceEventTypes">Event Types (comma-separated)</label>
                    <input type="text" id="sourceEventTypes" placeholder="photowalk, tour, exhibition, festival">
                </div>
                
                <div class="form-group">
                    <label for="sourceNotes">Notes</label>
                    <textarea id="sourceNotes" rows="2" placeholder="Special instructions, patterns, or additional info..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="sourceScrapingPattern">Scraping Pattern</label>
                    <textarea id="sourceScrapingPattern" rows="2" placeholder="How to check this source for events..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="sourceActive" checked> Active Source
                    </label>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addSourceModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Source</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Source Modal -->
    <div id="editSourceModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Edit Source</h3>
                <span class="close" onclick="closeModal('editSourceModal')">&times;</span>
            </div>
            <form id="editSourceForm">
                <input type="hidden" id="editSourceId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editSourceName">Source Name *</label>
                        <input type="text" id="editSourceName" required>
                    </div>
                    <div class="form-group">
                        <label for="editSourceHandle">Handle *</label>
                        <input type="text" id="editSourceHandle" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editSourceType">Source Type *</label>
                        <select id="editSourceType" required>
                            <option value="">Select Type</option>
                            <option value="instagram">Instagram</option>
                            <option value="website">Website</option>
                            <option value="eventbrite">Eventbrite</option>
                            <option value="facebook">Facebook</option>
                            <option value="meetup">Meetup</option>
                            <option value="twitter">Twitter</option>
                            <option value="youtube">YouTube</option>
                            <option value="tiktok">TikTok</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editSourceCity">City *</label>
                        <select id="editSourceCity" required>
                            <option value="">Select City</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editSourceUrl">URL</label>
                    <input type="url" id="editSourceUrl">
                </div>
                
                <div class="form-group">
                    <label for="editSourceDescription">Description</label>
                    <textarea id="editSourceDescription" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editSourceReliability">Reliability Score (1-10)</label>
                        <input type="number" id="editSourceReliability" min="1" max="10" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editSourceFrequency">Posting Frequency</label>
                        <select id="editSourceFrequency">
                            <option value="">Select Frequency</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="irregular">Irregular</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editSourceEventTypes">Event Types (comma-separated)</label>
                    <input type="text" id="editSourceEventTypes">
                </div>
                
                <div class="form-group">
                    <label for="editSourceNotes">Notes</label>
                    <textarea id="editSourceNotes" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editSourceScrapingPattern">Scraping Pattern</label>
                    <textarea id="editSourceScrapingPattern" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editSourceActive"> Active Source
                    </label>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editSourceModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Source</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Details Modal -->
    <div id="eventDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Event Details</h3>
                <span class="close" onclick="closeModal('eventDetailsModal')">&times;</span>
            </div>
            <div id="eventDetailsContent">
                <!-- Event details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Venue Details Modal -->
    <div id="venueDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Venue Details</h3>
                <span class="close" onclick="closeModal('venueDetailsModal')">&times;</span>
            </div>
            <div id="venueDetailsContent">
                <!-- Venue details will be populated here -->
            </div>
        </div>
    </div>

    <!-- City Details Modal -->
    <div id="cityDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> City Details</h3>
                <span class="close" onclick="closeModal('cityDetailsModal')">&times;</span>
            </div>
            <div id="cityDetailsContent">
                <!-- City details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Source Details Modal -->
    <div id="sourceDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Source Details</h3>
                <span class="close" onclick="closeModal('sourceDetailsModal')">&times;</span>
            </div>
            <div id="sourceDetailsContent">
                <!-- Source details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div id="imageUploadModal" class="modal">
        <div class="modal-content" style="overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3> Upload Event Image</h3>
                <span class="close" onclick="closeModal('imageUploadModal')">&times;</span>
            </div>
            <div style="overflow-y: auto; overflow-x: hidden; flex: 1; padding: 20px; -webkit-overflow-scrolling: touch; scroll-behavior: smooth;">
            <form id="imageUploadForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="eventImage">Select Image:</label>
                    <input type="file" id="eventImage" name="image" accept="image/*" required onchange="console.log('File selected:', this.files[0]?.name)">
                    <small>Supported formats: PNG, JPG, JPEG, GIF, BMP, TIFF</small>
                </div>
                
                <div class="form-group">
                    <label for="ocrEngine">OCR Engine:</label>
                    <select id="ocrEngine" name="ocr_engine">
                        <option value="auto"> Auto (Environment Default)</option>
                        <option value="tesseract"> Tesseract (Free, Local)</option>
                        <option value="google_vision"> Google Vision (Premium, Cloud)</option>
                    </select>
                    <small>Choose OCR engine for text extraction. Auto uses environment defaults.</small>
                </div>
                
                <div class="modal-actions" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('imageUploadModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary"> Process Image</button>
                </div>
            </form>
            </div>
            
            <!-- Extracted Data Display -->
            <div id="extractedDataDisplay" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; max-width: 100%; overflow-x: auto;">
                <h4> Extracted Event Data</h4>
                <div id="extractedDataContent"></div>
                
                <!-- Manual Input Fields -->
                <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb; max-width: 100%; box-sizing: border-box;">
                    <h5> Manual Input (Edit or Add Missing Information)</h5>
                    
                    <div class="form-group">
                        <label for="manualEventTitle">Event Title *:</label>
                        <input type="text" id="manualEventTitle" placeholder="Enter event title" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="manualEventDescription">Description:</label>
                        <textarea id="manualEventDescription" rows="3" placeholder="Enter event description"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="manualStartDate">Start Date *:</label>
                            <input type="date" id="manualStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="manualEndDate">End Date:</label>
                            <input type="date" id="manualEndDate">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="manualStartTime">Start Time:</label>
                            <input type="time" id="manualStartTime">
                        </div>
                        <div class="form-group">
                            <label for="manualEndTime">End Time:</label>
                            <input type="time" id="manualEndTime">
                        </div>
                    </div>
                    
                       <div class="form-group">
                           <label for="manualEventType">Event Type:</label>
                           <select id="manualEventType">
                               <option value="tour">Tour</option>
                               <option value="exhibition">Exhibition</option>
                               <option value="festival">Festival</option>
                               <option value="photowalk">Photowalk</option>
                               <option value="workshop">Workshop</option>
                               <option value="seminar">Seminar</option>
                               <option value="conference">Conference</option>
                               <option value="meeting">Meeting</option>
                               <option value="talk">Talk</option>
                               <option value="lecture">Lecture</option>
                               <option value="presentation">Presentation</option>
                               <option value="performance">Performance</option>
                               <option value="concert">Concert</option>
                               <option value="show">Show</option>
                               <option value="party">Party</option>
                               <option value="reception">Reception</option>
                               <option value="networking">Networking</option>
                               <option value="social">Social Event</option>
                               <option value="fundraiser">Fundraiser</option>
                               <option value="charity">Charity Event</option>
                               <option value="sports">Sports Event</option>
                               <option value="competition">Competition</option>
                               <option value="contest">Contest</option>
                               <option value="awards">Awards Ceremony</option>
                               <option value="gala">Gala</option>
                               <option value="dinner">Dinner</option>
                               <option value="lunch">Lunch</option>
                               <option value="brunch">Brunch</option>
                               <option value="tasting">Tasting</option>
                               <option value="market">Market</option>
                               <option value="fair">Fair</option>
                               <option value="carnival">Carnival</option>
                               <option value="parade">Parade</option>
                               <option value="march">March</option>
                               <option value="protest">Protest</option>
                               <option value="rally">Rally</option>
                               <option value="demonstration">Demonstration</option>
                               <option value="ceremony">Ceremony</option>
                               <option value="celebration">Celebration</option>
                               <option value="anniversary">Anniversary</option>
                               <option value="birthday">Birthday</option>
                               <option value="wedding">Wedding</option>
                               <option value="graduation">Graduation</option>
                               <option value="launch">Launch Event</option>
                               <option value="opening">Opening</option>
                               <option value="closing">Closing</option>
                               <option value="preview">Preview</option>
                               <option value="screening">Screening</option>
                               <option value="premiere">Premiere</option>
                               <option value="book_signing">Book Signing</option>
                               <option value="signing">Signing</option>
                               <option value="autograph">Autograph Session</option>
                               <option value="meet_greet">Meet & Greet</option>
                               <option value="q_a">Q&A Session</option>
                               <option value="panel">Panel Discussion</option>
                               <option value="debate">Debate</option>
                               <option value="forum">Forum</option>
                               <option value="summit">Summit</option>
                               <option value="retreat">Retreat</option>
                               <option value="training">Training</option>
                               <option value="class">Class</option>
                               <option value="course">Course</option>
                               <option value="lesson">Lesson</option>
                               <option value="tutorial">Tutorial</option>
                               <option value="demo">Demo</option>
                               <option value="trial">Trial</option>
                               <option value="test">Test</option>
                               <option value="exam">Exam</option>
                               <option value="audition">Audition</option>
                               <option value="interview">Interview</option>
                               <option value="appointment">Appointment</option>
                               <option value="consultation">Consultation</option>
                               <option value="session">Session</option>
                               <option value="therapy">Therapy</option>
                               <option value="treatment">Treatment</option>
                               <option value="checkup">Checkup</option>
                               <option value="inspection">Inspection</option>
                               <option value="tournament">Tournament</option>
                               <option value="championship">Championship</option>
                               <option value="playoff">Playoff</option>
                               <option value="game">Game</option>
                               <option value="match">Match</option>
                               <option value="race">Race</option>
                               <option value="marathon">Marathon</option>
                               <option value="walk">Walk</option>
                               <option value="run">Run</option>
                               <option value="ride">Ride</option>
                               <option value="hike">Hike</option>
                               <option value="climb">Climb</option>
                               <option value="swim">Swim</option>
                               <option value="dive">Dive</option>
                               <option value="sail">Sail</option>
                               <option value="cruise">Cruise</option>
                               <option value="trip">Trip</option>
                               <option value="excursion">Excursion</option>
                               <option value="adventure">Adventure</option>
                               <option value="expedition">Expedition</option>
                               <option value="journey">Journey</option>
                               <option value="pilgrimage">Pilgrimage</option>
                               <option value="retreat">Retreat</option>
                               <option value="camp">Camp</option>
                               <option value="camping">Camping</option>
                               <option value="picnic">Picnic</option>
                               <option value="barbecue">Barbecue</option>
                               <option value="cookout">Cookout</option>
                               <option value="potluck">Potluck</option>
                               <option value="banquet">Banquet</option>
                               <option value="feast">Feast</option>
                               <option value="buffet">Buffet</option>
                               <option value="catered">Catered Event</option>
                               <option value="catering">Catering</option>
                               <option value="delivery">Delivery</option>
                               <option value="pickup">Pickup</option>
                               <option value="dropoff">Drop-off</option>
                               <option value="collection">Collection</option>
                               <option value="distribution">Distribution</option>
                               <option value="donation">Donation</option>
                               <option value="volunteer">Volunteer</option>
                               <option value="service">Service</option>
                               <option value="maintenance">Maintenance</option>
                               <option value="repair">Repair</option>
                               <option value="installation">Installation</option>
                               <option value="setup">Setup</option>
                               <option value="breakdown">Breakdown</option>
                               <option value="cleanup">Cleanup</option>
                               <option value="maintenance">Maintenance</option>
                               <option value="inspection">Inspection</option>
                               <option value="audit">Audit</option>
                               <option value="review">Review</option>
                               <option value="evaluation">Evaluation</option>
                               <option value="assessment">Assessment</option>
                               <option value="analysis">Analysis</option>
                               <option value="research">Research</option>
                               <option value="study">Study</option>
                               <option value="survey">Survey</option>
                               <option value="poll">Poll</option>
                               <option value="vote">Vote</option>
                               <option value="election">Election</option>
                               <option value="referendum">Referendum</option>
                               <option value="petition">Petition</option>
                               <option value="campaign">Campaign</option>
                               <option value="other">Other</option>
                           </select>
                       </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="manualStartLocation">Start Location:</label>
                            <input type="text" id="manualStartLocation" placeholder="Enter start location">
                        </div>
                        <div class="form-group">
                            <label for="manualEndLocation">End Location:</label>
                            <input type="text" id="manualEndLocation" placeholder="Enter end location (optional)">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="manualPrice">Price:</label>
                        <input type="number" id="manualPrice" step="0.01" placeholder="0.00">
                    </div>
                    
                       <div class="form-group">
                           <label for="manualUrl">Event URL:</label>
                           <input type="url" id="manualUrl" placeholder="https://...">
                       </div>
                       
                       <div class="form-group">
                           <label for="manualCityId">City:</label>
                           <select id="manualCityId">
                               <option value="">Select City</option>
                           </select>
                       </div>
                       
                       <div class="form-group">
                           <label for="manualVenueId">Venue:</label>
                           <select id="manualVenueId">
                               <option value="">Select Venue (optional)</option>
                           </select>
                           <small>Venue will be auto-selected for NGA events</small>
                       </div>
                       
                       <div class="form-group">
                           <label for="manualEventSource">Event Source:</label>
                           <select id="manualEventSource">
                               <option value="">Select Source</option>
                               <option value="instagram">Instagram</option>
                               <option value="facebook">Facebook</option>
                               <option value="twitter">Twitter</option>
                               <option value="website">Website</option>
                               <option value="email">Email</option>
                               <option value="flyer">Flyer/Poster</option>
                               <option value="word_of_mouth">Word of Mouth</option>
                               <option value="venue_website">Venue Website</option>
                               <option value="eventbrite">Eventbrite</option>
                               <option value="meetup">Meetup</option>
                               <option value="ticketmaster">Ticketmaster</option>
                               <option value="stubhub">StubHub</option>
                               <option value="newspaper">Newspaper</option>
                               <option value="magazine">Magazine</option>
                               <option value="radio">Radio</option>
                               <option value="tv">TV</option>
                               <option value="billboard">Billboard</option>
                               <option value="direct_mail">Direct Mail</option>
                               <option value="newsletter">Newsletter</option>
                               <option value="blog">Blog</option>
                               <option value="podcast">Podcast</option>
                               <option value="youtube">YouTube</option>
                               <option value="tiktok">TikTok</option>
                               <option value="linkedin">LinkedIn</option>
                               <option value="reddit">Reddit</option>
                               <option value="discord">Discord</option>
                               <option value="telegram">Telegram</option>
                               <option value="whatsapp">WhatsApp</option>
                               <option value="phone_call">Phone Call</option>
                               <option value="text_message">Text Message</option>
                               <option value="in_person">In Person</option>
                               <option value="other">Other</option>
                           </select>
                       </div>
                       
                    <div class="form-group">
                        <label for="manualSourceUrl">Source URL:</label>
                        <input type="url" id="manualSourceUrl" placeholder="https://instagram.com/...">
                    </div>
                    
                    <!-- Social Media Fields -->
                    <div class="form-group">
                        <label for="manualSocialMediaPlatform">Social Media Platform:</label>
                        <select id="manualSocialMediaPlatform">
                            <option value="">Select Platform</option>
                            <option value="instagram">Instagram</option>
                            <option value="meetup">Meetup</option>
                            <option value="eventbrite">Eventbrite</option>
                            <option value="facebook">Facebook</option>
                            <option value="twitter">Twitter</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="manualSocialMediaHandle">Social Media Handle:</label>
                        <input type="text" id="manualSocialMediaHandle" placeholder="username (without @)">
                    </div>
                    
                    <div class="form-group">
                        <label for="manualSocialMediaPageName">Page/Group Name:</label>
                        <input type="text" id="manualSocialMediaPageName" placeholder="DC Street Meet">
                    </div>
                    
                    <div class="form-group">
                        <label for="manualSocialMediaPostedBy">Posted By:</label>
                        <input type="text" id="manualSocialMediaPostedBy" placeholder="Who posted this content">
                    </div>
                    
                    <div class="form-group">
                        <label for="manualSocialMediaUrl">Social Media URL:</label>
                        <input type="url" id="manualSocialMediaUrl" placeholder="https://instagram.com/p/...">
                    </div>
                </div>
                
                <div class="modal-actions" style="position: sticky; bottom: 0; background: white; padding-top: 15px; margin-top: 15px; border-top: 1px solid #e5e7eb;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('imageUploadModal')">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="createEventFromExtractedData()"> Create Event</button>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- URL Scraper Modal -->
    <div id="urlScraperModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Create Events from URL</h3>
                <span class="close" onclick="closeModal('urlScraperModal')">&times;</span>
            </div>
            <form id="urlScraperForm">
                <div class="form-group">
                    <label for="eventUrl">Event Page URL *:</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="url" id="eventUrl" placeholder="https://example.com/events/tour" required style="flex: 1;">
                        <button type="button" id="autoFillBtn" class="btn btn-secondary" style="white-space: nowrap;"> Auto-Fill</button>
                    </div>
                    <small>Enter URL and click Auto-Fill to extract event details, then review and edit</small>
                </div>
                
                <div class="form-group">
                    <label for="urlVenueSelect">Venue (Optional):</label>
                    <select id="urlVenueSelect">
                        <option value="">No specific venue (city-wide event)</option>
                    </select>
                    <small>Select a venue if this event is venue-specific</small>
                </div>
                
                <div class="form-group">
                    <label for="urlCitySelect">City *:</label>
                    <select id="urlCitySelect" required>
                        <option value="">Choose a city...</option>
                    </select>
                    <small>Select the city where this event takes place</small>
                </div>
                
                <div class="form-group">
                    <label for="timePeriod">Time Period for Recurring Events:</label>
                    <select id="timePeriod">
                        <option value="today"> Today Only</option>
                        <option value="tomorrow"> Tomorrow Only</option>
                        <option value="this_week" selected> This Week</option>
                        <option value="this_month"> This Month</option>
                        <option value="custom"> Custom Period</option>
                    </select>
                    <small>If event has recurring schedule (e.g., "Fridays", "Weekdays"), create multiple events for this period</small>
                </div>
                
                <div id="customPeriodFields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customStartDate">Period Start Date:</label>
                            <input type="date" id="customStartDate">
                        </div>
                        <div class="form-group">
                            <label for="customEndDate">Period End Date:</label>
                            <input type="date" id="customEndDate">
                        </div>
                    </div>
                </div>
                
                <!-- Extracted Data Preview (hidden by default) -->
                <div id="urlExtractedPreview" style="display: none; margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <h4 style="margin-bottom: 10px; color: #1976d2;"> Extracted Event Details</h4>
                    <div id="urlExtractedContent" style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; font-size: 14px;"></div>
                    
                    <div id="applyToFormSection" style="display: none; margin: 15px 0; text-align: center;">
                        <button type="button" onclick="applyExtractedToForm()" class="btn btn-primary" style="background: #10b981; font-size: 16px; padding: 12px 24px;">
                             Apply Venue & City to Form
                        </button>
                        <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">Click to auto-select the matched venue and city in the dropdowns above</p>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                        <strong> Review & Edit:</strong>
                        <p style="margin: 8px 0 0 0; font-size: 13px; color: #856404;">Please review the extracted information below and make any necessary corrections before creating events.</p>
                    </div>
                    
                    <!-- Editable fields -->
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="extractedTitle">Event Title:</label>
                            <input type="text" id="extractedTitle" placeholder="Edit title if needed">
                        </div>
                        
                        <div class="form-group">
                            <label for="extractedDescription">Description:</label>
                            <textarea id="extractedDescription" rows="3" placeholder="Edit description if needed"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="extractedStartTime">Start Time:</label>
                                <input type="time" id="extractedStartTime">
                            </div>
                            <div class="form-group">
                                <label for="extractedEndTime">End Time:</label>
                                <input type="time" id="extractedEndTime">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="extractedLocation">Location/Meeting Point:</label>
                            <input type="text" id="extractedLocation" placeholder="Edit location if needed">
                        </div>
                        
                        <div class="form-group">
                            <label for="extractedSchedule">Schedule Info:</label>
                            <input type="text" id="extractedSchedule" placeholder="e.g., Fridays 6:30pm - 7:30pm" readonly style="background: #f5f5f5;">
                            <small>Detected recurring schedule (read-only)</small>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('urlScraperModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary"> Create Events</button>
                </div>
            </form>
            
            <!-- Scraped Data Display (after creation) -->
            <div id="scrapedDataDisplay" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4> Scraped Event Data</h4>
                <div id="scrapedDataContent"></div>
                
                <div class="modal-actions" style="margin-top: 15px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('urlScraperModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Event from Venue Modal -->
    <div id="createFromVenueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Create Event from Venue</h3>
                <span class="close" onclick="closeModal('createFromVenueModal')">&times;</span>
            </div>
            <form id="createFromVenueForm">
                <div class="form-group">
                    <label for="venueSelect">Select Venue:</label>
                    <select id="venueSelect" required>
                        <option value="">Choose a venue...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="eventTitleFromVenue">Event Title:</label>
                    <input type="text" id="eventTitleFromVenue" required placeholder="Enter event title">
                </div>
                
                <div class="form-group">
                    <label for="eventDescriptionFromVenue">Description:</label>
                    <textarea id="eventDescriptionFromVenue" rows="3" placeholder="Enter event description"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDateFromVenue">Start Date:</label>
                        <input type="date" id="startDateFromVenue" required>
                    </div>
                    <div class="form-group">
                        <label for="endDateFromVenue">End Date:</label>
                        <input type="date" id="endDateFromVenue">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="startTimeFromVenue">Start Time:</label>
                        <input type="time" id="startTimeFromVenue">
                    </div>
                    <div class="form-group">
                        <label for="endTimeFromVenue">End Time:</label>
                        <input type="time" id="endTimeFromVenue">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="eventTypeFromVenue">Event Type:</label>
                    <select id="eventTypeFromVenue" required>
                        <option value="tour">Tour</option>
                        <option value="exhibition">Exhibition</option>
                        <option value="festival">Festival</option>
                        <option value="photowalk">Photowalk</option>
                        <option value="workshop">Workshop</option>
                        <option value="seminar">Seminar</option>
                        <option value="conference">Conference</option>
                        <option value="meeting">Meeting</option>
                        <option value="lecture">Lecture</option>
                        <option value="presentation">Presentation</option>
                        <option value="performance">Performance</option>
                        <option value="concert">Concert</option>
                        <option value="show">Show</option>
                        <option value="party">Party</option>
                        <option value="reception">Reception</option>
                        <option value="networking">Networking</option>
                        <option value="social">Social Event</option>
                        <option value="fundraiser">Fundraiser</option>
                        <option value="charity">Charity Event</option>
                        <option value="sports">Sports Event</option>
                        <option value="competition">Competition</option>
                        <option value="contest">Contest</option>
                        <option value="awards">Awards Ceremony</option>
                        <option value="gala">Gala</option>
                        <option value="dinner">Dinner</option>
                        <option value="lunch">Lunch</option>
                        <option value="brunch">Brunch</option>
                        <option value="tasting">Tasting</option>
                        <option value="market">Market</option>
                        <option value="fair">Fair</option>
                        <option value="carnival">Carnival</option>
                        <option value="parade">Parade</option>
                        <option value="march">March</option>
                        <option value="protest">Protest</option>
                        <option value="rally">Rally</option>
                        <option value="demonstration">Demonstration</option>
                        <option value="ceremony">Ceremony</option>
                        <option value="celebration">Celebration</option>
                        <option value="anniversary">Anniversary</option>
                        <option value="birthday">Birthday</option>
                        <option value="wedding">Wedding</option>
                        <option value="graduation">Graduation</option>
                        <option value="launch">Launch Event</option>
                        <option value="opening">Opening</option>
                        <option value="closing">Closing</option>
                        <option value="preview">Preview</option>
                        <option value="screening">Screening</option>
                        <option value="premiere">Premiere</option>
                        <option value="book_signing">Book Signing</option>
                        <option value="signing">Signing</option>
                        <option value="autograph">Autograph Session</option>
                        <option value="meet_greet">Meet & Greet</option>
                        <option value="q_a">Q&A Session</option>
                        <option value="panel">Panel Discussion</option>
                        <option value="debate">Debate</option>
                        <option value="forum">Forum</option>
                        <option value="summit">Summit</option>
                        <option value="retreat">Retreat</option>
                        <option value="training">Training</option>
                        <option value="class">Class</option>
                        <option value="course">Course</option>
                        <option value="lesson">Lesson</option>
                        <option value="tutorial">Tutorial</option>
                        <option value="demo">Demo</option>
                        <option value="trial">Trial</option>
                        <option value="test">Test</option>
                        <option value="exam">Exam</option>
                        <option value="audition">Audition</option>
                        <option value="interview">Interview</option>
                        <option value="appointment">Appointment</option>
                        <option value="consultation">Consultation</option>
                        <option value="session">Session</option>
                        <option value="therapy">Therapy</option>
                        <option value="treatment">Treatment</option>
                        <option value="checkup">Checkup</option>
                        <option value="inspection">Inspection</option>
                        <option value="tournament">Tournament</option>
                        <option value="championship">Championship</option>
                        <option value="playoff">Playoff</option>
                        <option value="game">Game</option>
                        <option value="match">Match</option>
                        <option value="race">Race</option>
                        <option value="marathon">Marathon</option>
                        <option value="walk">Walk</option>
                        <option value="run">Run</option>
                        <option value="ride">Ride</option>
                        <option value="hike">Hike</option>
                        <option value="climb">Climb</option>
                        <option value="swim">Swim</option>
                        <option value="dive">Dive</option>
                        <option value="sail">Sail</option>
                        <option value="cruise">Cruise</option>
                        <option value="trip">Trip</option>
                        <option value="excursion">Excursion</option>
                        <option value="adventure">Adventure</option>
                        <option value="expedition">Expedition</option>
                        <option value="journey">Journey</option>
                        <option value="pilgrimage">Pilgrimage</option>
                        <option value="retreat">Retreat</option>
                        <option value="camp">Camp</option>
                        <option value="camping">Camping</option>
                        <option value="picnic">Picnic</option>
                        <option value="barbecue">Barbecue</option>
                        <option value="cookout">Cookout</option>
                        <option value="potluck">Potluck</option>
                        <option value="banquet">Banquet</option>
                        <option value="feast">Feast</option>
                        <option value="buffet">Buffet</option>
                        <option value="catered">Catered Event</option>
                        <option value="catering">Catering</option>
                        <option value="delivery">Delivery</option>
                        <option value="pickup">Pickup</option>
                        <option value="dropoff">Drop-off</option>
                        <option value="collection">Collection</option>
                        <option value="distribution">Distribution</option>
                        <option value="donation">Donation</option>
                        <option value="volunteer">Volunteer</option>
                        <option value="service">Service</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="repair">Repair</option>
                        <option value="installation">Installation</option>
                        <option value="setup">Setup</option>
                        <option value="breakdown">Breakdown</option>
                        <option value="cleanup">Cleanup</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="inspection">Inspection</option>
                        <option value="audit">Audit</option>
                        <option value="review">Review</option>
                        <option value="evaluation">Evaluation</option>
                        <option value="assessment">Assessment</option>
                        <option value="analysis">Analysis</option>
                        <option value="research">Research</option>
                        <option value="study">Study</option>
                        <option value="survey">Survey</option>
                        <option value="poll">Poll</option>
                        <option value="vote">Vote</option>
                        <option value="election">Election</option>
                        <option value="referendum">Referendum</option>
                        <option value="petition">Petition</option>
                        <option value="campaign">Campaign</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="eventUrlFromVenue">Event URL:</label>
                    <input type="url" id="eventUrlFromVenue" placeholder="https://...">
                </div>
                
                <div class="form-group">
                    <label for="eventSourceFromVenue">Event Source:</label>
                    <select id="eventSourceFromVenue">
                        <option value="">Select Source</option>
                        <option value="instagram">Instagram</option>
                        <option value="facebook">Facebook</option>
                        <option value="twitter">Twitter</option>
                        <option value="website">Website</option>
                        <option value="email">Email</option>
                        <option value="flyer">Flyer/Poster</option>
                        <option value="word_of_mouth">Word of Mouth</option>
                        <option value="venue_website">Venue Website</option>
                        <option value="eventbrite">Eventbrite</option>
                        <option value="meetup">Meetup</option>
                        <option value="ticketmaster">Ticketmaster</option>
                        <option value="stubhub">StubHub</option>
                        <option value="newspaper">Newspaper</option>
                        <option value="magazine">Magazine</option>
                        <option value="radio">Radio</option>
                        <option value="tv">TV</option>
                        <option value="billboard">Billboard</option>
                        <option value="direct_mail">Direct Mail</option>
                        <option value="newsletter">Newsletter</option>
                        <option value="blog">Blog</option>
                        <option value="podcast">Podcast</option>
                        <option value="youtube">YouTube</option>
                        <option value="tiktok">TikTok</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="reddit">Reddit</option>
                        <option value="discord">Discord</option>
                        <option value="telegram">Telegram</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="phone_call">Phone Call</option>
                        <option value="text_message">Text Message</option>
                        <option value="in_person">In Person</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="sourceUrlFromVenue">Source URL:</label>
                    <input type="url" id="sourceUrlFromVenue" placeholder="https://instagram.com/...">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="createCalendarEventFromVenue" checked>
                        Create Google Calendar Event
                    </label>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createFromVenueModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary"> Create Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Unified Calendar Export Module -->
    <script src="/static/js/calendar-export.js"></script>

    <script>
        console.log('Minimal script test - starting...');
        
        // Simple test function
        async function loadOverview() {
            try {
                console.log('Loading overview statistics...');
                const statsGrid = document.getElementById('statsGrid');
                
                if (!statsGrid) {
                    console.error('statsGrid element not found!');
                    return;
                }
                
                const response = await fetch('/api/admin/stats');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const stats = await response.json();
                console.log('Stats received:', stats);
                
                // Ensure all values are numbers, default to 0 if undefined
                const citiesCount = stats.cities !== undefined ? stats.cities : 0;
                const venuesCount = stats.venues !== undefined ? stats.venues : 0;
                const sourcesCount = stats.sources !== undefined ? stats.sources : 0;
                const eventsCount = stats.events !== undefined ? stats.events : 0;
                
                statsGrid.innerHTML = 
                    '<div class="stat-card" onclick="showSection(\'cities\')" style="cursor: pointer;">' +
                        '<h3>' + citiesCount + '</h3>' +
                        '<p>Cities</p>' +
                    '</div>' +
                    '<div class="stat-card" onclick="showSection(\'venues\')" style="cursor: pointer;">' +
                        '<h3>' + venuesCount + '</h3>' +
                        '<p>Venues</p>' +
                    '</div>' +
                    '<div class="stat-card" onclick="showSection(\'sources\')" style="cursor: pointer;">' +
                        '<h3>' + sourcesCount + '</h3>' +
                        '<p>Sources</p>' +
                    '</div>' +
                    '<div class="stat-card" onclick="showSection(\'events\')" style="cursor: pointer;">' +
                        '<h3>' + eventsCount + '</h3>' +
                        '<p>Events</p>' +
                    '</div>';
                
                console.log('Statistics loaded successfully');
            } catch (error) {
                console.error('Error loading statistics:', error);
                if (statsGrid) {
                    statsGrid.innerHTML = 
                        '<div class="stat-card">' +
                            '<h3>Error</h3>' +
                            '<p>Failed to load statistics: ' + (error.message || 'Unknown error') + '</p>' +
                        '</div>';
                }
            }
        }
        
        // Add timeout to prevent infinite loading
        function loadOverviewWithTimeout() {
            const statsGrid = document.getElementById('statsGrid');
            if (statsGrid) {
                // Set a timeout to show error if loading takes too long
                const timeout = setTimeout(() => {
                    if (statsGrid.innerHTML.includes('Loading statistics')) {
                        statsGrid.innerHTML = 
                            '<div class="stat-card">' +
                                '<h3>Timeout</h3>' +
                                '<p>Statistics are taking too long to load. Please check the server.</p>' +
                            '</div>';
                    }
                }, 10000); // 10 second timeout
                
                loadOverview().finally(() => {
                    clearTimeout(timeout);
                });
            }
        }
        
        // Navigation functions
        function showSection(sectionId) {
            // Show section immediately (synchronous) for instant UI feedback
            const sections = document.querySelectorAll('.data-section');
            sections.forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
                section.style.visibility = 'hidden';
            });
            
            // Show selected section immediately
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
                targetSection.style.visibility = 'visible';
                targetSection.style.opacity = '1';
                targetSection.style.position = 'relative';
                targetSection.style.zIndex = '1';
                targetSection.style.minHeight = '500px';
                
                // Log section dimensions for debugging
                setTimeout(() => {
                    const rect = targetSection.getBoundingClientRect();
                    console.log('Section dimensions:', {
                        width: rect.width,
                        height: rect.height,
                        top: rect.top,
                        left: rect.left,
                        display: window.getComputedStyle(targetSection).display,
                        visibility: window.getComputedStyle(targetSection).visibility
                    });
                }, 100);
                
                console.log('Showing section:', sectionId, 'Display:', targetSection.style.display, 'Active class:', targetSection.classList.contains('active'));
            } else {
                console.error('Section not found:', sectionId);
                return;
            }
            
            // Update navigation buttons
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Set active on the clicked button
            const activeButton = document.getElementById(`nav-${sectionId}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Fallback: find by onclick attribute
            const activeTab = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Load data asynchronously without blocking UI - use setTimeout to ensure UI updates first
            setTimeout(() => {
                loadSectionData(sectionId);
                // Re-render table if data is already loaded (for sources, cities, venues, events)
                if (sectionId === 'sources' && window.allSources) {
                    renderSourcesTable();
                } else if (sectionId === 'cities' && window.allCities) {
                    renderCitiesTable();
                } else if (sectionId === 'venues' && window.allVenues) {
                    renderVenuesTable();
                } else if (sectionId === 'events' && window.allEvents) {
                    renderEventsTable();
                }
            }, 0);
        }
        
        // Smart matching function for dropdown options
        function findBestMatch(extractedValue, dropdownElement, fieldType) {
            if (!extractedValue || !dropdownElement) return -1;
            
            const options = dropdownElement.options;
            const searchTerm = extractedValue.toLowerCase().trim();
            
            console.log(`Smart matching ${fieldType}: "${extractedValue}"`);
            
            // Define semantic mappings for common variations
            const semanticMappings = {
                'event type': {
                    'meetup': ['photowalk', 'tour', 'workshop'],
                    'gathering': ['meetup', 'party', 'reception'],
                    'talk': ['talk', 'lecture', 'presentation', 'seminar'],
                    'talks': ['talk', 'lecture', 'presentation', 'seminar'],
                    'show': ['performance', 'concert', 'exhibition'],
                    'class': ['workshop', 'seminar', 'lecture'],
                    'demo': ['presentation', 'workshop', 'lecture'],
                    'social': ['party', 'reception', 'meetup'],
                    'networking': ['meeting', 'reception', 'party']
                },
                'city': {
                    'washington': ['washington, district of columbia', 'washington dc', 'washington, dc', 'dc'],
                    'washington dc': ['washington, district of columbia', 'washington, dc', 'dc'],
                    'dc': ['washington, district of columbia', 'washington, dc', 'washington dc'],
                    'new york': ['new york, new york', 'nyc', 'new york city'],
                    'nyc': ['new york, new york', 'new york city', 'new york'],
                    'los angeles': ['los angeles, california', 'la'],
                    'la': ['los angeles, california', 'los angeles'],
                    'san francisco': ['san francisco, california', 'sf'],
                    'sf': ['san francisco, california', 'san francisco']
                }
            };
            
            // 1. Exact match (compare against option text, not value)
            for (let i = 0; i < options.length; i++) {
                if (options[i].text.toLowerCase() === searchTerm) {
                    console.log(` Exact match: ${options[i].text}`);
                    return i;
                }
            }
            
            // 2. Semantic mapping match
            if (semanticMappings[fieldType] && semanticMappings[fieldType][searchTerm]) {
                const candidates = semanticMappings[fieldType][searchTerm];
                for (const candidate of candidates) {
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].text.toLowerCase() === candidate) {
                            console.log(` Semantic match: "${searchTerm}"  ${options[i].text}`);
                            return i;
                        }
                    }
                }
            }
            
            // 3. Partial match (contains) - compare against option text
            for (let i = 0; i < options.length; i++) {
                if (options[i].text.toLowerCase().includes(searchTerm) || 
                    searchTerm.includes(options[i].text.toLowerCase())) {
                    console.log(` Partial match: ${options[i].text}`);
                    return i;
                }
            }
            
            // 4. Fuzzy match (similar words) - compare against option text
            for (let i = 0; i < options.length; i++) {
                if (calculateSimilarity(searchTerm, options[i].text.toLowerCase()) > 0.6) {
                    console.log(` Fuzzy match: ${options[i].text} (similarity: ${calculateSimilarity(searchTerm, options[i].text.toLowerCase())})`);
                    return i;
                }
            }
            
            console.log(` No match found for: "${extractedValue}"`);
            return -1;
        }
        
        // Simple similarity calculation (Levenshtein distance based)
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }
        
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[str2.length][str1.length];
        }
        
        // Load data for sections
        function loadSectionData(sectionName) {
            // For events, if data is already loaded, just render the table
            if (sectionName === 'events' && window.allEvents && window.allEvents.length > 0) {
                renderEventsTable();
                return;
            }
            
            switch(sectionName) {
                case 'overview':
                    loadOverviewWithTimeout();
                    break;
                case 'cities':
                    if (!window.allCities || window.allCities.length === 0) {
                        loadCities();
                    } else {
                        renderCitiesTable();
                    }
                    break;
                case 'venues':
                    if (!window.allVenues || window.allVenues.length === 0) {
                        loadVenues();
                    } else {
                        renderVenuesTable();
                    }
                    break;
                case 'events':
                    loadEvents();
                    break;
                case 'sources':
                    if (!window.allSources || window.allSources.length === 0) {
                        loadSources();
                    } else {
                        renderSourcesTable();
                    }
                    break;
            }
        }
        
        // Load cities data
        async function loadCities() {
            try {
                console.log('Loading cities...');
                const response = await fetch('/api/admin/cities');
                const cities = await response.json();
                
                if (cities.error) throw new Error(cities.error);
                
                console.log('Cities loaded:', cities.length);
                
                // Store cities globally for filtering
                window.allCities = cities;
                window.filteredCities = [...cities];
                
                // Render the cities table
                renderCitiesTable();
                populateCityFilters();
                
                // Populate all city dropdowns
                populateAllCityDropdowns();
                
            } catch (error) {
                console.error('Error loading cities:', error);
                const citiesTable = document.getElementById('citiesTable');
                if (citiesTable) {
                    citiesTable.innerHTML = '<tr><td colspan="11" class="no-results"> Failed to load cities: ' + error.message + '</td></tr>';
                }
            }
        }
        
        // Helper function to populate all city dropdowns across the admin interface
        function populateAllCityDropdowns() {
            if (!window.allCities) {
                console.warn('Cities not loaded yet, skipping dropdown population');
                return;
            }
            
            // Populate quick URL city selector
            populateQuickUrlCitySelector();
            
            // Populate URL scraper city selector (if modal is open or on demand)
            populateUrlCitySelector();
        }
        
        // Populate the URL scraper modal city dropdown
        function populateUrlCitySelector() {
            if (!window.allCities) return;
            
            const select = document.getElementById('urlCitySelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Choose a city...</option>';
            window.allCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city.id;
                option.textContent = `${city.name}${city.state ? ', ' + city.state : ''}, ${city.country || ''}`;
                select.appendChild(option);
            });
            
            // Try auto-selection if we have extracted data
            if (window.extractedEventData && window.extractedEventData.city_id) {
                select.value = window.extractedEventData.city_id;
                console.log(' AUTO-SELECTED CITY:', window.extractedEventData.city_id);
            }
        }
        
        // Render cities table dynamically
        function renderCitiesTable() {
            const data = window.filteredCities || window.allCities || [];
            // Ensure the section is visible before rendering
            const citiesSection = document.getElementById('cities');
            if (!citiesSection) {
                console.warn('Cities section not found, skipping render');
                return;
            }
            
            // Check if section is visible - use class check instead of getComputedStyle (faster, no reflow)
            if (!citiesSection.classList.contains('active')) {
                return;
            }
            
            // Defer heavy table rendering to next frame to keep UI responsive
            requestAnimationFrame(() => {
                // Ensure the table container is visible before rendering
                const tableContainer = citiesSection.querySelector('.table-container');
                if (tableContainer) {
                    tableContainer.style.display = 'block';
                    tableContainer.style.visibility = 'visible';
                    tableContainer.style.minHeight = '400px';
                    tableContainer.style.height = 'auto';
                }
                renderDynamicTable('citiesTable', data, 'cities');
            });
        }
        
        // Populate city filters
        function populateCityFilters() {
            const countryFilter = document.getElementById('cityCountryFilter');
            if (!countryFilter || !window.allCities) return;
            
            const countries = [...new Set(window.allCities.map(city => city.country).filter(Boolean))].sort();
            
            countryFilter.innerHTML = '<option value="">All Countries</option>';
            countries.forEach(country => {
                countryFilter.innerHTML += '<option value="' + country + '">' + country + '</option>';
            });
        }
        
        // City filter functions
        function applyCityFilters() {
            if (!window.allCities) return;
            
            const searchTerm = document.getElementById('citySearch').value.toLowerCase();
            const countryFilter = document.getElementById('cityCountryFilter').value;
            const venueFilter = document.getElementById('cityVenueFilter').value;
            
            window.filteredCities = window.allCities.filter(city => {
                const matchesSearch = !searchTerm || 
                    city.name.toLowerCase().includes(searchTerm) ||
                    (city.state && city.state.toLowerCase().includes(searchTerm)) ||
                    city.country.toLowerCase().includes(searchTerm);
                
                const matchesCountry = !countryFilter || city.country === countryFilter;
                
                const matchesVenue = !venueFilter || (() => {
                    const count = city.venue_count || 0;
                    switch (venueFilter) {
                        case '0': return count === 0;
                        case '1-4': return count >= 1 && count <= 4;
                        case '5+': return count >= 5;
                        default: return true;
                    }
                })();
                
                return matchesSearch && matchesCountry && matchesVenue;
            });
            
            renderCitiesTable();
        }
        
        function clearCityFilters() {
            document.getElementById('citySearch').value = '';
            document.getElementById('cityCountryFilter').value = '';
            document.getElementById('cityVenueFilter').value = '';
            
            if (window.allCities) {
                window.filteredCities = [...window.allCities];
                renderCitiesTable();
            }
        }
        
        function openAddCityModal() {
            document.getElementById('addCityModal').style.display = 'block';
            // Clear form
            document.getElementById('addCityForm').reset();
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function editCity(id) {
            // Find the city data
            const city = window.allCities.find(c => c.id == id);
            if (!city) {
                alert('City not found');
                return;
            }
            
            // Populate the edit form
            document.getElementById('editCityId').value = city.id;
            document.getElementById('editCityName').value = city.name;
            document.getElementById('editCityState').value = city.state || '';
            document.getElementById('editCityCountry').value = city.country;
            document.getElementById('editCityTimezone').value = city.timezone || '';
            
            // Show the modal
            document.getElementById('editCityModal').style.display = 'block';
        }
        
        function deleteCity(id) {
            if (confirm('Are you sure you want to delete this city? This will also delete all associated venues and events.')) {
                handleDeleteCity(id);
            }
        }
        
        // Handle delete city API call
        async function handleDeleteCity(cityId) {
            try {
                console.log('Deleting city:', cityId);
                
                const response = await fetch('/api/admin/cities/' + cityId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('City deleted successfully:', result);
                    alert('City deleted successfully!');
                    
                    // Reload cities data
                    await loadCities();
                    
                } else {
                    console.error('Error deleting city:', result);
                    alert('Error deleting city: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error deleting city:', error);
                alert('Error deleting city: ' + error.message);
            }
        }
        
        // Load venues data
        async function loadVenues() {
            try {
                // Load cities first if not already loaded (needed for city filter)
                if (!window.allCities || window.allCities.length === 0) {
                    console.log('Loading cities first for venue filter...');
                    try {
                        const citiesResponse = await fetch('/api/admin/cities');
                        const cities = await citiesResponse.json();
                        if (!cities.error) {
                            window.allCities = cities;
                            console.log('Cities loaded for filter:', cities.length);
                        }
                    } catch (citiesError) {
                        console.warn('Could not load cities for filter:', citiesError);
                    }
                }
                
                console.log('Loading venues...');
                const response = await fetch('/api/admin/venues');
                const venues = await response.json();
                
                if (venues.error) throw new Error(venues.error);
                
                console.log('Venues loaded:', venues.length);
                
                // Store venues globally for filtering
                window.allVenues = venues;
                window.filteredVenues = [...venues];
                
                // Render the venues table
                renderVenuesTable();
                populateVenueFilters();
                
            } catch (error) {
                console.error('Error loading venues:', error);
                const venuesTable = document.getElementById('venuesTable');
                if (venuesTable) {
                    venuesTable.innerHTML = '<tr><td colspan="20" class="no-results"> Failed to load venues: ' + error.message + '</td></tr>';
                }
            }
        }
        
        // Sorting functionality for dynamic tables
        function sortTable(tableId, field) {
            console.log('sortTable called:', tableId, field);
            
            // Determine which data array to sort based on table ID
            let dataArray;
            let filteredArray;
            
            switch(tableId) {
                case 'citiesTable':
                    dataArray = window.allCities;
                    filteredArray = window.filteredCities;
                    break;
                case 'venuesTable':
                    dataArray = window.allVenues;
                    filteredArray = window.filteredVenues;
                    break;
                case 'eventsTable':
                    dataArray = window.allEvents;
                    filteredArray = window.filteredEvents;
                    break;
                case 'sourcesTable':
                    dataArray = window.allSources;
                    filteredArray = window.filteredSources;
                    break;
                default:
                    console.error('Unknown table ID for sorting:', tableId);
                    return;
            }
            
            console.log('Data arrays:', {
                dataArrayLength: dataArray?.length,
                filteredArrayLength: filteredArray?.length,
                dataArray: dataArray,
                filteredArray: filteredArray
            });
            
            // Use allData if filtered is not available
            if (!filteredArray) {
                filteredArray = dataArray;
                console.log('Using dataArray as filteredArray');
            }
            
            if (!dataArray || !filteredArray) {
                console.error('Data arrays not available for sorting');
                return;
            }
            
            // Toggle sort direction (store in data attribute)
            const table = document.querySelector(`#${tableId}`).closest('table');
            const currentSort = table.dataset.currentSort;
            const currentField = table.dataset.currentField;
            
            let ascending = true;
            if (currentField === field && currentSort === 'asc') {
                ascending = false;
            }
            
            // Update table data attributes
            table.dataset.currentField = field;
            table.dataset.currentSort = ascending ? 'asc' : 'desc';
            
            // Create a copy to sort (don't mutate the original)
            const sortedArray = [...filteredArray].sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                // Handle null/undefined values
                if (aVal === null || aVal === undefined) aVal = '';
                if (bVal === null || bVal === undefined) bVal = '';
                
                // Handle different data types
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                // Handle dates (ISO format)
                if (field.includes('_at') || field.includes('_date')) {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                // Compare values
                if (aVal < bVal) return ascending ? -1 : 1;
                if (aVal > bVal) return ascending ? 1 : -1;
                return 0;
            });
            
            // Update the window variable for the filtered array
            switch(tableId) {
                case 'citiesTable':
                    window.filteredCities = sortedArray;
                    break;
                case 'venuesTable':
                    window.filteredVenues = sortedArray;
                    break;
                case 'eventsTable':
                    window.filteredEvents = sortedArray;
                    break;
                case 'sourcesTable':
                    window.filteredSources = sortedArray;
                    console.log('Updated window.filteredSources:', sortedArray.length, 'items');
                    break;
            }
            
            console.log('Sorted array length:', sortedArray.length);
            console.log('First 3 items:', sortedArray.slice(0, 3));
            
            // Re-render the table
            const tableType = tableId.replace('Table', '');
            console.log('Calling renderDynamicTable with:', tableId, sortedArray.length, tableType);
            renderDynamicTable(tableId, sortedArray, tableType);
            
            // Update header arrows to show sort direction
            updateSortArrows(table, field, ascending);
        }
        
        function updateSortArrows(table, field, ascending) {
            // Remove all arrows first
            const headers = table.querySelectorAll('th');
            headers.forEach(header => {
                const text = header.textContent.replace(' ', '').replace(' ', '').replace(' ', '');
                header.textContent = text + ' ';
            });
            
            // Add arrow to current field
            const currentHeader = Array.from(headers).find(header => 
                header.textContent.includes(field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))
            );
            if (currentHeader) {
                const text = currentHeader.textContent.replace(' ', '').replace(' ', '').replace(' ', '');
                currentHeader.textContent = text + (ascending ? ' ' : ' ');
            }
        }
        
        function getEventTypeBadgeClass(eventType) {
            // Return appropriate badge class based on event type
            const type = eventType.toLowerCase();
            
            if (type.includes('photowalk') || type.includes('photo_walk')) {
                return 'badge-photowalk';
            } else if (type.includes('exhibition') || type.includes('gallery')) {
                return 'badge-exhibition';
            } else if (type.includes('tour')) {
                return 'badge-tour';
            } else if (type.includes('festival') || type.includes('event')) {
                return 'badge-festival';
            } else if (type.includes('workshop') || type.includes('class')) {
                return 'badge-workshop';
            } else if (type.includes('cultural') || type.includes('culture')) {
                return 'badge-cultural';
            } else if (type.includes('film') || type.includes('cinema')) {
                return 'badge-film';
            } else if (type.includes('art') || type.includes('creative')) {
                return 'badge-art';
            } else if (type.includes('language') || type.includes('french')) {
                return 'badge-language';
            } else {
                return 'badge-default';
            }
        }
        
        // Dynamic table rendering system
        function renderDynamicTable(tableId, data, tableType = 'default') {
            console.log('renderDynamicTable called:', { tableId, dataLength: data?.length, tableType });
            const tableBody = document.getElementById(tableId);
            if (!tableBody) {
                console.error('Table body not found:', tableId);
                return;
            }
            
            // Verify we're rendering to the correct table
            const expectedSection = tableId.replace('Table', '');
            const parentSection = tableBody.closest('.data-section');
            if (parentSection && parentSection.id !== expectedSection) {
                console.error('WARNING: Rendering', tableType, 'data to table in section', parentSection.id, 'but expected section', expectedSection);
            }
            
            if (!data || data.length === 0) {
                console.warn('No data to render for table:', tableId);
                tableBody.innerHTML = '<tr><td colspan="100" class="no-results"> No data found</td></tr>';
                return;
            }
            
            // Get the first item to determine available fields dynamically
            const sampleItem = data[0];
            const availableFields = Object.keys(sampleItem);
            console.log('Available fields:', availableFields);
            
            // Define field display preferences (order, visibility, formatting)
            const fieldConfig = getFieldConfig(tableType);
            console.log('Field config for', tableType, ':', fieldConfig);
            
            // Filter and order fields based on configuration
            const orderedFields = fieldConfig.order.filter(field => availableFields.includes(field));
            
            // Add any new fields not in the config (for future-proofing)
            const newFields = availableFields.filter(field => !fieldConfig.order.includes(field));
            orderedFields.push(...newFields);
            
            // Generate table headers
            const table = document.querySelector(`#${tableId}`).closest('table');
            if (!table) {
                console.error('Table not found for tableId:', tableId);
                return;
            }
            
            // Ensure table is visible
            table.style.display = 'table';
            table.style.visibility = 'visible';
            table.style.width = '100%';
            
            const tableHead = table.querySelector('thead tr');
            if (tableHead) {
                let headerRow = '';
                
                // Add checkbox and calendar icon headers for events table
                if (tableType === 'events') {
                    headerRow += '<th style="width: 40px; text-align: center;"><input type="checkbox" id="selectAllEvents" onchange="toggleSelectAllEvents(this)" title="Select All"></th>';
                    headerRow += '<th></th>';
                }
                
                orderedFields.forEach(field => {
                    const config = fieldConfig.fields[field] || { label: formatFieldName(field), visible: true };
                    if (config.visible !== false) {
                        // Add class for description and additional_info columns to apply narrow styling
                        const cellClass = (field === 'description' || field === 'additional_info') ? ` class="${field}"` : '';
                        if (config.sortable !== false) {
                            headerRow += `<th${cellClass} onclick="sortTable('${tableId}', '${field}')" style="cursor: pointer; user-select: none;" title="Click to sort">${config.label} </th>`;
                        } else {
                            headerRow += `<th${cellClass}>${config.label}</th>`;
                        }
                    }
                });
                
                // Always include Actions header
                headerRow += '<th>Actions</th>';
                
                tableHead.innerHTML = headerRow;
                console.log('Table headers generated:', orderedFields.length, 'fields, headerRow length:', headerRow.length);
            } else {
                console.error('Table head row not found for tableId:', tableId);
            }
            
            // Generate data rows
            let rowsHTML = '';
            try {
                rowsHTML = data.map(item => {
                // Make all table rows clickable (double-click)
                let rowClickable = '';
                if (tableType === 'events') {
                    rowClickable = 'ondblclick="showEventDetails(event, ' + item.id + ')" style="cursor: pointer;"';
                } else if (tableType === 'venues') {
                    rowClickable = 'ondblclick="showVenueDetails(event, ' + item.id + ')" style="cursor: pointer;"';
                } else if (tableType === 'cities') {
                    rowClickable = 'ondblclick="showCityDetails(event, ' + item.id + ')" style="cursor: pointer;"';
                } else if (tableType === 'sources') {
                    rowClickable = 'ondblclick="showSourceDetails(event, ' + item.id + ')" style="cursor: pointer;"';
                }
                let row = `<tr id="${tableType}-row-${item.id}" ${rowClickable}>`;
                
                // Add checkbox and calendar icon for events
                if (tableType === 'events') {
                    const checkbox = `<td style="text-align: center; padding: 8px; width: 40px;" onclick="event.stopPropagation();">
                        <input type="checkbox" class="event-checkbox" value="${item.id}" onchange="updateBulkExportButton()" onclick="event.stopPropagation();">
                    </td>`;
                    row += checkbox;
                    const calendarIcon = `<td style="text-align: center; padding: 8px;" onclick="event.stopPropagation();">
                        <button onclick="event.stopPropagation(); addEventToCalendar(${item.id})" 
                                class="icon-btn calendar-btn"
                                title="Add to Calendar">
                            
                        </button>
                    </td>`;
                    row += calendarIcon;
                }
                
                orderedFields.forEach(field => {
                    const config = fieldConfig.fields[field] || { label: formatFieldName(field), visible: true };
                    if (config.visible !== false) {
                        const value = formatFieldValue(field, item[field], config);
                        // Add class for description and additional_info columns to apply narrow styling
                        const cellClass = (field === 'description' || field === 'additional_info') ? ` class="${field}"` : '';
                        // Ensure cells have content - use &nbsp; if empty to prevent collapse
                        const cellContent = value || '&nbsp;';
                        row += `<td${cellClass} style="padding: 10px 8px; min-height: 30px;">${cellContent}</td>`;
                    }
                });
                
                // Add actions column - prevent row click when clicking action buttons
                row += `<td onclick="event.stopPropagation(); event.stopImmediatePropagation();">${generateActionButtons(item.id, tableType)}</td>`;
                
                row += '</tr>';
                return row;
                }).join('');
            } catch (error) {
                console.error('Error generating table rows:', error);
                rowsHTML = '<tr><td colspan="100" class="no-results"> Error rendering table: ' + error.message + '</td></tr>';
            }
            
            if (rowsHTML.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="100" class="no-results"> Error rendering table</td></tr>';
            } else {
                tableBody.innerHTML = rowsHTML;
                // Verify rows were inserted
                const insertedRows = tableBody.querySelectorAll('tr');
                if (insertedRows.length === 0) {
                    console.error('ERROR: Rows HTML generated but no rows found in DOM after insertion!');
                    console.error('rowsHTML length:', rowsHTML.length);
                    console.error('First 500 chars of rowsHTML:', rowsHTML.substring(0, 500));
                } else {
                    console.log('Table rendered: ' + insertedRows.length + ' rows inserted into DOM');
                    // Ensure table body is visible
                    tableBody.style.display = 'table-row-group';
                    tableBody.style.visibility = 'visible';
                    
                    // Verify table structure
                    const parentTable = tableBody.closest('table');
                    if (parentTable) {
                        console.log('Table element found, display:', window.getComputedStyle(parentTable).display);
                        console.log('Table visibility:', window.getComputedStyle(parentTable).visibility);
                        console.log('Table height:', window.getComputedStyle(parentTable).height);
                    }
                }
            }
        }
        
        // Field configuration for different table types
        function getFieldConfig(tableType) {
            const configs = {
                venues: {
                    order: ['id', 'name', 'venue_type', 'city_name', 'address', 'opening_hours', 'phone_number', 'email', 'website_url', 'image_url', 'latitude', 'longitude', 'facebook_url', 'instagram_url', 'twitter_url', 'youtube_url', 'tiktok_url', 'holiday_hours', 'admission_fee', 'tour_info', 'description', 'additional_info', 'created_at', 'updated_at'],
                    fields: {
                        id: { label: 'ID', visible: true, sortable: true },
                        name: { label: 'Name', visible: true, sortable: true },
                        venue_type: { label: 'Type', visible: true, sortable: true },
                        city_name: { label: 'City', visible: true, sortable: true },
                        address: { label: 'Address', visible: true, sortable: true },
                        opening_hours: { label: 'Hours', visible: true, sortable: false },
                        phone_number: { label: 'Phone', visible: true, sortable: false },
                        email: { label: 'Email', visible: true, sortable: false },
                        website_url: { label: 'Website', visible: true, sortable: false },
                        image_url: { label: 'Image', visible: true, sortable: false },
                        latitude: { label: 'Latitude', visible: true, sortable: true },
                        longitude: { label: 'Longitude', visible: true, sortable: true },
                        facebook_url: { label: 'Facebook', visible: true, sortable: false },
                        instagram_url: { label: 'Instagram', visible: true, sortable: false },
                        twitter_url: { label: 'Twitter', visible: true, sortable: false },
                        youtube_url: { label: 'YouTube', visible: true, sortable: false },
                        tiktok_url: { label: 'TikTok', visible: true, sortable: false },
                        holiday_hours: { label: 'Holiday Hours', visible: true, sortable: false },
                        admission_fee: { label: 'Admission', visible: true, sortable: false },
                        tour_info: { label: 'Tour Info', visible: true, sortable: false },
                        description: { label: 'Description', visible: true, sortable: false },
                        additional_info: { label: 'Additional Info', visible: true, sortable: false },
                        created_at: { label: 'Created', visible: true, sortable: true },
                        updated_at: { label: 'Updated', visible: true, sortable: true }
                    }
                },
                sources: {
                    order: ['id', 'name', 'handle', 'source_type', 'city_name', 'is_active', 'events_found_count'],
                    fields: {
                        id: { label: 'ID', visible: true, sortable: true },
                        name: { label: 'Name', visible: true, sortable: true },
                        handle: { label: 'Handle', visible: true, sortable: true },
                        source_type: { label: 'Type', visible: true, sortable: true },
                        city_name: { label: 'City', visible: true, sortable: true },
                        event_types: { label: 'Event Types', visible: false, sortable: false },
                        reliability_score: { label: 'Reliability', visible: false, sortable: true },
                        posting_frequency: { label: 'Frequency', visible: false, sortable: true },
                        is_active: { label: 'Active', visible: true, sortable: true },
                        events_found_count: { label: 'Events', visible: true, sortable: true },
                        last_checked: { label: 'Last Checked', visible: false, sortable: true },
                        created_at: { label: 'Created', visible: false, sortable: true },
                        updated_at: { label: 'Updated', visible: false, sortable: true }
                    }
                },
                events: {
                    order: ['id', 'title', 'description', 'start_date', 'start_time', 'end_date', 'end_time', 'event_type', 'venue_name', 'city_name', 'created_at', 'updated_at'],
                    fields: {
                        id: { label: 'ID', visible: true, sortable: true },
                        title: { label: 'Title', visible: true, sortable: true },
                        description: { label: 'Description', visible: true, sortable: false },
                        start_date: { label: 'Start Date', visible: true, sortable: true },
                        start_time: { label: 'Start Time', visible: true, sortable: true },
                        end_date: { label: 'End Date', visible: true, sortable: true },
                        end_time: { label: 'End Time', visible: true, sortable: true },
                        event_type: { label: 'Type', visible: true, sortable: true },
                        venue_name: { label: 'Venue', visible: true, sortable: true },
                        city_name: { label: 'City', visible: true, sortable: true },
                        created_at: { label: 'Created', visible: true, sortable: true },
                        updated_at: { label: 'Updated', visible: true, sortable: true }
                    }
                },
                cities: {
                    order: ['id', 'name', 'state', 'country', 'display_name', 'timezone', 'venue_count', 'event_count', 'created_at', 'updated_at'],
                    fields: {
                        id: { label: 'ID', visible: true, sortable: true },
                        name: { label: 'Name', visible: true, sortable: true },
                        state: { label: 'State', visible: true, sortable: true },
                        country: { label: 'Country', visible: true, sortable: true },
                        display_name: { label: 'Display Name', visible: true, sortable: true },
                        timezone: { label: 'Timezone', visible: true, sortable: true },
                        venue_count: { label: 'Venues', visible: true, sortable: true },
                        event_count: { label: 'Events', visible: true, sortable: true },
                        created_at: { label: 'Created', visible: true, sortable: true },
                        updated_at: { label: 'Updated', visible: true, sortable: true }
                    }
                }
            };
            
            return configs[tableType] || {
                order: ['id'],
                fields: { id: { label: 'ID', visible: true } }
            };
        }
        
        // Format field names for unknown fields
        function formatFieldName(fieldName) {
            return fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Helper function to normalize UTC timestamps (append 'Z' if missing timezone)
        function normalizeUTCTimestamp(timestamp) {
            if (!timestamp || typeof timestamp !== 'string') {
                return timestamp;
            }
            const dateStr = timestamp.trim();
            // If it's an ISO datetime without timezone indicator, append 'Z' for UTC
            if (dateStr.includes('T') && !dateStr.endsWith('Z') && !dateStr.match(/[+-]\d{2}:?\d{2}$/)) {
                return dateStr + 'Z';
            }
            return dateStr;
        }
        
        // Format field values based on field type and configuration
        function formatFieldValue(fieldName, value, config = {}) {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            
            // Special formatting for specific fields
            switch (fieldName) {
                case 'website_url':
                case 'url':
                    return `<a href="${value}" target="_blank" onclick="event.stopPropagation();" style="color: #1976d2; text-decoration: none;">${value}</a>`;
                
                case 'youtube_url':
                    // Handle both full URLs and channel names
                    if (value.startsWith('@')) {
                        // It's already a channel handle like @username
                        const channel = value.substring(1); // Remove @
                        return `<a href="https://www.youtube.com/@${channel}" target="_blank" onclick="event.stopPropagation();" style="color: #FF0000; text-decoration: none;">${value}</a>`;
                    } else if (value.includes('youtube.com')) {
                        // It's a full URL - extract the meaningful part
                        const channelMatch = value.match(/youtube\.com\/(?:c\/|user\/|@)?([^\/\?]+)/);
                        if (channelMatch) {
                            const channel = channelMatch[1];
                            // Clean up the channel name for display
                            const displayName = channel.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            return `<a href="${value}" target="_blank" onclick="event.stopPropagation();" style="color: #FF0000; text-decoration: none;">${displayName}</a>`;
                        }
                    }
                    return `<a href="${value}" target="_blank" onclick="event.stopPropagation();" style="color: #FF0000; text-decoration: none;">YouTube</a>`;
                
                case 'tiktok_url':
                    // Handle both full URLs and usernames
                    if (value.startsWith('@')) {
                        // It's already a username like @username
                        const username = value.substring(1); // Remove @
                        return `<a href="https://www.tiktok.com/@${username}" target="_blank" onclick="event.stopPropagation();" style="color: #000000; text-decoration: none;">${value}</a>`;
                    } else if (value.includes('tiktok.com')) {
                        // It's a full URL
                        const tiktokMatch = value.match(/tiktok\.com\/@([^\/\?]+)/);
                        if (tiktokMatch) {
                            const username = tiktokMatch[1];
                            return `<a href="${value}" target="_blank" onclick="event.stopPropagation();" style="color: #000000; text-decoration: none;">@${username}</a>`;
                        }
                    }
                    return `<a href="${value}" target="_blank" onclick="event.stopPropagation();" style="color: #000000; text-decoration: none;">TikTok</a>`;
                
                case 'facebook_url':
                    // Extract page name from Facebook URL
                    const facebookMatch = value.match(/facebook\.com\/([^\/\?]+)/);
                    if (facebookMatch) {
                        const pageName = facebookMatch[1];
                        return `<a href="${value}" target="_blank" onclick="event.stopPropagation();" style="color: #1877F2; text-decoration: none;">${pageName}</a>`;
                    }
                    return `<a href="${value}" target="_blank" onclick="event.stopPropagation();" style="color: #1877F2; text-decoration: none;">Facebook</a>`;
                
                case 'instagram_url':
                    // Handle both full URLs and @handles
                    if (value.startsWith('@')) {
                        // It's already a handle like @username
                        const handle = value.substring(1); // Remove @
                        return `<a href="https://www.instagram.com/${handle}/" target="_blank" onclick="event.stopPropagation();" style="color: #E4405F; text-decoration: none;">${value}</a>`;
                    } else if (value.includes('instagram.com')) {
                        // It's a full URL
                        const instagramMatch = value.match(/instagram\.com\/([^\/\?]+)/);
                        if (instagramMatch) {
                            const handle = instagramMatch[1];
                            return `<a href="https://www.instagram.com/${handle}/" target="_blank" onclick="event.stopPropagation();" style="color: #E4405F; text-decoration: none;">@${handle}</a>`;
                        }
                    }
                    return `<a href="${value}" target="_blank" onclick="event.stopPropagation();" style="color: #E4405F; text-decoration: none;">Instagram</a>`;
                
                case 'twitter_url':
                    // Handle both full URLs and @handles
                    if (value.startsWith('@')) {
                        // It's already a handle like @username
                        const handle = value.substring(1); // Remove @
                        return `<a href="https://twitter.com/${handle}" target="_blank" onclick="event.stopPropagation();" style="color: #1DA1F2; text-decoration: none;">${value}</a>`;
                    } else if (value.includes('twitter.com')) {
                        // It's a full URL
                        const twitterMatch = value.match(/twitter\.com\/([^\/\?]+)/);
                        if (twitterMatch) {
                            const handle = twitterMatch[1];
                            return `<a href="https://twitter.com/${handle}" target="_blank" onclick="event.stopPropagation();" style="color: #1DA1F2; text-decoration: none;">@${handle}</a>`;
                        }
                    }
                    return `<a href="${value}" target="_blank" onclick="event.stopPropagation();" style="color: #1DA1F2; text-decoration: none;">Twitter</a>`;
                
                case 'image_url':
                    // Just show "View" text in table - no link to prevent browser from trying to load image
                    // The image can be viewed in the details modal
                    return value ? '<span style="color: #666;">View in details</span>' : '';
                
                case 'handle':
                    if (value.startsWith('@') && value.includes('instagram')) {
                        const handle = value.replace('@', '');
                        return `<a href="https://www.instagram.com/${handle}" target="_blank" style="color: #E4405F; text-decoration: none;">${value}</a>`;
                    }
                    return value;
                
                case 'source_type':
                    return `<span class="badge badge-${value}">${value}</span>`;
                
                case 'venue_type':
                    return `<span class="badge">${value}</span>`;
                
                case 'event_type':
                    return `<span class="badge badge-event">${value}</span>`;
                
                case 'is_active':
                    return value ? '' : '';
                
                case 'reliability_score':
                    return `${value}/10`;
                
                case 'event_types':
                    // Handle event types as array or string with improved styling
                    if (Array.isArray(value)) {
                        // Already an array from the API
                        return value.map(type => {
                            const cleanType = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            const badgeClass = getEventTypeBadgeClass(type);
                            return `<span class="badge ${badgeClass}" title="${type}">${cleanType}</span>`;
                        }).join(' ');
                    } else if (value && typeof value === 'string') {
                        try {
                            // Try to parse as JSON array
                            const types = JSON.parse(value);
                            if (Array.isArray(types)) {
                                return types.map(type => {
                                    const cleanType = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    const badgeClass = getEventTypeBadgeClass(type);
                                    return `<span class="badge ${badgeClass}" title="${type}">${cleanType}</span>`;
                                }).join(' ');
                            }
                        } catch (e) {
                            // If not JSON, treat as comma-separated
                            return value.split(',').map(type => {
                                const cleanType = type.trim().replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                const badgeClass = getEventTypeBadgeClass(type.trim());
                                return `<span class="badge ${badgeClass}" title="${type.trim()}">${cleanType}</span>`;
                            }).join(' ');
                        }
                    }
                    return '';
                
                case 'created_at':
                case 'updated_at':
                case 'last_checked':
                    try {
                        // Format datetime with time (timestamps are stored in UTC)
                        if (value && typeof value === 'string') {
                            // Normalize UTC timestamp (append 'Z' if missing timezone)
                            const normalizedTimestamp = normalizeUTCTimestamp(value);
                            
                            // Parse as UTC and convert to browser's local timezone
                            const date = new Date(normalizedTimestamp);
                            if (!isNaN(date.getTime())) {
                                // Use browser's locale and timezone automatically (no hardcoding)
                                // toLocaleString() automatically uses browser's timezone and locale
                                return date.toLocaleString(undefined, {
                                    month: '2-digit',
                                    day: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    hour12: true
                                });
                            }
                            // Fallback: try to parse as date string
                            const [year, month, day] = value.split('-');
                            if (year && month && day) {
                                return `${month}/${day}/${year}`;
                            }
                        }
                        return value || '';
                    } catch (e) {
                        console.error('Error formatting timestamp:', e, value);
                        return value || '';
                    }
                
                case 'start_date':
                case 'end_date':
                    try {
                        // Parse date string directly without timezone conversion
                        if (value && typeof value === 'string') {
                            const [year, month, day] = value.split('-');
                            return `${month}/${day}/${year}`;
                        }
                        return value;
                    } catch (e) {
                        return value;
                    }
                
                case 'start_time':
                case 'end_time':
                    try {
                        return new Date(`2000-01-01T${value}`).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    } catch (e) {
                        return value;
                    }
                
                case 'description':
                case 'tour_info':
                    if (value.length > 100) {
                        return `<span title="${value}">${value.substring(0, 100)}...</span>`;
                    }
                    return value;
                
                case 'additional_info':
                    try {
                        const info = JSON.parse(value);
                        if (info.closure_status) {
                            const status = info.closure_status;
                            const reason = info.closure_reason || '';
                            let statusIcon = '';
                            let statusClass = '';
                            
                            if (status === 'closed') {
                                statusIcon = '';
                                statusClass = 'closure-closed';
                            } else if (status === 'open') {
                                statusIcon = '';
                                statusClass = 'closure-open';
                            } else {
                                statusIcon = '';
                                statusClass = 'closure-unknown';
                            }
                            
                            return `<div class="closure-status ${statusClass}">
                                <strong>${statusIcon} ${status.toUpperCase()}</strong>
                                ${reason ? `<br><small>${reason}</small>` : ''}
                            </div>`;
                        }
                    } catch (e) {
                        // If not JSON, treat as regular text
                    }
                    
                    if (value.length > 100) {
                        return `<span title="${value}">${value.substring(0, 100)}...</span>`;
                    }
                    return value;
                
                case 'venue_count':
                case 'event_count':
                    const count = parseInt(value) || 0;
                    const badgeClass = count === 0 ? 'badge-zero' : count >= 5 ? 'badge-high' : 'badge';
                    return `<span class="badge ${badgeClass}">${count}</span>`;
                
                default:
                    return value;
            }
        }
        
        // Generate action buttons based on table type
        function generateActionButtons(id, tableType) {
            switch (tableType) {
                case 'venues':
                    return `<button onclick="event.stopPropagation(); editVenue(${id})" class="icon-btn edit-icon-btn" title="Edit"></button> <button onclick="event.stopPropagation(); deleteVenue(${id})" class="icon-btn delete-icon-btn" title="Delete"></button>`;
                case 'sources':
                    return `<button onclick="event.stopPropagation(); editSource(${id})" class="icon-btn edit-icon-btn" title="Edit"></button> <button onclick="event.stopPropagation(); deleteSource(${id})" class="icon-btn delete-icon-btn" title="Delete"></button>`;
                case 'events':
                    return `<button onclick="event.stopPropagation(); editEvent(${id})" class="icon-btn edit-icon-btn" title="Edit"></button> <button onclick="event.stopPropagation(); deleteEvent(${id})" class="icon-btn delete-icon-btn" title="Delete"></button>`;
                case 'cities':
                    return `<button onclick="event.stopPropagation(); editCity(${id})" class="icon-btn edit-icon-btn" title="Edit"></button> <button onclick="event.stopPropagation(); deleteCity(${id})" class="icon-btn delete-icon-btn" title="Delete"></button>`;
                default:
                    return `<button onclick="event.stopPropagation(); editItem(${id})" class="icon-btn edit-icon-btn" title="Edit"></button>`;
            }
        }
        
        // Render venues table using dynamic system
        function renderVenuesTable() {
            const data = window.filteredVenues || window.allVenues || [];
            // Ensure the section is visible before rendering
            const venuesSection = document.getElementById('venues');
            if (!venuesSection) {
                console.warn('Venues section not found, skipping render');
                return;
            }
            
            // Check if section is visible - use class check instead of getComputedStyle (faster, no reflow)
            if (!venuesSection.classList.contains('active')) {
                return;
            }
            
            // Defer heavy table rendering to next frame to keep UI responsive
            requestAnimationFrame(() => {
                // Ensure the table container is visible before rendering
                const tableContainer = venuesSection.querySelector('.table-container');
                if (tableContainer) {
                    tableContainer.style.display = 'block';
                    tableContainer.style.visibility = 'visible';
                    tableContainer.style.minHeight = '400px';
                    tableContainer.style.height = 'auto';
                }
                renderDynamicTable('venuesTable', data, 'venues');
            });
        }
        
        // Populate venue filters
        function populateVenueFilters() {
            const typeFilter = document.getElementById('venueTypeFilter');
            const cityFilter = document.getElementById('venueCityFilter');
            
            if (!typeFilter || !cityFilter || !window.allVenues) return;
            
            const types = [...new Set(window.allVenues.map(venue => venue.venue_type).filter(Boolean))].sort();
            
            // Populate city filter from all cities (not just cities with venues)
            // This ensures cities like State College and Irvine appear even if they have no venues yet
            // Format city names to match the API format: "City, State, Country" or "City, Country"
            let cityOptions = [];
            if (window.allCities && window.allCities.length > 0) {
                // Use all cities from the cities data, format to match API response
                cityOptions = window.allCities.map(city => {
                    let displayName = city.name;
                    if (city.state) {
                        displayName += `, ${city.state}, ${city.country}`;
                    } else {
                        displayName += `, ${city.country}`;
                    }
                    return {
                        id: city.id,
                        name: displayName,
                        cityName: city.name // Store just the city name for matching
                    };
                }).sort((a, b) => a.name.localeCompare(b.name));
            } else {
                // Fallback to cities from venues if cities haven't loaded yet
                const cityNames = [...new Set(window.allVenues.map(venue => venue.city_name).filter(Boolean))].sort();
                cityOptions = cityNames.map(name => ({
                    id: null,
                    name: name,
                    cityName: name.split(',')[0].trim() // Extract just city name
                }));
            }
            
            typeFilter.innerHTML = '<option value="">All Types</option>';
            types.forEach(type => {
                typeFilter.innerHTML += '<option value="' + type + '">' + type + '</option>';
            });
            
            cityFilter.innerHTML = '<option value="">All Cities</option>';
            cityOptions.forEach(city => {
                cityFilter.innerHTML += '<option value="' + city.name + '">' + city.name + '</option>';
            });
        }
        
        // Venue filter functions
        function applyVenueFilters() {
            if (!window.allVenues) return;
            
            const searchTerm = document.getElementById('venueSearch').value.toLowerCase();
            const typeFilter = document.getElementById('venueTypeFilter').value;
            const cityFilter = document.getElementById('venueCityFilter').value;
            const feeFilter = document.getElementById('venueFeeFilter').value;
            const closureFilter = document.getElementById('venueClosureFilter').value;
            const sortBy = document.getElementById('venueSortBy').value;
            
            window.filteredVenues = window.allVenues.filter(venue => {
                const matchesSearch = !searchTerm || 
                    venue.name.toLowerCase().includes(searchTerm) ||
                    (venue.venue_type && venue.venue_type.toLowerCase().includes(searchTerm)) ||
                    (venue.address && venue.address.toLowerCase().includes(searchTerm)) ||
                    (venue.description && venue.description.toLowerCase().includes(searchTerm));
                
                const matchesType = !typeFilter || venue.venue_type === typeFilter;
                // Match city by exact city_name (which includes state/country in format from API)
                const matchesCity = !cityFilter || (venue.city_name && venue.city_name === cityFilter);
                
                // Fee filter logic
                let matchesFee = true;
                if (feeFilter === 'free') {
                    matchesFee = !venue.admission_fee || 
                                venue.admission_fee.toLowerCase().includes('free') ||
                                venue.admission_fee.toLowerCase().includes('no charge') ||
                                venue.admission_fee.toLowerCase().includes('complimentary') ||
                                !venue.admission_fee || venue.admission_fee === '';
                } else if (feeFilter === 'paid') {
                    matchesFee = venue.admission_fee && 
                               !venue.admission_fee.toLowerCase().includes('free') &&
                               !venue.admission_fee.toLowerCase().includes('no charge') &&
                               !venue.admission_fee.toLowerCase().includes('complimentary') &&
                               venue.admission_fee !== '';
                }
                
                // Closure status filter logic
                let matchesClosure = true;
                if (closureFilter) {
                    try {
                        const additionalInfo = venue.additional_info ? JSON.parse(venue.additional_info) : {};
                        const venueClosureStatus = additionalInfo.closure_status || 'unknown';
                        matchesClosure = venueClosureStatus === closureFilter;
                    } catch (e) {
                        matchesClosure = closureFilter === 'unknown';
                    }
                }
                
                return matchesSearch && matchesType && matchesCity && matchesFee && matchesClosure;
            });
            
            // Apply sorting if specified
            if (sortBy) {
                window.filteredVenues.sort((a, b) => {
                    switch(sortBy) {
                        case 'name':
                            return (a.name || '').localeCompare(b.name || '');
                        case 'name_desc':
                            return (b.name || '').localeCompare(a.name || '');
                        case 'updated_at_desc':
                            return new Date(normalizeUTCTimestamp(b.updated_at || '') || 0) - new Date(normalizeUTCTimestamp(a.updated_at || '') || 0);
                        case 'updated_at':
                            return new Date(normalizeUTCTimestamp(a.updated_at || '') || 0) - new Date(normalizeUTCTimestamp(b.updated_at || '') || 0);
                        case 'created_at_desc':
                            return new Date(normalizeUTCTimestamp(b.created_at || '') || 0) - new Date(normalizeUTCTimestamp(a.created_at || '') || 0);
                        case 'created_at':
                            return new Date(normalizeUTCTimestamp(a.created_at || '') || 0) - new Date(normalizeUTCTimestamp(b.created_at || '') || 0);
                        case 'venue_type':
                            return (a.venue_type || '').localeCompare(b.venue_type || '');
                        case 'city_name':
                            return (a.city_name || '').localeCompare(b.city_name || '');
                        default:
                            return 0;
                    }
                });
            }
            
            renderVenuesTable();
        }
        
        function clearVenueFilters() {
            document.getElementById('venueSearch').value = '';
            document.getElementById('venueTypeFilter').value = '';
            document.getElementById('venueCityFilter').value = '';
            document.getElementById('venueFeeFilter').value = '';
            document.getElementById('venueClosureFilter').value = '';
            document.getElementById('venueSortBy').value = '';
            
            if (window.allVenues) {
                window.filteredVenues = [...window.allVenues];
                renderVenuesTable();
            }
        }
        
        function openAddVenueModal() {
            // Generate dynamic form fields
            generateDynamicVenueForm();
            
            // Populate city dropdown
            populateVenueCityDropdown();
            
            // Populate venue type dropdown
            populateVenueTypeDropdown();
            
            // Clear form
            document.getElementById('addVenueForm').reset();
            
            // Show modal
            document.getElementById('addVenueModal').style.display = 'block';
        }
        
        function generateDynamicVenueForm() {
            const container = document.getElementById('dynamicVenueFormFields');
            if (!container) return;
            
            // Define all venue fields with their properties
            const venueFields = [
                {
                    id: 'venueName',
                    name: 'name',
                    label: 'Venue Name',
                    type: 'text',
                    required: true,
                    placeholder: 'Enter venue name',
                    special: 'smart_search' // Special handling for smart search button
                },
                {
                    id: 'venueType',
                    name: 'venue_type',
                    label: 'Venue Type',
                    type: 'select',
                    required: true,
                    options: [
                        { value: '', text: 'Select Type' }
                        // Dynamic venue types will be loaded from backend
                    ],
                    special: 'venue_type_dropdown' // Special handling for dynamic venue types
                },
                {
                    id: 'venueCity',
                    name: 'city_id',
                    label: 'City',
                    type: 'select',
                    required: true,
                    options: [{ value: '', text: 'Select City' }],
                    special: 'city_dropdown' // Special handling for city population
                },
                {
                    id: 'venueAddress',
                    name: 'address',
                    label: 'Address',
                    type: 'text',
                    placeholder: 'Full street address'
                },
                {
                    id: 'venueLatitude',
                    name: 'latitude',
                    label: 'Latitude',
                    type: 'number',
                    step: '0.000001',
                    placeholder: 'e.g., 38.9072'
                },
                {
                    id: 'venueLongitude',
                    name: 'longitude',
                    label: 'Longitude',
                    type: 'number',
                    step: '0.000001',
                    placeholder: 'e.g., -77.0369'
                },
                {
                    id: 'venueImageUrl',
                    name: 'image_url',
                    label: 'Image URL',
                    type: 'url',
                    placeholder: 'https://example.com/image.jpg'
                },
                {
                    id: 'venueDescription',
                    name: 'description',
                    label: 'Description',
                    type: 'textarea',
                    rows: 3,
                    placeholder: 'Brief description of the venue...'
                },
                {
                    id: 'venueOpeningHours',
                    name: 'opening_hours',
                    label: 'Opening Hours',
                    type: 'text',
                    placeholder: 'e.g., Mon-Fri: 9AM-5PM, Sat-Sun: 10AM-6PM'
                },
                {
                    id: 'venueHolidayHours',
                    name: 'holiday_hours',
                    label: 'Holiday Hours',
                    type: 'text',
                    placeholder: 'e.g., Closed on Thanksgiving and Christmas'
                },
                {
                    id: 'venuePhone',
                    name: 'phone_number',
                    label: 'Phone Number',
                    type: 'tel',
                    placeholder: 'e.g., (202) 555-0123'
                },
                {
                    id: 'venueEmail',
                    name: 'email',
                    label: 'Email',
                    type: 'email',
                    placeholder: 'info@venue.com'
                },
                {
                    id: 'venueWebsite',
                    name: 'website_url',
                    label: 'Website URL',
                    type: 'url',
                    placeholder: 'https://www.venue.com'
                },
                {
                    id: 'venueAdmission',
                    name: 'admission_fee',
                    label: 'Admission Fee',
                    type: 'text',
                    placeholder: 'e.g., Free, $20, $15-25'
                },
                {
                    id: 'venueTourInfo',
                    name: 'tour_info',
                    label: 'Tour Information',
                    type: 'textarea',
                    rows: 2,
                    placeholder: 'Information about tours, guided visits, etc.'
                },
                {
                    id: 'venueInstagram',
                    name: 'instagram_url',
                    label: 'Instagram',
                    type: 'text',
                    placeholder: '@venuehandle'
                },
                {
                    id: 'venueFacebook',
                    name: 'facebook_url',
                    label: 'Facebook',
                    type: 'url',
                    placeholder: 'https://facebook.com/venue'
                },
                {
                    id: 'venueTwitter',
                    name: 'twitter_url',
                    label: 'Twitter',
                    type: 'text',
                    placeholder: '@venuehandle'
                },
                {
                    id: 'venueYoutube',
                    name: 'youtube_url',
                    label: 'YouTube',
                    type: 'url',
                    placeholder: 'https://youtube.com/c/venue'
                },
                {
                    id: 'venueTiktok',
                    name: 'tiktok_url',
                    label: 'TikTok',
                    type: 'text',
                    placeholder: '@venuehandle'
                },
                {
                    id: 'venueAdditionalInfo',
                    name: 'additional_info',
                    label: 'Additional Information',
                    type: 'textarea',
                    rows: 3,
                    placeholder: 'Additional details (JSON format)'
                }
            ];
            
            let formHTML = '';
            
            venueFields.forEach(field => {
                formHTML += '<div class="form-group">';
                formHTML += `<label for="${field.id}">${field.label}${field.required ? ' *' : ''}</label>`;
                
                if (field.special === 'smart_search') {
                    formHTML += '<div style="display: flex; gap: 10px;">';
                    formHTML += `<input type="${field.type}" id="${field.id}" name="${field.name}" ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}" style="flex: 1;">`;
                    formHTML += '<button type="button" id="smartSearchBtn" onclick="smartSearchVenue()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;"> Smart Search</button>';
                    formHTML += '</div>';
                } else if (field.type === 'select') {
                    formHTML += `<select id="${field.id}" name="${field.name}" ${field.required ? 'required' : ''}>`;
                    field.options.forEach(option => {
                        formHTML += `<option value="${option.value}">${option.text}</option>`;
                    });
                    formHTML += '</select>';
                } else if (field.type === 'textarea') {
                    formHTML += `<textarea id="${field.id}" name="${field.name}" rows="${field.rows || 3}" placeholder="${field.placeholder || ''}"></textarea>`;
                } else {
                    formHTML += `<input type="${field.type}" id="${field.id}" name="${field.name}" ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}" ${field.step ? `step="${field.step}"` : ''}>`;
                }
                
                formHTML += '</div>';
            });
            
            container.innerHTML = formHTML;
        }
        
        function populateVenueCityDropdown() {
            const citySelect = document.getElementById('venueCity');
            if (!citySelect) return;
            
            // If cities aren't loaded yet, try to load them first
            if (!window.allCities) {
                console.log('Cities not loaded yet, loading cities...');
                loadCities().then(() => {
                    populateVenueCityDropdown(); // Try again after loading
                }).catch(error => {
                    console.error('Failed to load cities:', error);
                    citySelect.innerHTML = '<option value="">Loading cities...</option>';
                });
                return;
            }
            
            citySelect.innerHTML = '<option value="">Select City</option>';
            window.allCities.forEach(city => {
                // Always include state/province if available, then country
                let displayName = city.name;
                if (city.state) {
                    displayName += `, ${city.state}`;
                }
                displayName += `, ${city.country}`;
                citySelect.innerHTML += `<option value="${city.id}">${displayName}</option>`;
            });
            
            console.log(`Populated city dropdown with ${window.allCities.length} cities`);
        }
        
        async function populateVenueTypeDropdown() {
            const typeSelect = document.getElementById('venueType');
            if (!typeSelect) return;
            
            try {
                console.log('Loading venue types...');
                const response = await fetch('/api/venue-types');
                const data = await response.json();
                
                if (data.venue_types) {
                    typeSelect.innerHTML = '<option value="">Select Type</option>';
                    data.venue_types.forEach(type => {
                        typeSelect.innerHTML += `<option value="${type.value}">${type.text}</option>`;
                    });
                    console.log(`Populated venue type dropdown with ${data.venue_types.length} types`);
                } else {
                    console.error('No venue types returned from API');
                }
            } catch (error) {
                console.error('Error loading venue types:', error);
                // Fallback to basic types
                typeSelect.innerHTML = `
                    <option value="">Select Type</option>
                    <option value="museum">Museum</option>
                    <option value="gallery">Gallery</option>
                    <option value="theater">Theater</option>
                    <option value="cafe">Cafe</option>
                    <option value="restaurant">Restaurant</option>
                    <option value="bookstore">Bookstore</option>
                    <option value="other">Other</option>
                `;
            }
        }
        
        async function smartSearchVenue() {
            const venueName = document.getElementById('venueName').value.trim();
            const cityId = document.getElementById('venueCity').value;
            
            if (!venueName) {
                alert('Please enter a venue name first');
                return;
            }
            
            if (!cityId) {
                alert('Please select a city first');
                return;
            }
            
            // Find city name from selected city ID
            const selectedCity = window.allCities.find(city => city.id == cityId);
            if (!selectedCity) {
                alert('Selected city not found');
                return;
            }
            
            const smartSearchBtn = document.getElementById('smartSearchBtn');
            const originalText = smartSearchBtn.textContent;
            smartSearchBtn.textContent = ' Searching...';
            smartSearchBtn.disabled = true;
            
            try {
                console.log('Starting smart search for:', venueName, 'in', selectedCity.name);
                
                const response = await fetch('/api/admin/smart-search-venue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        venue_name: venueName,
                        city_name: selectedCity.name,
                        city_id: parseInt(cityId)
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    console.log('Smart search successful:', result);
                    
                    // Populate form with AI-discovered details
                    populateFormWithVenueDetails(result.venue_details);
                    
                    alert('Venue details found and populated! Review and adjust as needed.');
                    
                } else {
                    console.error('Smart search failed:', result);
                    alert('Smart search failed: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error during smart search:', error);
                alert('Error during smart search: ' + error.message);
            } finally {
                smartSearchBtn.textContent = originalText;
                smartSearchBtn.disabled = false;
            }
        }
        
        function populateFormWithVenueDetails(venueDetails) {
            // Populate all form fields dynamically based on venue details
            const fieldMappings = {
                'name': 'venueName',
                'venue_type': 'venueType',
                'address': 'venueAddress',
                'latitude': 'venueLatitude',
                'longitude': 'venueLongitude',
                'image_url': 'venueImageUrl',
                'description': 'venueDescription',
                'opening_hours': 'venueOpeningHours',
                'holiday_hours': 'venueHolidayHours',
                'phone_number': 'venuePhone',
                'email': 'venueEmail',
                'website_url': 'venueWebsite',
                'admission_fee': 'venueAdmission',
                'tour_info': 'venueTourInfo',
                'instagram_url': 'venueInstagram',
                'facebook_url': 'venueFacebook',
                'twitter_url': 'venueTwitter',
                'youtube_url': 'venueYoutube',
                'tiktok_url': 'venueTiktok',
                'additional_info': 'venueAdditionalInfo'
            };
            
            // Populate each field if the data exists
            Object.entries(fieldMappings).forEach(([dataKey, fieldId]) => {
                const element = document.getElementById(fieldId);
                if (element && venueDetails[dataKey]) {
                    if (element.tagName === 'TEXTAREA' && typeof venueDetails[dataKey] === 'object') {
                        // Handle JSON objects for additional_info
                        element.value = JSON.stringify(venueDetails[dataKey], null, 2);
                    } else {
                        element.value = venueDetails[dataKey];
                    }
                }
            });
        }
        
        async function manageJsonCopy() {
            const action = confirm('JSON Management\n\n' +
                'Click OK to create a fresh venues.json from predefined_venues.json\n' +
                'Click Cancel to apply venues.json changes back to original\n\n' +
                'This allows safe editing without affecting the original file.');
            
            try {
                let endpoint, message;
                
                if (action) {
                    // Create venues.json
                    endpoint = '/api/admin/create-json-copy';
                    message = 'Creating fresh venues.json...';
                } else {
                    // Apply venues.json to original
                    endpoint = '/api/admin/apply-json-copy';
                    message = 'Applying venues.json changes to original file...';
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message || message);
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error managing JSON copy:', error);
                alert('Error managing JSON copy: ' + error.message);
            }
        }
        
        async function exportVenuesFromDatabase() {
            const confirmed = confirm('Export Venues from Database\n\n' +
                'This will download all venues from the database as a JSON file.\n' +
                'Useful for production environments or creating backups.\n\n' +
                'Continue?');
            
            if (!confirmed) return;
            
            try {
                console.log('Starting venues export...');
                
                const response = await fetch('/api/admin/export-venues', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    // Get the filename from the response headers
                    const contentDisposition = response.headers.get('Content-Disposition');
                    const filename = contentDisposition ? 
                        contentDisposition.split('filename=')[1].replace(/"/g, '') : 
                        'venues_exported.json';
                    
                    // Create blob and download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert(' Export successful! File downloaded.');
                } else {
                    const result = await response.json();
                    alert(' Export failed: ' + result.error);
                }
                
            } catch (error) {
                console.error('Export error:', error);
                alert(' Export error: ' + error.message);
            }
        }

        async function exportCitiesFromDatabase() {
            const confirmed = confirm('Export Cities from Database\n\n' +
                'This will download all cities from the database as a JSON file.\n' +
                'Matches the cities.json format for easy replacement.\n\n' +
                'Continue?');
            
            if (!confirmed) return;
            
            try {
                console.log('Starting cities export...');
                
                const response = await fetch('/api/admin/export-cities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    // Get the filename from the response headers
                    const contentDisposition = response.headers.get('Content-Disposition');
                    const filename = contentDisposition ? 
                        contentDisposition.split('filename=')[1].replace(/"/g, '') : 
                        'cities_exported.json';
                    
                    // Create blob and download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert(' Export successful! File downloaded.');
                } else {
                    const result = await response.json();
                    alert(' Export failed: ' + result.error);
                }
                
            } catch (error) {
                console.error('Export error:', error);
                alert(' Export error: ' + error.message);
            }
        }

        async function exportSourcesFromDatabase() {
            const confirmed = confirm('Export Sources from Database\n\n' +
                'This will download all sources from the database as a JSON file.\n' +
                'Matches the sources.json format for easy replacement.\n\n' +
                'Continue?');
            
            if (!confirmed) return;
            
            try {
                console.log('Starting sources export...');
                
                const response = await fetch('/api/admin/export-sources', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    // Get the filename from the response headers
                    const contentDisposition = response.headers.get('Content-Disposition');
                    const filename = contentDisposition ? 
                        contentDisposition.split('filename=')[1].replace(/"/g, '') : 
                        'sources_exported.json';
                    
                    // Create blob and download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert(' Export successful! File downloaded.');
                } else {
                    const result = await response.json();
                    alert(' Export failed: ' + result.error);
                }
                
            } catch (error) {
                console.error('Export error:', error);
                alert(' Export error: ' + error.message);
            }
        }
        
        function editVenue(id) {
            // Find the venue data
            const venue = window.allVenues.find(v => v.id == id);
            if (!venue) {
                alert('Venue not found');
                return;
            }
            
            // Populate the edit form with current venue data
            document.getElementById('editVenueId').value = venue.id;
            document.getElementById('editVenueName').value = venue.name || '';
            document.getElementById('editVenueType').value = venue.venue_type || '';
            document.getElementById('editVenueAddress').value = venue.address || '';
            document.getElementById('editVenueDescription').value = venue.description || '';
            document.getElementById('editVenueHours').value = venue.opening_hours || '';
            document.getElementById('editVenuePhone').value = venue.phone_number || '';
            document.getElementById('editVenueEmail').value = venue.email || '';
            document.getElementById('editVenueWebsite').value = venue.website_url || '';
            document.getElementById('editVenueAdmission').value = venue.admission_fee || '';
            
            // Show the modal
            document.getElementById('editVenueModal').style.display = 'block';
        }
        
        function deleteVenue(id) {
            if (confirm('Are you sure you want to delete this venue? This will also delete all associated events.')) {
                fetch(`/api/delete-venue/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Venue deleted successfully!');
                        loadVenues(); // Reload data
                    } else {
                        alert('Error: ' + result.error);
                    }
                })
                .catch(error => {
                    alert('Error deleting venue: ' + error.message);
                });
            }
        }
        
        // Load events data
        async function loadEvents() {
            try {
                // Load cities first if not already loaded (needed for city filter)
                if (!window.allCities || window.allCities.length === 0) {
                    console.log('Loading cities first for event filter...');
                    try {
                        const citiesResponse = await fetch('/api/admin/cities');
                        const cities = await citiesResponse.json();
                        if (!cities.error) {
                            window.allCities = cities;
                            console.log('Cities loaded for filter:', cities.length);
                        }
                    } catch (citiesError) {
                        console.warn('Could not load cities for filter:', citiesError);
                    }
                }
                
                console.log('Loading events...');
                const response = await fetch('/api/admin/events');
                const events = await response.json();
                
                if (events.error) throw new Error(events.error);
                
                console.log('Events loaded:', events.length);
                
                // Store events globally for filtering
                window.allEvents = events;
                window.filteredEvents = [...events];
                
                // Render the events table
                renderEventsTable();
                populateEventFilters();
                
            } catch (error) {
                console.error('Error loading events:', error);
                const eventsTable = document.getElementById('eventsTable');
                if (eventsTable) {
                    eventsTable.innerHTML = '<tr><td colspan="12" class="no-results"> Failed to load events: ' + error.message + '</td></tr>';
                }
            }
        }
        
        function renderEventsTable() {
            const data = window.filteredEvents || window.allEvents || [];
            // Ensure the section is visible before rendering
            const eventsSection = document.getElementById('events');
            if (!eventsSection) {
                console.warn('Events section not found, skipping render');
                return;
            }
            
            // Check if section is visible - use class check instead of getComputedStyle (faster, no reflow)
            if (!eventsSection.classList.contains('active')) {
                return;
            }
            
            // Defer heavy table rendering to next frame to keep UI responsive
            requestAnimationFrame(() => {
                // Ensure the table container is visible before rendering
                const tableContainer = eventsSection.querySelector('.table-container');
                if (tableContainer) {
                    tableContainer.style.display = 'block';
                    tableContainer.style.visibility = 'visible';
                    tableContainer.style.minHeight = '400px';
                    tableContainer.style.height = 'auto';
                }
                renderDynamicTable('eventsTable', data, 'events');
                // Update bulk export button state after rendering
                updateBulkExportButton();
                // Reset select all checkbox
                const selectAllCheckbox = document.getElementById('selectAllEvents');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }
            });
            // Update bulk export button state after rendering
            updateBulkExportButton();
            // Reset select all checkbox
            const selectAllCheckbox = document.getElementById('selectAllEvents');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
        }
        
        function toggleExhibitionFields() {
            const eventType = document.getElementById('editEventType').value;
            const exhibitionFields = document.getElementById('editExhibitionFields');
            if (eventType === 'exhibition') {
                exhibitionFields.style.display = 'block';
            } else {
                exhibitionFields.style.display = 'none';
            }
        }
        
        function editEvent(id) {
            // Find the event data
            const event = window.allEvents.find(e => e.id == id);
            if (!event) {
                alert('Event not found');
                return;
            }
            
            // Populate the edit form with current event data
            document.getElementById('editEventId').value = event.id;
            document.getElementById('editEventTitle').value = event.title || '';
            document.getElementById('editEventDescription').value = event.description || '';
            document.getElementById('editEventStartDate').value = event.start_date || '';
            document.getElementById('editEventStartTime').value = event.start_time || '';
            document.getElementById('editEventEndTime').value = event.end_time || '';
            document.getElementById('editEventType').value = event.event_type || '';
            
            // Show/hide exhibition fields based on event type
            const exhibitionFields = document.getElementById('editExhibitionFields');
            if (event.event_type === 'exhibition') {
                exhibitionFields.style.display = 'block';
                // Populate exhibition-specific fields
                document.getElementById('editExhibitionLocation').value = event.exhibition_location || '';
                document.getElementById('editCurator').value = event.curator || '';
                document.getElementById('editAdmissionPrice').value = event.admission_price || '';
                document.getElementById('editArtists').value = event.artists || '';
                document.getElementById('editExhibitionType').value = event.exhibition_type || '';
                document.getElementById('editCollectionPeriod').value = event.collection_period || '';
                document.getElementById('editNumberOfArtworks').value = event.number_of_artworks || '';
                document.getElementById('editOpeningReceptionDate').value = event.opening_reception_date || '';
                document.getElementById('editOpeningReceptionTime').value = event.opening_reception_time || '';
                document.getElementById('editIsPermanent').checked = event.is_permanent || false;
                document.getElementById('editRelatedExhibitions').value = event.related_exhibitions || '';
            } else {
                exhibitionFields.style.display = 'none';
            }
            
            // Show the modal
            document.getElementById('editEventModal').style.display = 'block';
        }
        
        async function addEventToCalendar(eventId) {
            try {
                // Find the event data
                const event = window.allEvents.find(e => e.id == eventId);
                if (!event) {
                    alert('Event not found');
                    return;
                }
                
                // Use unified module to get calendar location
                const calendarLocation = CalendarExport.getCalendarLocation(event);
                
                // Prepare calendar event data
                const calendarData = {
                    title: event.title,
                    description: event.description || '',
                    start_date: event.start_date,
                    end_date: event.end_date || event.start_date,
                    start_time: event.start_time,
                    end_time: event.end_time,
                    location: calendarLocation,
                    event_type: event.event_type,
                    city_id: event.city_id,  // Include city_id for timezone lookup
                    // Enhanced fields for better calendar integration
                    start_location: event.start_location,
                    end_location: event.end_location,
                    venue_address: event.venue_address,
                    venue_name: event.venue_name,
                    city_name: event.city_name,
                    social_media_platform: event.social_media_platform,
                    social_media_handle: event.social_media_handle,
                    social_media_page_name: event.social_media_page_name,
                    social_media_posted_by: event.social_media_posted_by,
                    social_media_url: event.social_media_url,
                    url: event.url,
                    source: event.source,
                    source_url: event.source_url,
                    organizer: event.organizer,
                    price: event.price,
                    // Legacy Instagram fields for backward compatibility
                    instagram_handle: event.instagram_handle
                };
                
                // Call the calendar API
                const response = await fetch('/api/calendar/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(calendarData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Show options dialog for calendar integration
                    const options = [
                        ' Download .ics File (Recommended)',
                        ' Open in Calendar App',
                        ' Cancel'
                    ];
                    
                    const choice = prompt(`Choose how to add "${event.title}" to your calendar:\n\n1. ${options[0]}\n2. ${options[1]}\n3. ${options[2]}\n\nEnter 1, 2, or 3:`, '1');
                    
                    if (choice === '1') {
                        // Download iCal file (recommended - works correctly)
                        const icalContent = result.ical_content;
                        const blob = new Blob([icalContent], { type: 'text/calendar' });
                        const url = window.URL.createObjectURL(blob);
                        
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `${event.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.ics`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                        
                        alert(' Event downloaded as .ics file! Open it to add to your calendar.');
                    } else if (choice === '2') {
                        // Open calendar app (may have timezone issues)
                        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                        
                        if (isMobile) {
                            const mobileCalendarUrl = generateMobileCalendarUrl(calendarData);
                            if (mobileCalendarUrl) {
                                window.location.href = mobileCalendarUrl;
                                alert(' Opening in your calendar app...');
                            } else {
                                const calendarUrl = generateCalendarUrl(calendarData);
                                window.open(calendarUrl, '_blank');
                                alert(' Event opened in Google Calendar!');
                            }
                        } else {
                            const calendarUrl = generateCalendarUrl(calendarData);
                            if (calendarUrl) {
                                window.open(calendarUrl, '_blank');
                                alert(' Event opened in Google Calendar!');
                            } else {
                                alert(' Could not generate calendar URL');
                            }
                        }
                    }
                    // If choice is '3' or anything else, do nothing (cancelled)
                } else {
                    const error = await response.json();
                    alert(' Failed to add event to calendar: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding event to calendar:', error);
                alert(' Error adding event to calendar: ' + error.message);
            }
        }
        
        // Generate mobile calendar URL (using unified module)
        function generateMobileCalendarUrl(eventData) {
            // Use unified module to parse dates and generate URL
            const { startDate, endDate, isAllDay } = CalendarExport.parseEventDates(eventData);
            const calendarUrl = CalendarExport.generateGoogleCalendarUrl(eventData, startDate, endDate, isAllDay);
            
            // Detect iOS vs Android
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            if (isIOS) {
                return calendarUrl.replace('https://', 'webcal://');
            } else if (isAndroid) {
                return calendarUrl;
            }
            
            return null; // Not mobile or unsupported
        }
        
        // Generate calendar URL (using unified module)
        function generateCalendarUrl(eventData) {
            const { startDate, endDate, isAllDay } = CalendarExport.parseEventDates(eventData);
            return CalendarExport.generateGoogleCalendarUrl(eventData, startDate, endDate, isAllDay);
        }
        
        // Calendar export functions now use the unified CalendarExport module
        // Helper functions are available via CalendarExport.* if needed
        
        // Multi-select and bulk export functions
        function toggleSelectAllEvents(checkbox) {
            const eventCheckboxes = document.querySelectorAll('.event-checkbox');
            eventCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateBulkExportButton();
        }
        
        async function deleteSelectedEvents() {
            const selectedCheckboxes = document.querySelectorAll('.event-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one event to delete.');
                return;
            }
            
            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            const events = window.allEvents.filter(e => selectedIds.includes(e.id));
            
            if (events.length === 0) {
                alert('No events found for selected IDs.');
                return;
            }
            
            // Show confirmation dialog
            const eventTitles = events.map(e => `   ${e.title}`).join('\n');
            const confirmed = confirm(
                `Are you sure you want to delete ${events.length} event(s)?\n\n` +
                `${eventTitles}\n\n` +
                `This action cannot be undone.`
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                // Delete each event
                let deletedCount = 0;
                let failedCount = 0;
                
                for (const eventId of selectedIds) {
                    try {
                        const response = await fetch(`/api/delete-event/${eventId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            deletedCount++;
                        } else {
                            const result = await response.json();
                            console.error(`Failed to delete event ${eventId}:`, result.error);
                            failedCount++;
                        }
                    } catch (error) {
                        console.error(`Error deleting event ${eventId}:`, error);
                        failedCount++;
                    }
                }
                
                // Show result
                if (failedCount === 0) {
                    alert(` Successfully deleted ${deletedCount} event(s)!`);
                } else {
                    alert(` Deleted ${deletedCount} event(s), but ${failedCount} failed. Check console for details.`);
                }
                
                // Reload events
                loadEvents();
                
            } catch (error) {
                console.error('Error deleting events:', error);
                alert(' Error deleting events: ' + error.message);
            }
        }
        
        function updateBulkExportButton() {
            const selectedCount = document.querySelectorAll('.event-checkbox:checked').length;
            const bulkExportBtn = document.getElementById('bulkExportBtn');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            
            if (bulkExportBtn) {
                bulkExportBtn.disabled = selectedCount === 0;
                if (selectedCount > 0) {
                    bulkExportBtn.textContent = ` Export ${selectedCount} Selected to Calendar`;
                } else {
                    bulkExportBtn.textContent = ' Export Selected to Calendar';
                }
            }
            
            if (bulkDeleteBtn) {
                bulkDeleteBtn.disabled = selectedCount === 0;
                if (selectedCount > 0) {
                    bulkDeleteBtn.textContent = ` Delete ${selectedCount} Selected`;
                } else {
                    bulkDeleteBtn.textContent = ' Delete Selected';
                }
            }
        }
        
        async function exportSelectedEventsToCalendar() {
            const selectedCheckboxes = document.querySelectorAll('.event-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one event to export.');
                return;
            }
            
            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            const events = window.allEvents.filter(e => selectedIds.includes(e.id));
            
            if (events.length === 0) {
                alert('No events found for selected IDs.');
                return;
            }
            
            // For single event, use the existing single event export
            if (events.length === 1) {
                addEventToCalendar(events[0].id);
                return;
            }
            
            // For multiple events, generate ICS file and open Google Calendar import page
            const icsContent = generateICSForEvents(events);
            
            // Download the ICS file
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `events_${new Date().toISOString().split('T')[0]}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            // Open Google Calendar import page
            setTimeout(() => {
                window.open('https://calendar.google.com/calendar/u/0/r/settings/export', '_blank');
                alert(` Downloaded ${events.length} events as .ics file!\n\nNext steps:\n1. Go to Google Calendar (opened in new tab)\n2. Click "Import" in the left sidebar\n3. Select the downloaded .ics file\n4. Choose which calendar to import to\n5. Click "Import"`);
            }, 500);
        }
        
        // Generate ICS for multiple events (using unified module)
        function generateICSForEvents(events) {
            return CalendarExport.generateICS(events, 'Planner Events');
        }
        
        // Generate ICS for single event (using unified module)
        // Generate ICS for single event (using unified module)
        function generateICSEvent(event) {
            return CalendarExport.generateICSEvent(event);
        }
        
        function generateCalendarUrlForEvent(event) {
            // Prepare event data in the format expected by generateCalendarUrl
            const eventData = {
                title: event.title || '',
                description: event.description || '',
                start_date: event.start_date || '',
                end_date: event.end_date || event.start_date || '',
                start_time: event.start_time || '',
                end_time: event.end_time || '',
                start_location: event.start_location || '',
                venue_name: event.venue_name || '',
                venue_address: event.venue_address || '',
                city_name: event.city_name || '',
                url: event.url || '',
                event_type: event.event_type || '',
                city_timezone: event.city_timezone || 'America/New_York'
            };
            
            return generateCalendarUrl(eventData);
        }
        
        function deleteEvent(id) {
            if (confirm('Are you sure you want to delete this event?')) {
                fetch(`/api/delete-event/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Event deleted successfully!');
                        loadEvents(); // Reload data
                    } else {
                        alert('Error: ' + result.error);
                    }
                })
                .catch(error => {
                    alert('Error deleting event: ' + error.message);
                });
            }
        }
        
        // Event filter functions
        function applyEventFilters() {
            if (!window.allEvents) return;
            
            const searchTerm = document.getElementById('eventSearch').value.toLowerCase();
            const typeFilter = document.getElementById('eventTypeFilter').value;
            const cityFilter = document.getElementById('eventCityFilter').value;
            const venueFilter = document.getElementById('eventVenueFilter').value;
            
            window.filteredEvents = window.allEvents.filter(event => {
                const matchesSearch = !searchTerm || 
                    event.title.toLowerCase().includes(searchTerm) ||
                    (event.event_type && event.event_type.toLowerCase().includes(searchTerm)) ||
                    (event.description && event.description.toLowerCase().includes(searchTerm));
                
                const matchesType = !typeFilter || event.event_type === typeFilter;
                const matchesCity = !cityFilter || 
                    (event.city_id && String(event.city_id) === cityFilter) ||
                    (event.city_name && event.city_name.toLowerCase() === cityFilter.toLowerCase());
                const matchesVenue = !venueFilter || event.venue_name === venueFilter;
                
                return matchesSearch && matchesType && matchesCity && matchesVenue;
            });
            
            // Update filter summary
            const summary = document.getElementById('eventFilterSummary');
            const activeFilters = [];
            if (searchTerm) activeFilters.push(`Search: "${searchTerm}"`);
            if (typeFilter) activeFilters.push(`Type: ${typeFilter}`);
            if (cityFilter) {
                const citySelect = document.getElementById('eventCityFilter');
                const selectedCity = citySelect.options[citySelect.selectedIndex];
                activeFilters.push(`City: ${selectedCity.text}`);
            }
            if (venueFilter) activeFilters.push(`Venue: ${venueFilter}`);
            
            if (activeFilters.length > 0) {
                summary.textContent = `Active filters: ${activeFilters.join('  ')} | Showing ${window.filteredEvents.length} of ${window.allEvents.length} events`;
                summary.classList.add('active');
            } else {
                summary.textContent = '';
                summary.classList.remove('active');
            }
            
            renderEventsTable();
        }
        
        function clearEventFilters() {
            document.getElementById('eventSearch').value = '';
            document.getElementById('eventTypeFilter').value = '';
            document.getElementById('eventCityFilter').value = '';
            document.getElementById('eventVenueFilter').value = '';
            
            if (window.allEvents) {
                window.filteredEvents = [...window.allEvents];
                renderEventsTable();
            }
        }
        
        function openAddEventModal() {
            alert('Add Event functionality will be implemented here');
        }
        
        // Populate event filters
        function populateEventFilters() {
            const typeFilter = document.getElementById('eventTypeFilter');
            const cityFilter = document.getElementById('eventCityFilter');
            const venueFilter = document.getElementById('eventVenueFilter');
            
            if (!typeFilter || !cityFilter || !venueFilter || !window.allEvents) return;
            
            const types = [...new Set(window.allEvents.map(event => event.event_type).filter(Boolean))].sort();
            const cities = [...new Set(window.allEvents.map(event => {
                // Use city_id if available, otherwise use city_name
                return event.city_id ? String(event.city_id) : (event.city_name || '');
            }).filter(Boolean))].sort();
            const venues = [...new Set(window.allEvents.map(event => event.venue_name).filter(Boolean))].sort();
            
            typeFilter.innerHTML = '<option value="">All Types</option>';
            types.forEach(type => {
                typeFilter.innerHTML += '<option value="' + type + '">' + type + '</option>';
            });
            
            cityFilter.innerHTML = '<option value="">All Cities</option>';
            // Populate cities from window.allCities if available, otherwise use city names from events
            if (window.allCities && window.allCities.length > 0) {
                window.allCities.forEach(city => {
                    cityFilter.innerHTML += '<option value="' + city.id + '">' + city.name + (city.state ? ', ' + city.state : '') + '</option>';
                });
            } else {
                // Fallback: use city names from events
                const cityNames = [...new Set(window.allEvents.map(event => event.city_name).filter(Boolean))].sort();
                cityNames.forEach(cityName => {
                    cityFilter.innerHTML += '<option value="' + cityName + '">' + cityName + '</option>';
                });
            }
            
            venueFilter.innerHTML = '<option value="">All Venues</option>';
            venues.forEach(venue => {
                venueFilter.innerHTML += '<option value="' + venue + '">' + venue + '</option>';
            });
        }
        
        // Suppress browser extension errors (they're not our problem)
        window.addEventListener('error', function(event) {
            // Ignore errors from browser extensions
            if (event.message && (
                event.message.includes('message channel closed') ||
                event.message.includes('Extension context invalidated') ||
                event.message.includes('Receiving end does not exist')
            )) {
                event.preventDefault();
                return false;
            }
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            // Ignore promise rejections from browser extensions
            if (event.reason && (
                event.reason.message && (
                    event.reason.message.includes('message channel closed') ||
                    event.reason.message.includes('Extension context invalidated') ||
                    event.reason.message.includes('Receiving end does not exist')
                )
            )) {
                event.preventDefault();
                return false;
            }
        });
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, calling loadOverview...');
            loadOverviewWithTimeout();
            
            // Also load cities so they're available for venue dropdown and event filters
            console.log('Loading cities for venue dropdown and event filters...');
            loadCities().then(() => {
                // Repopulate event filters after cities are loaded
                if (window.allEvents) {
                    populateEventFilters();
                }
                // All city dropdowns are populated by loadCities() -> populateAllCityDropdowns()
            });
            
            // Setup forms
            console.log('Setting up forms...');
            setupImageUploadForm();
            setupUrlScraperForm();
            
            // Add form submission handlers
            const addCityForm = document.getElementById('addCityForm');
            if (addCityForm) {
                addCityForm.addEventListener('submit', handleAddCity);
            }
            
            const addVenueForm = document.getElementById('addVenueForm');
            if (addVenueForm) {
                addVenueForm.addEventListener('submit', handleAddVenue);
            }
            
            // Add edit form submission handlers
            const editCityForm = document.getElementById('editCityForm');
            if (editCityForm) {
                editCityForm.addEventListener('submit', handleEditCity);
            }
            
            const editVenueForm = document.getElementById('editVenueForm');
            if (editVenueForm) {
                editVenueForm.addEventListener('submit', handleEditVenue);
            }
            
            const editEventForm = document.getElementById('editEventForm');
            if (editEventForm) {
                editEventForm.addEventListener('submit', handleEditEvent);
            }
            
            // Add search input event listeners for real-time filtering
            const citySearch = document.getElementById('citySearch');
            if (citySearch) {
                citySearch.addEventListener('input', applyCityFilters);
            }
            
            const venueSearch = document.getElementById('venueSearch');
            if (venueSearch) {
                venueSearch.addEventListener('input', applyVenueFilters);
            }
            
            const eventSearch = document.getElementById('eventSearch');
            if (eventSearch) {
                eventSearch.addEventListener('input', applyEventFilters);
            }
            
            // Add filter dropdown event listeners for real-time filtering
            const cityCountryFilter = document.getElementById('cityCountryFilter');
            if (cityCountryFilter) {
                cityCountryFilter.addEventListener('change', applyCityFilters);
            }
            
            const venueTypeFilter = document.getElementById('venueTypeFilter');
            if (venueTypeFilter) {
                venueTypeFilter.addEventListener('change', applyVenueFilters);
            }
            
            const venueCityFilter = document.getElementById('venueCityFilter');
            if (venueCityFilter) {
                venueCityFilter.addEventListener('change', applyVenueFilters);
            }
            
            const venueFeeFilter = document.getElementById('venueFeeFilter');
            if (venueFeeFilter) {
                venueFeeFilter.addEventListener('change', applyVenueFilters);
            }
            
            const venueClosureFilter = document.getElementById('venueClosureFilter');
            if (venueClosureFilter) {
                venueClosureFilter.addEventListener('change', applyVenueFilters);
            }
            
            const venueSortBy = document.getElementById('venueSortBy');
            if (venueSortBy) {
                venueSortBy.addEventListener('change', applyVenueFilters);
            }
            
            const eventTypeFilter = document.getElementById('eventTypeFilter');
            if (eventTypeFilter) {
                eventTypeFilter.addEventListener('change', applyEventFilters);
            }
            
            const eventVenueFilter = document.getElementById('eventVenueFilter');
            if (eventVenueFilter) {
                eventVenueFilter.addEventListener('change', applyEventFilters);
            }
            
            // Add source filter event listeners for real-time filtering
            const sourceSearch = document.getElementById('sourceSearch');
            if (sourceSearch) {
                sourceSearch.addEventListener('input', applySourceFilters);
            }
            
            const sourceTypeFilter = document.getElementById('sourceTypeFilter');
            if (sourceTypeFilter) {
                sourceTypeFilter.addEventListener('change', applySourceFilters);
            }
            
            const sourceCityFilter = document.getElementById('sourceCityFilter');
            if (sourceCityFilter) {
                sourceCityFilter.addEventListener('change', applySourceFilters);
            }
        });
        
        // Handle add city form submission
        async function handleAddCity(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('cityName').value.trim(),
                state: document.getElementById('cityState').value.trim(),
                country: document.getElementById('cityCountry').value.trim(),
                timezone: document.getElementById('cityTimezone').value.trim()
            };
            
            // Validate required fields
            if (!formData.name || !formData.country) {
                alert('City name and country are required');
                return;
            }
            
            try {
                console.log('Adding city:', formData);
                
                const response = await fetch('/api/admin/add-city', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('City added successfully:', result);
                    alert('City added successfully!');
                    
                    // Close modal
                    closeModal('addCityModal');
                    
                    // Reload cities data
                    await loadCities();
                    
                } else {
                    console.error('Error adding city:', result);
                    alert('Error adding city: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error adding city:', error);
                alert('Error adding city: ' + error.message);
            }
        }
        
        // Handle add venue form submission
        async function handleAddVenue(event) {
            event.preventDefault();
            
            // Collect all form data dynamically
            const formData = {};
            const form = document.getElementById('addVenueForm');
            const formElements = form.querySelectorAll('input, select, textarea');
            
            formElements.forEach(element => {
                if (element.name && element.id) {
                    let value = element.value.trim();
                    
                    // Handle number fields
                    if (element.type === 'number' && value) {
                        value = parseFloat(value);
                    }
                    
                    // Handle city_id specifically
                    if (element.name === 'city_id' && value) {
                        value = parseInt(value);
                    }
                    
                    // Only include non-empty values
                    if (value !== '' && value !== null && value !== undefined) {
                        formData[element.name] = value;
                    }
                }
            });
            
            // Validate required fields
            if (!formData.name || !formData.venue_type || !formData.city_id) {
                alert('Venue name, type, and city are required');
                return;
            }
            
            try {
                console.log('Adding venue:', formData);
                
                const response = await fetch('/api/admin/add-venue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    console.log('Venue added successfully:', result);
                    alert('Venue added successfully!');
                    
                    // Close modal
                    closeModal('addVenueModal');
                    
                    // Reload venues data
                    await loadVenues();
                    
                } else {
                    console.error('Error adding venue:', result);
                    alert('Error adding venue: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error adding venue:', error);
                alert('Error adding venue: ' + error.message);
            }
        }
        
        // Handle edit form submissions
        async function handleEditCity(event) {
            event.preventDefault();
            
            const editData = {
                id: parseInt(document.getElementById('editCityId').value),
                name: document.getElementById('editCityName').value.trim(),
                state: document.getElementById('editCityState').value.trim(),
                country: document.getElementById('editCityCountry').value.trim(),
                timezone: document.getElementById('editCityTimezone').value.trim()
            };
            
            try {
                const response = await fetch('/api/admin/edit-city', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(editData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('City updated successfully!');
                    closeModal('editCityModal');
                    loadCities();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating city: ' + error.message);
            }
        }
        
        async function handleEditVenue(event) {
            event.preventDefault();
            
            const editData = {
                id: parseInt(document.getElementById('editVenueId').value),
                name: document.getElementById('editVenueName').value.trim(),
                venue_type: document.getElementById('editVenueType').value.trim(),
                address: document.getElementById('editVenueAddress').value.trim(),
                description: document.getElementById('editVenueDescription').value.trim(),
                opening_hours: document.getElementById('editVenueHours').value.trim(),
                phone_number: document.getElementById('editVenuePhone').value.trim(),
                email: document.getElementById('editVenueEmail').value.trim(),
                website_url: document.getElementById('editVenueWebsite').value.trim(),
                admission_fee: document.getElementById('editVenueAdmission').value.trim()
            };
            
            try {
                const response = await fetch('/api/admin/edit-venue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(editData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Venue updated successfully!');
                    closeModal('editVenueModal');
                    loadVenues();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating venue: ' + error.message);
            }
        }
        
        async function handleEditEvent(event) {
            event.preventDefault();
            
            const editData = {
                id: parseInt(document.getElementById('editEventId').value),
                title: document.getElementById('editEventTitle').value.trim(),
                description: document.getElementById('editEventDescription').value.trim(),
                start_date: document.getElementById('editEventStartDate').value,
                start_time: document.getElementById('editEventStartTime').value,
                end_time: document.getElementById('editEventEndTime').value,
                event_type: document.getElementById('editEventType').value.trim()
            };
            
            // Add exhibition-specific fields if event type is 'exhibition'
            if (editData.event_type === 'exhibition') {
                editData.exhibition_location = document.getElementById('editExhibitionLocation').value.trim();
                editData.curator = document.getElementById('editCurator').value.trim();
                const admissionPrice = document.getElementById('editAdmissionPrice').value;
                editData.admission_price = admissionPrice ? parseFloat(admissionPrice) : null;
                editData.artists = document.getElementById('editArtists').value.trim();
                editData.exhibition_type = document.getElementById('editExhibitionType').value.trim();
                editData.collection_period = document.getElementById('editCollectionPeriod').value.trim();
                const numArtworks = document.getElementById('editNumberOfArtworks').value;
                editData.number_of_artworks = numArtworks ? parseInt(numArtworks) : null;
                editData.opening_reception_date = document.getElementById('editOpeningReceptionDate').value || null;
                editData.opening_reception_time = document.getElementById('editOpeningReceptionTime').value || null;
                editData.is_permanent = document.getElementById('editIsPermanent').checked;
                editData.related_exhibitions = document.getElementById('editRelatedExhibitions').value.trim();
            }
            
            try {
                const response = await fetch('/api/admin/edit-event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(editData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Event updated successfully!');
                    closeModal('editEventModal');
                    loadEvents();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating event: ' + error.message);
            }
        }
        
        // Source Management Functions
        // Note: allSources is stored in window.allSources (no local declaration)
        
        async function loadSources() {
            try {
                console.log('Loading sources...');
                const response = await fetch('/api/admin/sources');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to load sources: ${response.status} ${errorText}`);
                }
                
                const data = await response.json();
                
                // Check if response has error property
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Handle both array and object with sources property
                window.allSources = Array.isArray(data) ? data : (data.sources || []);
                window.filteredSources = null; // Reset filters
                
                console.log('Sources loaded:', window.allSources.length);
                
                if (window.allSources.length === 0) {
                    console.warn('No sources found in database');
                }
                
                populateSourceFilters();
                
                // Update filter summary
                const summary = document.getElementById('sourceFilterSummary');
                if (summary) {
                    summary.textContent = `Showing all ${window.allSources.length} sources`;
                }
                
                // Only render if section is active (will be rendered by showSection if needed)
                const sourcesSection = document.getElementById('sources');
                if (sourcesSection && sourcesSection.classList.contains('active')) {
                    renderSourcesTable();
                }
                
            } catch (error) {
                console.error('Error loading sources:', error);
                const tableBody = document.getElementById('sourcesTable');
                if (tableBody) {
                    tableBody.innerHTML = `<tr><td colspan="8" class="loading" style="color: #dc3545;"> Error loading sources: ${error.message}</td></tr>`;
                }
            }
        }
        
        function renderSourcesTable() {
            const data = window.filteredSources || window.allSources || [];
            // Ensure the section is visible before rendering
            const sourcesSection = document.getElementById('sources');
            if (!sourcesSection) {
                console.warn('Sources section not found, skipping render');
                return;
            }
            
            // Check if section is visible - use class check instead of getComputedStyle (faster, no reflow)
            if (!sourcesSection.classList.contains('active')) {
                return;
            }
            
            // Defer heavy table rendering to next frame to keep UI responsive
            requestAnimationFrame(() => {
                // Ensure the table container is visible before rendering
                const tableContainer = sourcesSection.querySelector('.table-container');
                if (tableContainer) {
                    tableContainer.style.display = 'block';
                    tableContainer.style.visibility = 'visible';
                    tableContainer.style.minHeight = '400px';
                    tableContainer.style.height = 'auto';
                }
                renderDynamicTable('sourcesTable', data, 'sources');
            });
        }
        
        function editSource(id) {
            const source = window.allSources.find(s => s.id == id);
            if (!source) {
                alert('Source not found');
                return;
            }
            
            // Populate edit form
            document.getElementById('editSourceId').value = source.id;
            document.getElementById('editSourceName').value = source.name;
            document.getElementById('editSourceHandle').value = source.handle;
            document.getElementById('editSourceType').value = source.source_type;
            document.getElementById('editSourceCity').value = source.city_id;
            document.getElementById('editSourceUrl').value = source.url || '';
            document.getElementById('editSourceDescription').value = source.description || '';
            document.getElementById('editSourceReliability').value = source.reliability_score || 5;
            document.getElementById('editSourceFrequency').value = source.posting_frequency || '';
            document.getElementById('editSourceEventTypes').value = source.event_types ? JSON.parse(source.event_types).join(', ') : '';
            document.getElementById('editSourceNotes').value = source.notes || '';
            document.getElementById('editSourceScrapingPattern').value = source.scraping_pattern || '';
            document.getElementById('editSourceActive').checked = source.is_active;
            
            document.getElementById('editSourceModal').style.display = 'block';
        }
        
        function deleteSource(id) {
            if (confirm('Are you sure you want to delete this source?')) {
                fetch(`/api/delete-source/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Source deleted successfully!');
                        loadSources();
                    } else {
                        alert('Error: ' + result.error);
                    }
                })
                .catch(error => {
                    alert('Error deleting source: ' + error.message);
                });
            }
        }
        
        function applySourceFilters() {
            if (!window.allSources) return;
            
            const searchTerm = document.getElementById('sourceSearch').value.toLowerCase();
            const typeFilter = document.getElementById('sourceTypeFilter').value;
            const cityFilter = document.getElementById('sourceCityFilter').value;
            
            window.filteredSources = window.allSources.filter(source => {
                const matchesSearch = !searchTerm || 
                    source.name.toLowerCase().includes(searchTerm) ||
                    source.handle.toLowerCase().includes(searchTerm) ||
                    (source.description && source.description.toLowerCase().includes(searchTerm));
                
                const matchesType = !typeFilter || source.source_type === typeFilter;
                const matchesCity = !cityFilter || source.city_id == cityFilter;
                
                return matchesSearch && matchesType && matchesCity;
            });
            
            // Update filter summary
            const summary = document.getElementById('sourceFilterSummary');
            if (summary) {
                const activeFilters = [];
                if (searchTerm) activeFilters.push(`Search: "${searchTerm}"`);
                if (typeFilter) activeFilters.push(`Type: ${typeFilter}`);
                if (cityFilter) activeFilters.push(`City: ${document.getElementById('sourceCityFilter').selectedOptions[0]?.text || cityFilter}`);
                
                summary.textContent = activeFilters.length > 0 ? 
                    `Showing ${window.filteredSources.length} of ${window.allSources.length} sources (${activeFilters.join(', ')})` : 
                    `Showing all ${window.allSources.length} sources`;
            }
            
            renderSourcesTable();
        }
        
        function clearSourceFilters() {
            document.getElementById('sourceSearch').value = '';
            document.getElementById('sourceTypeFilter').value = '';
            document.getElementById('sourceCityFilter').value = '';
            
            // Reset filtered sources to show all
            window.filteredSources = null;
            renderSourcesTable();
            
            const summary = document.getElementById('sourceFilterSummary');
            if (summary) {
                summary.textContent = `Showing all ${window.allSources.length} sources`;
            }
        }
        
        function openAddSourceModal() {
            // Load cities for the dropdown
            loadCitiesForSourceModal();
            document.getElementById('addSourceModal').style.display = 'block';
            document.getElementById('addSourceForm').reset();
        }
        
        function loadCitiesForSourceModal() {
            fetch('/api/admin/cities')
                .then(response => response.json())
                .then(cities => {
                    const citySelects = ['sourceCity', 'editSourceCity'];
                    citySelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (select) {
                            // Clear existing options except the first one
                            while (select.children.length > 1) {
                                select.removeChild(select.lastChild);
                            }
                            
                            cities.forEach(city => {
                                const option = document.createElement('option');
                                option.value = city.id;
                                option.textContent = city.display_name || `${city.name}, ${city.country}`;
                                select.appendChild(option);
                            });
                        }
                    });
                })
                .catch(error => console.error('Error loading cities:', error));
        }
        
        function populateSourceFilters() {
            const cityFilter = document.getElementById('sourceCityFilter');
            
            if (cityFilter) {
                // Clear existing options except the first one
                while (cityFilter.children.length > 1) {
                    cityFilter.removeChild(cityFilter.lastChild);
                }
                
                // Get unique cities from sources
                const cityMap = new Map();
                window.allSources.forEach(source => {
                    if (source.city_id && source.city_name) {
                        cityMap.set(source.city_id, source.city_name);
                    }
                });
                
                // Sort cities by name for better UX
                const sortedCities = Array.from(cityMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
                
                sortedCities.forEach(([cityId, cityName]) => {
                    const option = document.createElement('option');
                    option.value = cityId;
                    option.textContent = cityName;
                    cityFilter.appendChild(option);
                });
            }
        }
        
        // Form handlers
        document.getElementById('addSourceForm').addEventListener('submit', handleAddSource);
        document.getElementById('editSourceForm').addEventListener('submit', handleEditSource);
        
        function detectSourceType(input) {
            // Detect if input is Instagram handle or website URL
            if (input.startsWith('@')) {
                return {
                    type: 'instagram',
                    handle: input,
                    url: `https://www.instagram.com/${input.substring(1)}/`,
                    name: input.substring(1).replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                };
            } else if (input.includes('instagram.com')) {
                // Extract handle from Instagram URL
                const match = input.match(/instagram\.com\/([^\/\?]+)/);
                if (match) {
                    const handle = `@${match[1]}`;
                    return {
                        type: 'instagram',
                        handle: handle,
                        url: input,
                        name: match[1].replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                    };
                }
            } else if (input.startsWith('http://') || input.startsWith('https://')) {
                // Website URL
                const domain = new URL(input).hostname;
                return {
                    type: 'website',
                    handle: domain,
                    url: input,
                    name: domain.replace('www.', '').split('.')[0].replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                };
            } else {
                // Assume it's a handle without @
                return {
                    type: 'instagram',
                    handle: `@${input}`,
                    url: `https://www.instagram.com/${input}/`,
                    name: input.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                };
            }
        }

        async function handleAddSource(event) {
            event.preventDefault();
            
            const sourceInput = document.getElementById('sourceInput').value.trim();
            const cityId = parseInt(document.getElementById('sourceCity').value);
            
            if (!sourceInput || !cityId) {
                alert('Please enter a source handle/URL and select a city');
                return;
            }
            
            // Detect source type and auto-fill fields
            const detected = detectSourceType(sourceInput);
            
            const formData = {
                name: detected.name,
                handle: detected.handle,
                source_type: detected.type,
                city_id: cityId,
                url: detected.url,
                description: document.getElementById('sourceDescription').value.trim() || '',
                reliability_score: parseFloat(document.getElementById('sourceReliability').value) || 7.0,
                posting_frequency: document.getElementById('sourceFrequency').value || 'weekly',
                event_types: JSON.stringify(document.getElementById('sourceEventTypes').value.split(',').map(t => t.trim()).filter(t => t)),
                notes: document.getElementById('sourceNotes').value.trim() || '',
                scraping_pattern: document.getElementById('sourceScrapingPattern').value.trim() || '',
                is_active: document.getElementById('sourceActive').checked
            };
            
            try {
                const response = await fetch('/api/admin/add-source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Source added successfully!');
                    closeModal('addSourceModal');
                    loadSources();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error adding source: ' + error.message);
            }
        }
        
        async function handleEditSource(event) {
            event.preventDefault();
            
            const editData = {
                id: parseInt(document.getElementById('editSourceId').value),
                name: document.getElementById('editSourceName').value.trim(),
                handle: document.getElementById('editSourceHandle').value.trim(),
                source_type: document.getElementById('editSourceType').value,
                city_id: parseInt(document.getElementById('editSourceCity').value),
                url: document.getElementById('editSourceUrl').value.trim(),
                description: document.getElementById('editSourceDescription').value.trim(),
                reliability_score: parseFloat(document.getElementById('editSourceReliability').value),
                posting_frequency: document.getElementById('editSourceFrequency').value,
                event_types: JSON.stringify(document.getElementById('editSourceEventTypes').value.split(',').map(t => t.trim()).filter(t => t)),
                notes: document.getElementById('editSourceNotes').value.trim(),
                scraping_pattern: document.getElementById('editSourceScrapingPattern').value.trim(),
                is_active: document.getElementById('editSourceActive').checked
            };
            
            try {
                const response = await fetch('/api/admin/edit-source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(editData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Source updated successfully!');
                    closeModal('editSourceModal');
                    loadSources();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating source: ' + error.message);
            }
        }
        
        // Image Upload Functions
        function showEventDetails(clickEvent, eventId) {
            // Show the modal immediately - first thing, no checks
            const modal = document.getElementById('eventDetailsModal');
            const contentDiv = document.getElementById('eventDetailsContent');
            modal.style.display = 'block';
            contentDiv.innerHTML = '<div style="padding: 20px; text-align: center;">Loading...</div>';
            
            // Defer all processing - use requestAnimationFrame for smoother experience
            requestAnimationFrame(() => {
                // Find the event data
                const event = window.allEvents && window.allEvents.find(e => e.id == eventId);
                if (!event) {
                    modal.style.display = 'none';
                    return;
                }
                
                // Generate and populate content
                const content = generateEventDetailsHTML(event);
                contentDiv.innerHTML = content;
            });
        }
        
        function showVenueDetails(clickEvent, venueId) {
            // Get elements once
            const modal = document.getElementById('venueDetailsModal');
            const contentDiv = document.getElementById('venueDetailsContent');
            
            // Show modal instantly using cssText for maximum performance
            modal.style.cssText = 'display: block !important;';
            contentDiv.innerHTML = '<div style="padding: 20px; text-align: center;">Loading...</div>';
            
            // Defer all processing
            requestAnimationFrame(() => {
                const venue = window.allVenues && window.allVenues.find(v => v.id == venueId || String(v.id) === String(venueId));
                if (!venue) {
                    modal.style.display = 'none';
                    return;
                }
                
                contentDiv.innerHTML = generateVenueDetailsHTML(venue);
                
                // Lazy load images
                requestAnimationFrame(() => {
                    modal.querySelectorAll('img[data-src]').forEach(img => {
                        img.src = img.getAttribute('data-src');
                        img.removeAttribute('data-src');
                    });
                });
            });
        }
        
        function showCityDetails(clickEvent, cityId) {
            // Get elements once
            const modal = document.getElementById('cityDetailsModal');
            const contentDiv = document.getElementById('cityDetailsContent');
            
            // Show modal instantly using cssText for maximum performance
            modal.style.cssText = 'display: block !important;';
            contentDiv.innerHTML = '<div style="padding: 20px; text-align: center;">Loading...</div>';
            
            // Defer all processing
            requestAnimationFrame(() => {
                const city = window.allCities && window.allCities.find(c => c.id == cityId || String(c.id) === String(cityId));
                if (!city) {
                    modal.style.display = 'none';
                    return;
                }
                
                contentDiv.innerHTML = generateCityDetailsHTML(city);
            });
        }
        
        function showSourceDetails(clickEvent, sourceId) {
            // Prevent if clicking on a link or button
            if (clickEvent && clickEvent.target) {
                const target = clickEvent.target;
                const isLink = target.tagName === 'A' || target.closest('a');
                const isButton = target.tagName === 'BUTTON' || target.closest('button');
                if (isLink || isButton) {
                    return;
                }
            }
            
            // Find the source data
            const source = window.allSources.find(s => s.id == sourceId);
            if (!source) {
                alert('Source not found');
                return;
            }
            
            // Populate the source details modal
            const content = generateSourceDetailsHTML(source);
            document.getElementById('sourceDetailsContent').innerHTML = content;
            
            // Show the modal
            document.getElementById('sourceDetailsModal').style.display = 'block';
        }
        
        function generateEventDetailsHTML(event) {
            // Helper function to format timestamps (converts UTC to local timezone)
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return '';
                try {
                    // Ensure normalizeUTCTimestamp is accessible (defined at top level)
                    if (typeof normalizeUTCTimestamp === 'function') {
                        // Normalize UTC timestamp (append 'Z' if missing timezone)
                        const normalizedTimestamp = normalizeUTCTimestamp(timestamp);
                        const date = new Date(normalizedTimestamp);
                        // Format using browser's locale and timezone automatically
                        const options = { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        };
                        return date.toLocaleString(undefined, options);
                    } else {
                        // Fallback if function not available
                        const date = new Date(timestamp + (timestamp.includes('T') && !timestamp.endsWith('Z') && !timestamp.match(/[+-]\d{2}:?\d{2}$/) ? 'Z' : ''));
                        return date.toLocaleString(undefined, {
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        });
                    }
                } catch (e) {
                    console.error('Error formatting timestamp:', e, timestamp);
                    return timestamp; // Fallback to original if parsing fails
                }
            };
            
            // Helper function to add field only if value exists
            const addField = (label, value, isLink = false, isTimestamp = false) => {
                if (!value || value === 'N/A' || value === '') return '';
                let displayValue = value;
                if (isTimestamp) {
                    displayValue = formatTimestamp(value);
                } else if (isLink) {
                    displayValue = `<a href="${value}" target="_blank">${value}</a>`;
                }
                return `<div style="margin-bottom: 8px;"><strong>${label}:</strong> ${displayValue}</div>`;
            };
            
            // Helper function to calculate duration between two times
            const calculateDuration = (startTime, endTime) => {
                if (!startTime || !endTime) return null;
                try {
                    const start = new Date('2000-01-01 ' + startTime);
                    const end = new Date('2000-01-01 ' + endTime);
                    const diffMs = end - start;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    
                    if (diffHours > 0 && diffMinutes > 0) {
                        return `${diffHours}h ${diffMinutes}m`;
                    } else if (diffHours > 0) {
                        return `${diffHours}h`;
                    } else {
                        return `${diffMinutes}m`;
                    }
                } catch (e) {
                    return null;
                }
            };
            
            // Format description to show more text
            const formatDescription = (desc) => {
                if (!desc) return '';
                // Show first 500 characters, with "..." if longer
                if (desc.length > 500) {
                    return desc.substring(0, 500) + '...';
                }
                return desc;
            };
            
            let html = `
                <!-- Event Header with Image -->
                <div class="event-details-header" style="display: grid; grid-template-columns: ${event.image_url ? '1fr 300px' : '1fr'}; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <div style="background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%); color: white; padding: 25px; border-radius: 12px; text-align: center;">
                            <h2 style="margin: 0; font-size: 26px; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${event.title || 'Untitled Event'}</h2>
                            <div style="margin-top: 8px; font-size: 16px; opacity: 0.9;">
                                ${event.event_type ? `<span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; margin-right: 8px;">${event.event_type}</span>` : ''}
                                ${event.venue_name ? `<span style="opacity: 0.8;"> ${event.venue_name}</span>` : ''}
                            </div>
                        </div>
                        ${event.description ? `
                            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ff8c42;">
                                <h4 style="margin: 0 0 8px 0; color: #4a5568; font-size: 14px; font-weight: 600;"> Description</h4>
                                <p style="margin: 0; color: #2d3748; line-height: 1.6; white-space: pre-wrap;">${formatDescription(event.description)}</p>
                                ${event.description.length > 500 ? `<small style="color: #666; font-style: italic;">(Truncated - full description available in database)</small>` : ''}
                            </div>
                        ` : ''}
                    </div>
                    ${event.image_url ? `
                        <div>
                            <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 14px;"> Event Image</h4>
                            <a href="${event.image_url}" target="_blank" style="display: block; text-decoration: none; border-radius: 12px; overflow: hidden;">
                                <img src="${event.image_url}" alt="${event.title || 'Event'} Image" 
                                     style="width: 100%; max-width: 100%; height: auto; display: block; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.2s; background: #f5f5f5;"
                                     onerror="console.error('Failed to load image:', '${event.image_url}'); this.style.background='#f5f5f5'; this.alt='Image unavailable - click to view URL';"
                                     onload="console.log('Image loaded:', '${event.image_url}');"
                                     onmouseover="this.style.transform='scale(1.02)'"
                                     onmouseout="this.style.transform='scale(1)'">
                            </a>
                            <small style="display: block; margin-top: 8px; color: #666; text-align: center;">Click image to view full size</small>
                        </div>
                    ` : ''}
                </div>
                
                <div class="event-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Basic Information</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="margin-bottom: 6px; font-size: 0.875rem;"><strong>ID:</strong> ${event.id}</div>
                            ${addField('Type', event.event_type)}
                            ${addField('Price', event.price ? `$${event.price}` : (event.admission_price ? `$${event.admission_price}` : null))}
                            ${addField('Language', event.language)}
                            ${addField('Organizer', event.organizer)}
                            ${addField('Is Online', event.is_online ? 'Yes (Virtual Event)' : 'No')}
                            <div style="margin-bottom: 8px;"><strong>Selected:</strong> ${event.is_selected ? 'Yes' : 'No'}</div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Date & Time</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            ${addField('Start Date', event.start_date)}
                            ${addField('End Date', event.end_date)}
                            ${addField('Start Time', event.start_time)}
                            ${addField('End Time', event.end_time)}
                            ${addField('Duration', event.start_time && event.end_time ? calculateDuration(event.start_time, event.end_time) : null)}
                            <div style="margin-bottom: 8px; padding: 8px; background: #e3f2fd; border-radius: 4px; border-left: 4px solid #2196f3;">
                                <strong> Timezone:</strong> ${event.city_timezone || 'Not specified'}
                                ${event.city_timezone ? `<br><small style="color: #666;">All times shown in local timezone</small>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="event-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Location</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            ${addField('Start Location', event.start_location)}
                            ${addField('End Location', event.end_location)}
                            ${addField('City', event.city_name)}
                            ${addField('Venue', event.venue_name)}
                            ${addField('Venue Address', event.venue_address)}
                            ${addField('Coordinates', event.start_latitude && event.start_longitude ? `${event.start_latitude}, ${event.start_longitude}` : null)}
                            ${event.maps_link ? `<div style="margin-top: 10px;"><a href="${event.maps_link}" target="_blank" style="color: #2196f3; text-decoration: none; font-weight: 600;"> Open in Google Maps </a></div>` : ''}
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Sources & Links</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            ${addField('Source', event.source)}
                            ${addField('Source URL', event.source_url, true)}
                            ${addField('Event URL', event.url, true)}
                            ${addField('Social Media Platform', event.social_media_platform)}
                            ${addField('Social Media Handle', event.social_media_handle ? `@${event.social_media_handle}` : null)}
                            ${addField('Social Media URL', event.social_media_url, true)}
                        </div>
                    </div>
                </div>
                
                ${event.is_registration_required ? `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; color: #4a5568;"> Registration</h4>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <div style="margin-bottom: 8px;"><strong>Registration Required:</strong> Yes</div>
                            ${addField('Registration Opens Date', event.registration_opens_date)}
                            ${addField('Registration Opens Time', event.registration_opens_time)}
                            ${addField('Registration URL', event.registration_url, true)}
                            ${addField('Registration Info', event.registration_info)}
                        </div>
                    </div>
                ` : ''}
            `;
            
            // Add event-specific fields based on event type
            if (event.event_type === 'tour') {
                const tourFields = [];
                if (event.tour_type) tourFields.push(addField('Tour Type', event.tour_type));
                if (event.max_participants) tourFields.push(addField('Max Participants', event.max_participants));
                if (event.price) tourFields.push(addField('Price', `$${event.price}`));
                if (event.language) tourFields.push(addField('Language', event.language));
                
                if (tourFields.length > 0) {
                    html += `
                        <div>
                            <h4 style="margin-bottom: 10px; color: #4a5568;"> Tour Details</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                ${tourFields.join('')}
                            </div>
                        </div>
                    `;
                }
            } else if (event.event_type === 'exhibition') {
                const exhibitionFields = [];
                if (event.exhibition_location) exhibitionFields.push(addField('Exhibition Location', event.exhibition_location));
                if (event.curator) exhibitionFields.push(addField('Curator', event.curator));
                if (event.admission_price) exhibitionFields.push(addField('Admission Price', `$${event.admission_price}`));
                if (event.artists) exhibitionFields.push(addField('Artists', event.artists));
                if (event.exhibition_type) exhibitionFields.push(addField('Exhibition Type', event.exhibition_type));
                if (event.collection_period) exhibitionFields.push(addField('Collection Period', event.collection_period));
                if (event.number_of_artworks) exhibitionFields.push(addField('Number of Artworks', event.number_of_artworks));
                if (event.opening_reception_date) {
                    const receptionDate = new Date(event.opening_reception_date + 'T00:00:00').toLocaleDateString();
                    const receptionTime = event.opening_reception_time ? ` at ${event.opening_reception_time}` : '';
                    exhibitionFields.push(addField('Opening Reception', receptionDate + receptionTime));
                }
                if (event.is_permanent) exhibitionFields.push(addField('Permanent Collection', 'Yes'));
                if (event.related_exhibitions) exhibitionFields.push(addField('Related Exhibitions', event.related_exhibitions));
                
                if (exhibitionFields.length > 0) {
                    html += `
                        <div>
                            <h4 style="margin-bottom: 10px; color: #4a5568;"> Exhibition Details</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                ${exhibitionFields.join('')}
                            </div>
                        </div>
                    `;
                }
            } else if (event.event_type === 'festival') {
                const festivalFields = [];
                if (event.festival_type) festivalFields.push(addField('Festival Type', event.festival_type));
                festivalFields.push(`<div style="margin-bottom: 8px;"><strong>Multiple Locations:</strong> ${event.multiple_locations ? 'Yes' : 'No'}</div>`);
                
                if (festivalFields.length > 0) {
                    html += `
                        <div>
                            <h4 style="margin-bottom: 10px; color: #4a5568;"> Festival Details</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                ${festivalFields.join('')}
                            </div>
                        </div>
                    `;
                }
            } else if (event.event_type === 'photowalk') {
                const photowalkFields = [];
                if (event.difficulty_level) photowalkFields.push(addField('Difficulty Level', event.difficulty_level));
                if (event.equipment_needed) photowalkFields.push(addField('Equipment Needed', event.equipment_needed));
                if (event.organizer) photowalkFields.push(addField('Organizer', event.organizer));
                
                if (photowalkFields.length > 0) {
                    html += `
                        <div>
                            <h4 style="margin-bottom: 10px; color: #4a5568;"> Photowalk Details</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                ${photowalkFields.join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            // Add system information
            html += `
                <div>
                    <h4 style="margin-bottom: 10px; color: #4a5568;"> System Information</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        ${addField('Created', event.created_at, false, true)}
                        ${addField('Updated', event.updated_at, false, true)}
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function generateVenueDetailsHTML(venue) {
            // Helper function to format timestamps (remove seconds, make reader-friendly)
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return '';
                try {
                    // Normalize UTC timestamp (append 'Z' if missing timezone)
                    const normalizedTimestamp = normalizeUTCTimestamp(timestamp);
                    const date = new Date(normalizedTimestamp);
                    const options = { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    };
                    return date.toLocaleString(undefined, options);
                } catch (e) {
                    return timestamp;
                }
            };
            
            // Helper function to add field only if value exists
            const addField = (label, value, isLink = false, isTimestamp = false) => {
                if (!value || value === 'N/A' || value === '') return '';
                let displayValue = value;
                if (isTimestamp) {
                    displayValue = formatTimestamp(value);
                } else if (isLink) {
                    displayValue = `<a href="${value}" target="_blank" style="color: #1976d2; word-break: break-all;">${value}</a>`;
                }
                return `<div style="margin-bottom: 6px; font-size: 0.875rem; line-height: 1.4;"><strong>${label}:</strong> ${displayValue}</div>`;
            };
            
            let html = `
                <!-- Venue Header -->
                <div class="venue-details-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center;">
                    <h2 style="margin: 0; font-size: 28px; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${venue.name}</h2>
                    <div style="margin-top: 8px; font-size: 16px; opacity: 0.9;">
                        ${venue.venue_type ? `<span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; margin-right: 8px;">${venue.venue_type}</span>` : ''}
                        ${venue.city_name ? `<span style="opacity: 0.8;"> ${venue.city_name}</span>` : ''}
                    </div>
                </div>
                
                <div class="venue-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Basic Information</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="margin-bottom: 6px; font-size: 0.875rem;"><strong>ID:</strong> ${venue.id}</div>
                            ${addField('Type', venue.venue_type)}
                            ${addField('Description', venue.description)}
                            ${addField('City', venue.city_name)}
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Location & Contact</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            ${addField('Address', venue.address)}
                            ${addField('Phone', venue.phone_number || venue.phone)}
                            ${addField('Email', venue.email)}
                            ${addField('Website', venue.website_url || venue.website, true)}
                            ${addField('Coordinates', venue.latitude && venue.longitude ? `${venue.latitude}, ${venue.longitude}` : null)}
                            <div style="margin-bottom: 8px; padding: 8px; background: #e3f2fd; border-radius: 4px; border-left: 4px solid #2196f3;">
                                <strong> City Timezone:</strong> ${venue.city_timezone || 'Not specified'}
                                ${venue.city_timezone ? `<br><small style="color: #666;">All venue times in local timezone</small>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="venue-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Hours & Pricing</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            ${addField('Opening Hours', venue.opening_hours)}
                            ${addField('Admission Fee', venue.admission_fee)}
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Social Media</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            ${addField('Instagram', venue.instagram_url || venue.instagram, true)}
                            ${addField('Twitter', venue.twitter_url || venue.twitter, true)}
                            ${addField('Facebook', venue.facebook_url || venue.facebook, true)}
                            ${addField('YouTube', venue.youtube_url || venue.youtube, true)}
                            ${addField('TikTok', venue.tiktok_url || venue.tiktok, true)}
                        </div>
                    </div>
                </div>
                
                ${venue.image_url && venue.image_url.trim() ? `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px; color: #4a5568;"> Venue Image</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        ${(() => {
                            // Check if it's a photo reference (long string without http)
                            let imageSrc = venue.image_url;
                            let imageHref = venue.image_url;
                            if (venue.image_url && venue.image_url.trim() && !venue.image_url.startsWith('http') && venue.image_url.length > 50) {
                                // It's likely a Google Maps photo reference - use the image API endpoint
                                imageSrc = '/api/image/' + venue.image_url;
                                imageHref = '/api/image/' + venue.image_url;
                            }
                            return `
                                <a href="${imageHref}" target="_blank" style="color: #2196f3; text-decoration: none;">
                                    <img data-src="${imageSrc}" alt="Venue Image" style="max-width: 300px; max-height: 200px; border-radius: 8px; cursor: pointer; border: 2px solid #e0e0e0; background: #f5f5f5;" 
                                         onerror="this.style.display='none'; const fallbackDiv = this.parentElement.querySelector('.image-fallback'); if (fallbackDiv) { fallbackDiv.style.display='inline-block'; }">
                                    <div class="image-fallback" style="display: none; padding: 10px; background: #f5f5f5; border-radius: 4px; color: #666;">
                                        <a href="${imageHref}" target="_blank" style="color: #2196f3;">View Venue Image</a>
                                    </div>
                                </a>
                            `;
                        })()}
                    </div>
                </div>
                ` : ''}
                
                <div>
                    <h4 style="margin-bottom: 10px; color: #4a5568;"> System Information</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        ${addField('Created', venue.created_at, false, true)}
                        ${addField('Updated', venue.updated_at, false, true)}
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function generateCityDetailsHTML(city) {
            // Helper function to format timestamps (remove seconds, make reader-friendly)
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return '';
                try {
                    // Normalize UTC timestamp (append 'Z' if missing timezone)
                    const normalizedTimestamp = normalizeUTCTimestamp(timestamp);
                    const date = new Date(normalizedTimestamp);
                    const options = { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    };
                    return date.toLocaleString(undefined, options);
                } catch (e) {
                    return timestamp;
                }
            };
            
            // Helper function to add field only if value exists
            const addField = (label, value, isLink = false, isTimestamp = false) => {
                if (!value || value === 'N/A' || value === '') return '';
                let displayValue = value;
                if (isTimestamp) {
                    displayValue = formatTimestamp(value);
                } else if (isLink) {
                    displayValue = `<a href="${value}" target="_blank" style="color: #1976d2; word-break: break-all;">${value}</a>`;
                }
                return `<div style="margin-bottom: 6px; font-size: 0.875rem; line-height: 1.4;"><strong>${label}:</strong> ${displayValue}</div>`;
            };
            
            let html = `
                <!-- City Header -->
                <div class="city-details-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; text-align: center;">
                    <h2 style="margin: 0; font-size: 28px; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${city.display_name || city.name}</h2>
                    <div style="margin-top: 8px; font-size: 16px; opacity: 0.9;">
                        ${city.timezone ? `<span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; margin-right: 8px;"> ${city.timezone}</span>` : ''}
                        ${city.state ? `<span style="opacity: 0.8;"> ${city.state}, ${city.country}</span>` : `<span style="opacity: 0.8;"> ${city.country}</span>`}
                    </div>
                </div>
                
                <div class="city-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Basic Information</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="margin-bottom: 6px; font-size: 0.875rem;"><strong>ID:</strong> ${city.id}</div>
                            ${addField('Name', city.name)}
                            ${addField('Display Name', city.display_name)}
                            ${addField('State/Province', city.state)}
                            ${addField('Country', city.country)}
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Location & Timezone</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="margin-bottom: 8px; padding: 8px; background: #e3f2fd; border-radius: 4px; border-left: 4px solid #2196f3;">
                                <strong> Timezone:</strong> ${city.timezone || 'Not specified'}
                                ${city.timezone ? `<br><small style="color: #666;">All events in this city use this timezone</small>` : ''}
                            </div>
                            ${addField('Latitude', city.latitude)}
                            ${addField('Longitude', city.longitude)}
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="margin-bottom: 10px; color: #4a5568;"> System Information</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        ${addField('Created', city.created_at, false, true)}
                        ${addField('Updated', city.updated_at, false, true)}
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function generateSourceDetailsHTML(source) {
            // Helper function to format timestamps (remove seconds, make reader-friendly)
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return '';
                try {
                    // Normalize UTC timestamp (append 'Z' if missing timezone)
                    const normalizedTimestamp = normalizeUTCTimestamp(timestamp);
                    const date = new Date(normalizedTimestamp);
                    const options = { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    };
                    return date.toLocaleString(undefined, options);
                } catch (e) {
                    return timestamp;
                }
            };
            
            // Helper function to add field only if value exists
            const addField = (label, value, isLink = false, isTimestamp = false) => {
                if (!value || value === 'N/A' || value === '') return '';
                let displayValue = value;
                if (isTimestamp) {
                    displayValue = formatTimestamp(value);
                } else if (isLink) {
                    displayValue = `<a href="${value}" target="_blank" style="color: #1976d2; word-break: break-all;">${value}</a>`;
                }
                return `<div style="margin-bottom: 6px; font-size: 0.875rem; line-height: 1.4;"><strong>${label}:</strong> ${displayValue}</div>`;
            };
            
            let html = `
                <div class="source-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Basic Information</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="margin-bottom: 6px; font-size: 0.875rem;"><strong>ID:</strong> ${source.id}</div>
                            ${addField('Name', source.name)}
                            ${addField('Handle', source.handle)}
                            ${addField('Type', source.source_type)}
                            ${addField('Description', source.description)}
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Links & Contact</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            ${addField('URL', source.url, true)}
                            ${addField('Email', source.email)}
                            ${addField('Phone', source.phone)}
                            ${addField('Contact Person', source.contact_person)}
                        </div>
                    </div>
                </div>
                
                <div class="source-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Event Information</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            ${addField('Event Types', source.event_types)}
                            ${addField('Frequency', source.frequency)}
                            ${addField('Language', source.language)}
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 10px; color: #4a5568; font-size: 0.9375rem;"> Status & Stats</h4>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="margin-bottom: 6px; font-size: 0.875rem;"><strong>Active:</strong> ${source.is_active ? 'Yes' : 'No'}</div>
                            ${addField('Last Scraped', source.last_scraped_at)}
                            ${addField('Events Count', source.events_count)}
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="margin-bottom: 10px; color: #4a5568;"> System Information</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        ${addField('Created', source.created_at, false, true)}
                        ${addField('Updated', source.updated_at, false, true)}
                    </div>
                </div>
            `;
            
            return html;
        }
        
        async function autoFillFromUrl() {
            const url = document.getElementById('eventUrl').value;
            
            if (!url) {
                alert('Please enter a URL first');
                return;
            }
            
            // Show loading indicator
            const autoFillBtn = document.getElementById('autoFillBtn');
            const originalText = autoFillBtn.textContent;
            autoFillBtn.textContent = ' Extracting...';
            autoFillBtn.disabled = true;
            
            try {
                console.log('Fetching data from:', url);
                
                const response = await fetch('/api/admin/extract-event-from-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });
                
                const result = await response.json();
                console.log('Extraction result:', result);
                
                if (response.ok) {
                    // Show extracted data preview
                    displayExtractedData(result);
                } else {
                    alert(`Error: ${result.error || 'Failed to extract data from URL'}`);
                }
            } catch (error) {
                console.error('Error extracting from URL:', error);
                alert('An error occurred while extracting data from the URL: ' + error.message);
            } finally {
                // Restore button
                autoFillBtn.textContent = originalText;
                autoFillBtn.disabled = false;
            }
        }
        
        function displayExtractedData(data) {
            console.log(' displayExtractedData called with:', data);
            
            // Show the preview section
            document.getElementById('urlExtractedPreview').style.display = 'block';
            
            // Add extraction method indicator
            let extractionBadge = '';
            if (data.llm_extracted) {
                const confidenceColor = {
                    'high': '#10b981',
                    'medium': '#f59e0b',
                    'low': '#ef4444'
                }[data.confidence || 'medium'];
                extractionBadge = `<span style="background: ${confidenceColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;"> AI Extracted (${data.confidence || 'medium'} confidence)</span>`;
            }
            
            // Display summary
            const content = document.getElementById('urlExtractedContent');
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 12px;">
                    <strong>Title:</strong> <span>${data.title || 'Not found'}</span>
                    <strong>Description:</strong> <span>${data.description ? data.description.substring(0, 100) + '...' : 'Not found'}</span>
                    <strong>Schedule:</strong> <span>${data.schedule_info || 'Not detected'}</span>
                    <strong>Start Time:</strong> <span>${data.start_time || 'Not found'}</span>
                    <strong>End Time:</strong> <span>${data.end_time || 'Not found'}</span>
                    <strong>Location:</strong> <span>${data.location || 'Not found'}</span>
                    <strong>Venue:</strong> <span>${data.venue_id ? ' Auto-matched' : ' Not matched'}</span>
                    <strong>City:</strong> <span>${data.city_id ? ' Auto-matched' : ' Not matched'}</span>
                    <strong>Image:</strong> <span>${data.image_url ? ' Found' : ' Not found'}</span>
                    ${data.is_registration_required !== undefined ? `<strong>Registration Required:</strong> <span>${data.is_registration_required ? 'Yes' : 'No'}</span>` : ''}
                    ${data.registration_info ? `<strong>Registration Info:</strong> <span>${data.registration_info}</span>` : ''}
                    ${data.registration_url ? `<strong>Registration URL:</strong> <span><a href="${data.registration_url}" target="_blank">${data.registration_url.substring(0, 50)}...</a></span>` : ''}
                    ${data.price !== undefined ? `<strong>Price:</strong> <span>${data.price === 0 || data.price === '0' || data.price === 'Free' ? 'Free' : '$' + data.price}</span>` : ''}
                    ${data.llm_extracted ? `<strong>Extraction:</strong> ${extractionBadge}` : ''}
                </div>
            `;
            
            // Fill editable fields
            document.getElementById('extractedTitle').value = data.title || '';
            document.getElementById('extractedDescription').value = data.description || '';
            document.getElementById('extractedStartTime').value = data.start_time || '';
            document.getElementById('extractedEndTime').value = data.end_time || '';
            document.getElementById('extractedLocation').value = data.location || '';
            document.getElementById('extractedSchedule').value = data.schedule_info || '';
            
            // Store extracted data for later use
            window.extractedEventData = data;
            
            console.log(' Stored extracted data:', data);
            
            // Show the Apply button if we have venue or city data
            if (data.venue_id || data.city_id) {
                document.getElementById('applyToFormSection').style.display = 'block';
            }
        }
        
        function applyExtractedToForm() {
            const data = window.extractedEventData;
            if (!data) {
                alert('No extracted data available');
                return;
            }
            
            // Apply venue
            if (data.venue_id) {
                const venueSelect = document.getElementById('urlVenueSelect');
                if (venueSelect) {
                    venueSelect.value = data.venue_id;
                    console.log(' Applied venue ID:', data.venue_id);
                }
            }
            
            // Apply city
            if (data.city_id) {
                const citySelect = document.getElementById('urlCitySelect');
                if (citySelect) {
                    citySelect.value = data.city_id;
                    console.log(' Applied city ID:', data.city_id);
                }
            }
            
            // Visual confirmation
            alert(' Venue and City have been applied to the form!');
        }
        
        function openUrlScraperModal() {
            document.getElementById('urlScraperModal').style.display = 'block';
            document.getElementById('scrapedDataDisplay').style.display = 'none';
            document.getElementById('urlExtractedPreview').style.display = 'none';
            document.getElementById('urlScraperForm').reset();
            
            // Attach event listener to Auto-Fill button
            const autoFillBtn = document.getElementById('autoFillBtn');
            if (autoFillBtn) {
                // Remove any existing listeners by cloning the button
                const newAutoFillBtn = autoFillBtn.cloneNode(true);
                autoFillBtn.parentNode.replaceChild(newAutoFillBtn, autoFillBtn);
                // Add the event listener
                newAutoFillBtn.addEventListener('click', autoFillFromUrl);
            }
            
            // Store references for later auto-selection
            window.venueDropdownLoaded = false;
            window.cityDropdownLoaded = false;
            
            // Populate venue dropdown
            fetch('/api/admin/venues')
                .then(response => response.json())
                .then(venues => {
                    const select = document.getElementById('urlVenueSelect');
                    select.innerHTML = '<option value="">No specific venue (city-wide event)</option>';
                    
                    // Check if venues is an array
                    if (Array.isArray(venues)) {
                        venues.forEach(venue => {
                            const option = document.createElement('option');
                            option.value = venue.id;
                            option.textContent = `${venue.name} (${venue.city_name || 'No city'})`;
                            select.appendChild(option);
                        });
                    } else {
                        console.error('Venues response is not an array:', venues);
                    }
                    
                    window.venueDropdownLoaded = true;
                    // Try auto-selection if we have extracted data
                    if (window.extractedEventData && window.extractedEventData.venue_id) {
                        select.value = window.extractedEventData.venue_id;
                        console.log(' AUTO-SELECTED VENUE:', window.extractedEventData.venue_id);
                    }
                })
                .catch(error => console.error('Error loading venues:', error));
            
            // Populate city dropdown using cached cities or fetch if needed
            if (window.allCities) {
                populateUrlCitySelector();
            } else {
                fetch('/api/admin/cities')
                    .then(response => response.json())
                    .then(cities => {
                        window.allCities = cities;
                        populateUrlCitySelector();
                    })
                    .catch(error => console.error('Error loading cities:', error));
            }
        }
        
        function openImageUploadModal() {
            console.log('Opening image upload modal...');
            document.getElementById('imageUploadModal').style.display = 'block';
            document.getElementById('extractedDataDisplay').style.display = 'none';
            document.getElementById('imageUploadForm').reset();
            
            // Clear any previous file selection
            const fileInput = document.getElementById('eventImage');
            if (fileInput) {
                fileInput.value = '';
                console.log('File input cleared');
            }
            
            // Reset manual input fields
            document.getElementById('manualEventTitle').value = '';
            document.getElementById('manualEventDescription').value = '';
            document.getElementById('manualStartDate').value = '';
            document.getElementById('manualEndDate').value = '';
            document.getElementById('manualStartTime').value = '';
            document.getElementById('manualEndTime').value = '';
            document.getElementById('manualEventType').value = 'tour';
            document.getElementById('manualStartLocation').value = '';
            document.getElementById('manualEndLocation').value = '';
            document.getElementById('manualPrice').value = '';
            document.getElementById('manualUrl').value = '';
            document.getElementById('manualCityId').value = '';
            document.getElementById('manualEventSource').value = '';
            document.getElementById('manualSourceUrl').value = '';
            // Reset social media fields
            document.getElementById('manualSocialMediaPlatform').value = '';
            document.getElementById('manualSocialMediaHandle').value = '';
            document.getElementById('manualSocialMediaPageName').value = '';
            document.getElementById('manualSocialMediaPostedBy').value = '';
            document.getElementById('manualSocialMediaUrl').value = '';
            
            // Populate city dropdown with a small delay to ensure modal is fully rendered
            setTimeout(() => {
                populateCitySelect('manualCityId');
                
                // Add listener for city change to populate venues
                const citySelect = document.getElementById('manualCityId');
                if (citySelect) {
                    citySelect.addEventListener('change', function() {
                        const cityId = this.value;
                        if (cityId) {
                            populateVenuesForCity(cityId, 'manualVenueId');
                        } else {
                            const venueSelect = document.getElementById('manualVenueId');
                            if (venueSelect) {
                                venueSelect.innerHTML = '<option value="">Select Venue (optional)</option>';
                            }
                        }
                    });
                }
            }, 100);
        }
        
        async function populateVenuesForCity(cityId, selectId) {
            const venueSelect = document.getElementById(selectId);
            if (!venueSelect) {
                console.error(`Venue select element not found: ${selectId}`);
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/venues?city_id=${cityId}`);
                const venues = await response.json();
                
                venueSelect.innerHTML = '<option value="">Select Venue (optional)</option>';
                venues.forEach(venue => {
                    const option = document.createElement('option');
                    option.value = venue.id;
                    option.textContent = venue.name;
                    venueSelect.appendChild(option);
                });
                
                console.log(` Populated ${venues.length} venues for city ${cityId}`);
            } catch (error) {
                console.error('Error loading venues:', error);
                venueSelect.innerHTML = '<option value="">Error loading venues</option>';
            }
        }
        
        function openCreateFromVenueModal() {
            document.getElementById('createFromVenueModal').style.display = 'block';
            populateVenueSelect();
        }
        
        function populateVenueSelect() {
            const venueSelect = document.getElementById('venueSelect');
            venueSelect.innerHTML = '<option value="">Choose a venue...</option>';
            
            if (window.allVenues) {
                window.allVenues.forEach(venue => {
                    const option = document.createElement('option');
                    option.value = venue.id;
                    option.textContent = `${venue.name} (${venue.city_name || 'Unknown City'})`;
                    venueSelect.appendChild(option);
                });
            }
        }
        
        // Handle time period selection
        document.getElementById('timePeriod')?.addEventListener('change', function() {
            const customFields = document.getElementById('customPeriodFields');
            if (this.value === 'custom') {
                customFields.style.display = 'block';
            } else {
                customFields.style.display = 'none';
            }
        });
        
        // Handle URL scraper form submission
        function setupUrlScraperForm() {
            const urlScraperForm = document.getElementById('urlScraperForm');
            if (urlScraperForm) {
                urlScraperForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const url = document.getElementById('eventUrl').value;
                    const venueId = document.getElementById('urlVenueSelect').value;
                    const cityId = document.getElementById('urlCitySelect').value;
                    const timePeriod = document.getElementById('timePeriod').value;
                    let startDate = null;
                    let endDate = null;
                    
                    if (!cityId) {
                        alert('Please select a city');
                        return;
                    }
                    
                    if (timePeriod === 'custom') {
                        startDate = document.getElementById('customStartDate').value;
                        endDate = document.getElementById('customEndDate').value;
                        if (!startDate || !endDate) {
                            alert('Please specify custom period dates');
                            return;
                        }
                    }
                    
                    // Use edited extracted data if available
                    const extractedData = window.extractedEventData || {};
                    const editedTitle = document.getElementById('extractedTitle').value;
                    const editedDescription = document.getElementById('extractedDescription').value;
                    const editedStartTime = document.getElementById('extractedStartTime').value;
                    const editedEndTime = document.getElementById('extractedEndTime').value;
                    const editedLocation = document.getElementById('extractedLocation').value;
                    
                    const requestData = {
                        url: url,
                        venue_id: venueId ? parseInt(venueId) : null,
                        city_id: parseInt(cityId),
                        time_period: timePeriod,
                        start_date: startDate,
                        end_date: endDate,
                        // Include edited extracted data
                        title: editedTitle || extractedData.title,
                        description: editedDescription || extractedData.description,
                        start_time: editedStartTime || extractedData.start_time,
                        end_time: editedEndTime || extractedData.end_time,
                        location: editedLocation || extractedData.location,
                        image_url: extractedData.image_url,
                        schedule_info: extractedData.schedule_info,
                        days_of_week: extractedData.days_of_week
                    };
                    
                    try {
                        showLoadingState('Scraping URL and creating events...');
                        
                        const response = await fetch('/api/admin/scrape-event-from-url', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });
                        
                        const result = await response.json();
                        hideLoadingState();
                        
                        if (response.ok) {
                            displayScrapedData(result);
                            await loadEvents(); // Refresh events table
                        } else {
                            alert(`Error: ${result.error || 'Failed to scrape URL'}`);
                        }
                    } catch (error) {
                        hideLoadingState();
                        console.error('Error scraping URL:', error);
                        alert('An error occurred while scraping the URL');
                    }
                });
            }
        }
        
        function displayScrapedData(result) {
            const display = document.getElementById('scrapedDataDisplay');
            const content = document.getElementById('scrapedDataContent');
            
            let html = `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <h5 style="color: #10b981; margin-bottom: 10px;"> Successfully Created ${result.events_created || 0} Event(s)</h5>
            `;
            
            if (result.events && result.events.length > 0) {
                result.events.forEach((event, index) => {
                    html += `
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                            <strong>Event ${index + 1}:</strong> ${event.title || 'Untitled'}<br>
                            <small> ${event.start_date || 'No date'} ${event.start_time || ''}</small><br>
                            ${event.description ? `<small> ${event.description.substring(0, 100)}...</small>` : ''}
                        </div>
                    `;
                });
            }
            
            if (result.schedule_info) {
                html += `
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-top: 10px;">
                        <strong> Schedule Detected:</strong><br>
                        <small>${result.schedule_info}</small>
                    </div>
                `;
            }
            
            html += '</div>';
            content.innerHTML = html;
            display.style.display = 'block';
        }
        
        // Populate quick URL city selector
        async function populateQuickUrlCitySelector() {
            try {
                const citySelect = document.getElementById('quickUrlCitySelect');
                if (!citySelect) return;
                
                // Use cached cities if available, otherwise fetch
                let cities = window.allCities;
                if (!cities) {
                    const response = await fetch('/api/admin/cities');
                    cities = await response.json();
                    window.allCities = cities;
                }
                
                // Clear existing options except the first one
                citySelect.innerHTML = '<option value="">Select City...</option>';
                
                // Add cities
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = city.name + (city.state ? `, ${city.state}` : '');
                    citySelect.appendChild(option);
                });
                
                console.log(` Populated quick URL city selector with ${cities.length} cities`);
            } catch (error) {
                console.error('Error populating quick URL city selector:', error);
            }
        }
        
        async function quickCreateEventFromUrl() {
            const urlInput = document.getElementById('quickEventUrl');
            const statusDiv = document.getElementById('quickUrlStatus');
            const url = urlInput.value.trim();
            
            if (!url) {
                statusDiv.innerHTML = '<span style="color: #ef4444;"> Please enter a URL</span>';
                return;
            }
            
            // Validate URL format
            try {
                new URL(url);
            } catch (e) {
                statusDiv.innerHTML = '<span style="color: #ef4444;"> Invalid URL format</span>';
                return;
            }
            
            statusDiv.innerHTML = '<span style="color: #3b82f6;"> Extracting event details...</span>';
            
            try {
                // Step 1: Extract event data
                const extractResponse = await fetch('/api/admin/extract-event-from-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });
                
                const extractedData = await extractResponse.json();
                
                if (!extractResponse.ok) {
                    statusDiv.innerHTML = `<span style="color: #ef4444;"> Extraction failed: ${extractedData.error || 'Unknown error'}</span>`;
                    return;
                }
                
                if (!extractedData.title) {
                    statusDiv.innerHTML = '<span style="color: #ef4444;"> Could not extract event title. Try the advanced "From URL" option.</span>';
                    return;
                }
                
                statusDiv.innerHTML = '<span style="color: #3b82f6;"> Creating event...</span>';
                
                // Step 2: Auto-detect city and venue
                let cityId = extractedData.city_id;
                let venueId = extractedData.venue_id;
                
                // If no city detected, try to detect from URL
                if (!cityId) {
                    const citiesResponse = await fetch('/api/admin/cities');
                    const cities = await citiesResponse.json();
                    
                    // Check for NGA (National Gallery of Art) - DC
                    if (url.includes('nga.gov') || url.toLowerCase().includes('national gallery')) {
                        const dcCity = cities.find(c => 
                            c.name.toLowerCase().includes('washington') || 
                            c.name.toLowerCase().includes('dc')
                        );
                        if (dcCity) {
                            cityId = dcCity.id;
                            statusDiv.innerHTML = '<span style="color: #3b82f6;"> Auto-detected Washington DC...</span>';
                            
                            // Try to find NGA venue
                            if (!venueId) {
                                const venuesResponse = await fetch('/api/admin/venues');
                                const venues = await venuesResponse.json();
                                const ngaVenue = venues.find(v => 
                                    v.name.toLowerCase().includes('national gallery') && 
                                    (v.city_id == cityId || v.city_name?.toLowerCase().includes('washington'))
                                );
                                if (ngaVenue) {
                                    venueId = ngaVenue.id;
                                }
                            }
                        }
                    }
                    // Check for OCMA (Orange County Museum of Art) - Irvine
                    else if (url.includes('ocma.art') || url.toLowerCase().includes('orange county museum')) {
                        const irvineCity = cities.find(c => 
                            c.name.toLowerCase().includes('irvine') || 
                            c.name.toLowerCase().includes('orange county')
                        );
                        if (irvineCity) {
                            cityId = irvineCity.id;
                            statusDiv.innerHTML = '<span style="color: #3b82f6;"> Auto-detected Irvine...</span>';
                            
                            // Try to find OCMA venue
                            if (!venueId) {
                                const venuesResponse = await fetch('/api/admin/venues');
                                const venues = await venuesResponse.json();
                                const ocmaVenue = venues.find(v => 
                                    (v.name.toLowerCase().includes('ocma') || v.name.toLowerCase().includes('orange county museum')) && 
                                    (v.city_id == cityId || v.city_name?.toLowerCase().includes('irvine'))
                                );
                                if (ocmaVenue) {
                                    venueId = ocmaVenue.id;
                                }
                            }
                        }
                    }
                }
                
                // If still no city, check if user selected one from dropdown
                if (!cityId) {
                    const citySelect = document.getElementById('quickUrlCitySelect');
                    if (citySelect && citySelect.value) {
                        cityId = parseInt(citySelect.value);
                        statusDiv.innerHTML = '<span style="color: #3b82f6;"> Using selected city...</span>';
                    } else {
                        statusDiv.innerHTML = '<span style="color: #ef4444;"> Please select a city from the dropdown above, or use the advanced "From URL" option.</span>';
                        return;
                    }
                }
                
                // Step 3: Determine date and time from extracted data or URL
                let startDate = extractedData.start_date;
                let startTime = extractedData.start_time;
                let endTime = extractedData.end_time;
                
                // Try to extract date and time from URL as fallback (e.g., evd=202601311530 = YYYYMMDDHHMM)
                const evdMatch = url.match(/evd=(\d{12})/); // 12 digits: YYYYMMDDHHMM
                if (evdMatch) {
                    const timestamp = evdMatch[1];
                    // Extract date (first 8 digits) - use if not already extracted
                    if (!startDate) {
                        const year = timestamp.substring(0, 4);
                        const month = timestamp.substring(4, 6);
                        const day = timestamp.substring(6, 8);
                        startDate = `${year}-${month}-${day}`;
                    }
                    
                    // Extract time (last 4 digits: HHMM) - use if not already extracted from page
                    if (!startTime) {
                        const hour = timestamp.substring(8, 10);
                        const minute = timestamp.substring(10, 12);
                        startTime = `${hour}:${minute}:00`;
                    }
                    
                    // If no end time extracted, calculate default (add 90 minutes for typical event)
                    if (!endTime && startTime) {
                        // Parse start time to calculate end time
                        const timeMatch = startTime.match(/(\d{2}):(\d{2})/);
                        if (timeMatch) {
                            const startHour = parseInt(timeMatch[1]);
                            const startMin = parseInt(timeMatch[2]);
                            const totalMinutes = startHour * 60 + startMin + 90; // Add 90 minutes
                            const endHour = Math.floor(totalMinutes / 60) % 24;
                            const endMin = totalMinutes % 60;
                            endTime = `${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}:00`;
                        }
                    }
                } else if (!startDate) {
                    // Try to extract just date (8 digits)
                    const dateMatch = url.match(/evd=(\d{8})/);
                    if (dateMatch) {
                        const dateStr = dateMatch[1]; // YYYYMMDD
                        startDate = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
                    } else {
                        // Use today
                        const today = new Date();
                        startDate = today.toISOString().split('T')[0];
                    }
                }
                
                // If we have start time but no end time, add default duration (90 minutes)
                if (startTime && !endTime) {
                    const timeMatch = startTime.match(/(\d{2}):(\d{2})/);
                    if (timeMatch) {
                        const startHour = parseInt(timeMatch[1]);
                        const startMin = parseInt(timeMatch[2]);
                        const totalMinutes = startHour * 60 + startMin + 90; // Add 90 minutes
                        const endHour = Math.floor(totalMinutes / 60) % 24;
                        const endMin = totalMinutes % 60;
                        endTime = `${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}:00`;
                    }
                }
                
                // Step 4: Prepare location (meeting point)
                // The location should be the specific meeting point (e.g., "West Building Main Floor, Gallery 40")
                // The venue is set separately (e.g., "National Gallery of Art")
                let meetingLocation = extractedData.location || extractedData.start_location || '';
                
                // For NGA events, try to extract location from description if not found
                if (!meetingLocation && url.includes('nga.gov')) {
                    // Look for patterns like "West Building", "Gallery 40", etc. in description
                    const desc = extractedData.description || '';
                    const locationPatterns = [
                        /(West Building[^.]*)/i,
                        /(East Building[^.]*)/i,
                        /(Gallery\s+\d+[^.]*)/i,
                        /(Main Floor[^.]*)/i,
                        /(West Building Main Floor, Gallery \d+)/i
                    ];
                    
                    for (const pattern of locationPatterns) {
                        const match = desc.match(pattern);
                        if (match) {
                            meetingLocation = match[1].trim();
                            break;
                        }
                    }
                    
                    // Also check title for location hints
                    if (!meetingLocation && extractedData.title) {
                        const titleMatch = extractedData.title.match(/(West Building|East Building|Gallery \d+)/i);
                        if (titleMatch) {
                            meetingLocation = titleMatch[1];
                        }
                    }
                }
                
                // Step 5: Create the event
                // Use 'custom' time_period if we have a specific date, otherwise use 'today'
                const timePeriod = startDate ? 'custom' : 'today';
                
                const createData = {
                    url: url,
                    venue_id: venueId || null,
                    city_id: parseInt(cityId),
                    time_period: timePeriod,
                    start_date: startDate || null, // Use extracted date if available
                    end_date: startDate || null,   // Use extracted date if available
                    title: extractedData.title,
                    description: extractedData.description || '',
                    start_time: startTime || extractedData.start_time || null,
                    end_time: endTime || extractedData.end_time || null,
                    location: meetingLocation, // This becomes start_location in the event
                    image_url: extractedData.image_url || null,
                    schedule_info: extractedData.schedule_info || null,
                    // Include registration and price fields from extracted data
                    // Convert price to number if it's "Free" or 0
                    price: (extractedData.price !== undefined && extractedData.price !== null) 
                        ? (extractedData.price === 'Free' || extractedData.price === 0 || extractedData.price === '0' ? 0.0 : extractedData.price)
                        : null,
                    admission_price: (extractedData.admission_price !== undefined && extractedData.admission_price !== null)
                        ? (extractedData.admission_price === 'Free' || extractedData.admission_price === 0 || extractedData.admission_price === '0' ? 0.0 : extractedData.admission_price)
                        : null,
                    is_registration_required: extractedData.is_registration_required || false,
                    registration_url: extractedData.registration_url || null,
                    registration_info: extractedData.registration_info || null
                };
                
                const createResponse = await fetch('/api/admin/scrape-event-from-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(createData)
                });
                
                const createResult = await createResponse.json();
                
                if (createResponse.ok) {
                    const eventCount = createResult.events_created || 0;
                    statusDiv.innerHTML = `<span style="color: #10b981;"> Successfully created ${eventCount} event(s)!</span>`;
                    urlInput.value = ''; // Clear input
                    
                    // Refresh events table
                    await loadEvents();
                    
                    // Clear status after 5 seconds
                    setTimeout(() => {
                        statusDiv.innerHTML = '';
                    }, 5000);
                } else {
                    statusDiv.innerHTML = `<span style="color: #ef4444;"> Failed to create event: ${createResult.error || 'Unknown error'}</span>`;
                }
                
            } catch (error) {
                console.error('Quick create error:', error);
                statusDiv.innerHTML = `<span style="color: #ef4444;"> Error: ${error.message}</span>`;
            }
        }
        
        // Handle image upload form submission
        function setupImageUploadForm() {
            const imageUploadForm = document.getElementById('imageUploadForm');
            if (imageUploadForm) {
                imageUploadForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('Form submission started');
                    
                    const formData = new FormData();
                    const imageFile = document.getElementById('eventImage').files[0];
                    
                    if (!imageFile) {
                        alert('Please select an image file');
                        return;
                    }
                    
                    console.log('Image file selected:', imageFile.name);
                    console.log('Image file size:', imageFile.size);
                    console.log('Image file type:', imageFile.type);
                    console.log('Image file lastModified:', new Date(imageFile.lastModified));
                    formData.append('image', imageFile);
                    
                    // Add OCR engine selection
                    const ocrEngine = document.getElementById('ocrEngine').value;
                    console.log('OCR Engine selected:', ocrEngine);
                    formData.append('ocr_engine', ocrEngine);
                    
                    try {
                        console.log('Sending request to API...');
                        const response = await fetch('/api/admin/upload-event-image', {
                            method: 'POST',
                            body: formData
                        });
                        
                        console.log('Response received:', response.status);
                        const result = await response.json();
                        console.log('Result parsed:', result);
                        
                        if (response.ok) {
                            console.log('Upload successful, result:', result);
                            if (result.extracted_data) {
                                console.log('Calling displayExtractedData...');
                                displayExtractedData(result.extracted_data);
                            } else {
                                console.error('No extracted_data in result:', result);
                            }
                        } else {
                            console.error('Upload failed:', result);
                            alert('Error processing image: ' + result.error);
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        alert('Error uploading image: ' + error.message);
                    }
                });
            } else {
                console.error('imageUploadForm not found');
            }
        }
        
        function displayExtractedData(data) {
            console.log('displayExtractedData called with:', data);
            const displayDiv = document.getElementById('extractedDataDisplay');
            const contentDiv = document.getElementById('extractedDataContent');
            
            console.log('DOM elements found:', { displayDiv, contentDiv });
            
            if (!displayDiv || !contentDiv) {
                console.error('Required elements not found:', { displayDiv, contentDiv });
                return;
            }
            
            console.log('About to populate manual fields...');
            // Store extracted data for later use (including venue_id)
            window.extractedEventData = data;
            console.log(' Stored extracted data:', data);
            // First, populate the form fields with extracted data
            populateManualFields(data);
            console.log('Manual fields populated');
            
            let html = '<div class="extracted-data-grid">';
            
            if (data.title) html += `<div><strong>Title:</strong> ${data.title}</div>`;
            if (data.description) html += `<div><strong>Description:</strong> ${data.description}</div>`;
            if (data.start_date) html += `<div><strong>Start Date:</strong> ${data.start_date}</div>`;
            if (data.end_date) html += `<div><strong>End Date:</strong> ${data.end_date}</div>`;
            if (data.start_time) html += `<div><strong>Start Time:</strong> ${data.start_time}</div>`;
            if (data.end_time) html += `<div><strong>End Time:</strong> ${data.end_time}</div>`;
            if (data.location) html += `<div><strong>Location:</strong> ${data.location}</div>`;
            if (data.start_location) html += `<div><strong>Start Location:</strong> ${data.start_location}</div>`;
            if (data.end_location) html += `<div><strong>End Location:</strong> ${data.end_location}</div>`;
            if (data.event_type) html += `<div><strong>Event Type:</strong> ${data.event_type}</div>`;
            if (data.price) html += `<div><strong>Price:</strong> $${data.price}</div>`;
            if (data.organizer) html += `<div><strong>Organizer:</strong> ${data.organizer}</div>`;
            if (data.url) html += `<div><strong>URL:</strong> <a href="${data.url}" target="_blank">${data.url}</a></div>`;
            if (data.is_online !== undefined) html += `<div><strong>Online/Virtual:</strong> ${data.is_online ? 'Yes' : 'No'}</div>`;
            if (data.is_registration_required !== undefined) html += `<div><strong>Registration Required:</strong> ${data.is_registration_required ? 'Yes' : 'No'}</div>`;
            if (data.registration_info) html += `<div><strong>Registration Info:</strong> ${data.registration_info}</div>`;
            if (data.registration_url) html += `<div><strong>Registration URL:</strong> <a href="${data.registration_url}" target="_blank">${data.registration_url}</a></div>`;
            if (data.city) html += `<div><strong>City:</strong> ${data.city}</div>`;
            if (data.state) html += `<div><strong>State:</strong> ${data.state}</div>`;
            // Social media fields
            if (data.social_media_platform) html += `<div><strong>Social Media Platform:</strong> ${data.social_media_platform}</div>`;
            if (data.social_media_handle) html += `<div><strong>Social Media Handle:</strong> @${data.social_media_handle}</div>`;
            if (data.social_media_page_name) html += `<div><strong>Page/Group Name:</strong> ${data.social_media_page_name}</div>`;
            if (data.social_media_posted_by) html += `<div><strong>Posted By:</strong> ${data.social_media_posted_by}</div>`;
            if (data.social_media_url) html += `<div><strong>Social Media URL:</strong> <a href="${data.social_media_url}" target="_blank">${data.social_media_url}</a></div>`;
            if (data.country) html += `<div><strong>Country:</strong> ${data.country}</div>`;
            if (data.city_id) html += `<div><strong>City ID:</strong> ${data.city_id}</div>`;
            if (data.source) html += `<div><strong>Source:</strong> ${data.source}</div>`;
            if (data.source_url) html += `<div><strong>Source URL:</strong> <a href="${data.source_url}" target="_blank">${data.source_url}</a></div>`;
            if (data.instagram_handle) html += `<div><strong>Instagram Handle:</strong> @${data.instagram_handle}</div>`;
            
            html += `<div><strong>Confidence:</strong> ${Math.round(data.confidence * 100)}%</div>`;
            html += '</div>';
            
            contentDiv.innerHTML = html;
            console.log('Content HTML set, about to show display div');
            displayDiv.style.display = 'block';
            console.log('Display div shown');
            
            // Populate manual input fields with extracted data (second time for safety)
            console.log('Populating manual fields again...');
            populateManualFields(data);
            console.log('Manual fields populated again');
            
            // Store extracted data for event creation
            window.extractedEventData = data;
            console.log('Extracted data stored in window.extractedEventData');
        }
        
        async function populateCitySelect(selectId, targetCity = null, targetState = null) {
            console.log(`populateCitySelect called for: ${selectId}`);
            const select = document.getElementById(selectId);
            if (!select) {
                console.error(`Element with id '${selectId}' not found`);
                return;
            }
            
            console.log(`Found select element:`, select);
            
            try {
                console.log('Fetching cities from /api/admin/cities...');
                const response = await fetch('/api/admin/cities');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const cities = await response.json();
                console.log(`Received ${cities.length} cities:`, cities);
                
                // Clear existing options
                select.innerHTML = '<option value="">Select City</option>';
                
                // Add cities to dropdown
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = `${city.name}, ${city.state}`;
                    select.appendChild(option);
                    
                    // Auto-select if this matches the target city
                    if (targetCity && targetState && 
                        city.name.toLowerCase() === targetCity.toLowerCase() && 
                        city.state === targetState) {
                        option.selected = true;
                        console.log(`Auto-selected city: ${city.name}, ${city.state}`);
                    }
                });
                
                console.log(`Successfully populated city dropdown with ${cities.length} cities`);
            } catch (error) {
                console.error('Error loading cities:', error);
                select.innerHTML = '<option value="">Error loading cities</option>';
            }
        }
        
        function populateManualFields(data) {
            // Populate manual input fields with extracted data
            console.log('=== POPULATING FORM WITH EXTRACTED DATA ===');
            console.log('Extracted data:', data);
            
            if (!data) {
                console.error('No data provided to populateManualFields');
                return;
            }
            
            const fields = [
                'manualEventTitle', 'manualEventDescription', 'manualStartDate', 'manualEndDate',
                'manualStartTime', 'manualEndTime', 'manualEventType', 'manualStartLocation', 'manualEndLocation',
                'manualPrice', 'manualUrl', 'manualEventSource', 'manualSourceUrl',
                'manualSocialMediaPlatform', 'manualSocialMediaHandle', 'manualSocialMediaPageName',
                'manualSocialMediaPostedBy', 'manualSocialMediaUrl'
            ];
            
            // Helper function to safely set field value
            function setFieldValue(fieldId, value) {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = value || '';
                    console.log(`Set ${fieldId} = "${value}"`);
                } else {
                    console.warn(`Field not found: ${fieldId}`);
                }
            }
            
            // Populate all fields safely
            console.log(`Setting title: "${data.title}"`);
            setFieldValue('manualEventTitle', data.title);
            setFieldValue('manualEventDescription', data.description);
            setFieldValue('manualStartDate', data.start_date);
            setFieldValue('manualEndDate', data.end_date);
            setFieldValue('manualStartTime', data.start_time);
            setFieldValue('manualEndTime', data.end_time);
            
            // Smart event type mapping to available dropdown options
            console.log(` Event type from backend: "${data.event_type}"`);
            if (data.event_type) {
                const eventTypeField = document.getElementById('manualEventType');
                if (eventTypeField) {
                    const smartMatch = findBestMatch(data.event_type, eventTypeField, 'event type');
                    console.log(` Smart match result: ${smartMatch}`);
                    if (smartMatch !== -1) {
                        eventTypeField.selectedIndex = smartMatch;
                        console.log(` Event type selected: ${eventTypeField.options[smartMatch].text} (value: ${eventTypeField.options[smartMatch].value})`);
                    } else {
                        console.log(` No suitable event type match found for: ${data.event_type}`);
                        setFieldValue('manualEventType', 'tour'); // Default fallback
                    }
                }
            } else {
                console.log(` No event_type in data, defaulting to 'tour'`);
                setFieldValue('manualEventType', 'tour'); // Default
            }
            
            setFieldValue('manualStartLocation', data.start_location);
            setFieldValue('manualEndLocation', data.end_location);
            setFieldValue('manualPrice', data.price);
            // Handle Instagram URL - convert handle to full URL
            if (data.instagram_handle) {
                setFieldValue('manualUrl', `https://instagram.com/${data.instagram_handle}`);
            } else if (data.url) {
                setFieldValue('manualUrl', data.url);
            }
            
            // Populate source fields
            if (data.source) {
                setFieldValue('manualEventSource', data.source);
            }
            if (data.source_url) {
                setFieldValue('manualSourceUrl', data.source_url);
            }
            
            // Social media fields
            if (data.social_media_platform) {
                setFieldValue('manualSocialMediaPlatform', data.social_media_platform);
            }
            if (data.social_media_handle) {
                setFieldValue('manualSocialMediaHandle', data.social_media_handle);
            }
            if (data.social_media_page_name) {
                setFieldValue('manualSocialMediaPageName', data.social_media_page_name);
            }
            if (data.social_media_posted_by) {
                setFieldValue('manualSocialMediaPostedBy', data.social_media_posted_by);
            }
            if (data.social_media_url) {
                setFieldValue('manualSocialMediaUrl', data.social_media_url);
            }
            
            // Set default date to today if no date extracted
            if (!data.start_date) {
                const today = new Date().toISOString().split('T')[0];
                setFieldValue('manualStartDate', today);
            }
            
            // Auto-select city if extracted (ensure dropdown is populated first)
            const selectCityAfterPopulation = async (cityId, cityName) => {
                const citySelect = document.getElementById('manualCityId');
                if (!citySelect) {
                    console.error('City select element not found');
                    return;
                }
                
                // Ensure dropdown is populated
                const ensureDropdownPopulated = async () => {
                    const options = citySelect.options;
                    if (options.length <= 1) {
                        console.log('City dropdown not populated yet, populating now...');
                        await populateCitySelect('manualCityId');
                        // Wait a bit for DOM to update
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                };
                
                await ensureDropdownPopulated();
                
                const options = citySelect.options;
                console.log(` Attempting to select city ID ${cityId} (type: ${typeof cityId}), dropdown has ${options.length} options`);
                
                // Log all available city IDs for debugging
                const availableIds = [];
                for (let i = 0; i < options.length; i++) {
                    if (options[i].value) {
                        availableIds.push(`${options[i].value} (${options[i].text})`);
                    }
                }
                console.log(` Available city IDs in dropdown:`, availableIds);
                
                // Try to find and select the city by ID (compare as both string and number)
                let found = false;
                const cityIdStr = String(cityId);
                const cityIdNum = Number(cityId);
                
                for (let i = 0; i < options.length; i++) {
                    const optionValue = options[i].value;
                    // Try both string and number comparison
                    if (optionValue == cityId || optionValue == cityIdStr || optionValue == cityIdNum) {
                        citySelect.selectedIndex = i;
                        citySelect.dispatchEvent(new Event('change'));
                        console.log(` City selected by ID: ${options[i].text} (ID: ${cityId}, matched option value: ${optionValue})`);
                        found = true;
                        break;
                    }
                }
                
                if (!found) {
                    console.log(` City ID ${cityId} not found in dropdown options. Available IDs: ${availableIds.join(', ')}`);
                    // Fall back to city name matching if available
                    if (cityName) {
                        console.log(` Attempting city name fallback for: ${cityName}`);
                        const smartMatch = findBestMatch(cityName, citySelect, 'city');
                        if (smartMatch !== -1) {
                            citySelect.selectedIndex = smartMatch;
                            citySelect.dispatchEvent(new Event('change'));
                            console.log(` City selected by name fallback: ${options[smartMatch].text} (ID: ${options[smartMatch].value})`);
                        } else {
                            console.log(` Could not match city name: ${cityName}`);
                            // Try direct text match
                            for (let i = 0; i < options.length; i++) {
                                if (options[i].text.toLowerCase().includes(cityName.toLowerCase())) {
                                    citySelect.selectedIndex = i;
                                    citySelect.dispatchEvent(new Event('change'));
                                    console.log(` City selected by direct text match: ${options[i].text}`);
                                    break;
                                }
                            }
                        }
                    }
                }
            };
            
            console.log(` City data received - city_id: ${data.city_id} (type: ${typeof data.city_id}), city: ${data.city}`);
            console.log(` Venue data received - venue_id: ${data.venue_id} (type: ${typeof data.venue_id})`);
            
            // Helper function to select venue after city is ready
            const selectVenueAfterCity = async (venueId, cityId) => {
                const venueSelect = document.getElementById('manualVenueId');
                if (!venueSelect) {
                    console.error('Venue select element not found');
                    return;
                }
                
                console.log(` Attempting to select venue ID: ${venueId} for city ID: ${cityId}`);
                
                // Wait for city to be selected and venues to be populated
                const waitForVenues = async (retryCount = 0) => {
                    if (retryCount > 15) {
                        console.log(' Venue dropdown not populated after 15 attempts');
                        return;
                    }
                    
                    // Populate venues if we have a city_id
                    const citySelect = document.getElementById('manualCityId');
                    const currentCityId = citySelect ? citySelect.value : null;
                    
                    // Use provided cityId or current selection
                    const targetCityId = cityId || currentCityId;
                    
                    if (targetCityId) {
                        console.log(` Populating venues for city ID: ${targetCityId} (attempt ${retryCount + 1})`);
                        await populateVenuesForCity(targetCityId, 'manualVenueId');
                        await new Promise(resolve => setTimeout(resolve, 150));
                    }
                    
                    const options = venueSelect.options;
                    console.log(` Venue dropdown has ${options.length} options`);
                    
                    if (options.length <= 1) {
                        setTimeout(() => waitForVenues(retryCount + 1), 200);
                        return;
                    }
                    
                    // Try to select the venue
                    const venueIdStr = String(venueId);
                    const venueIdNum = Number(venueId);
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].value == venueId || options[i].value == venueIdStr || options[i].value == venueIdNum) {
                            venueSelect.selectedIndex = i;
                            venueSelect.dispatchEvent(new Event('change'));
                            console.log(` Venue selected: ${options[i].text} (ID: ${venueId})`);
                            return;
                        }
                    }
                    console.log(` Venue ID ${venueId} not found in dropdown. Available IDs: ${Array.from(options).map(o => o.value).join(', ')}`);
                };
                
                await waitForVenues();
            };
            
            // Auto-select city first (required for venue selection)
            if (data.city_id) {
                console.log(` Auto-selecting city ID: ${data.city_id}, city: ${data.city}`);
                selectCityAfterPopulation(data.city_id, data.city).then(() => {
                    console.log(` City selection completed, now selecting venue...`);
                    // After city is selected, select venue if provided
                    if (data.venue_id) {
                        selectVenueAfterCity(data.venue_id, data.city_id);
                    }
                }).catch(err => {
                    console.error(' Error selecting city:', err);
                    // Even if city selection fails, try to select venue with the city_id we have
                    if (data.venue_id && data.city_id) {
                        console.log(` Attempting venue selection despite city selection error...`);
                        selectVenueAfterCity(data.venue_id, data.city_id);
                    }
                });
            } else if (data.city) {
                // Smart city matching with retry logic
                console.log(`Looking for city: ${data.city}`);
                const citySelect = document.getElementById('manualCityId');
                if (citySelect) {
                    // Function to attempt city selection
                    const attemptCitySelection = (retryCount = 0) => {
                        const options = citySelect.options;
                        console.log(`City dropdown has ${options.length} options (attempt ${retryCount + 1})`);
                        
                        if (options.length <= 1) { // Only has "Select City" option
                            if (retryCount < 5) {
                                console.log(`City dropdown not populated yet, retrying in 200ms...`);
                                setTimeout(() => attemptCitySelection(retryCount + 1), 200);
                                return;
                            } else {
                                console.log(`City dropdown still not populated after 5 attempts`);
                                return;
                            }
                        }
                        
                        // Try smart matching
                        const smartMatch = findBestMatch(data.city, citySelect, 'city');
                        if (smartMatch !== -1) {
                            citySelect.selectedIndex = smartMatch;
                            console.log(` City selected: ${options[smartMatch].text}`);
                        } else {
                            console.log(` No city match found for: ${data.city}`);
                        }
                    };
                    
                    // Start the city selection process
                    attemptCitySelection();
                }
            }
            
            // Additional city selection logic
            if (data.city && data.state) {
                console.log(`Attempting to auto-select city: ${data.city}, ${data.state}`);
                populateCitySelect('manualCityId', data.city, data.state);
            }
        }
        
        async function createEventFromExtractedData() {
            // Get data from manual input fields
            const title = document.getElementById('manualEventTitle').value.trim();
            const startDate = document.getElementById('manualStartDate').value;
            
            if (!title) {
                alert('Event title is required');
                return;
            }
            
            if (!startDate) {
                alert('Start date is required');
                return;
            }
            
            // Handle end date - if no end date provided, assume same as start date
            let endDate = document.getElementById('manualEndDate').value || startDate;
            
            // Handle end time - if start time provided but no end time, assume 1 hour duration
            let startTime = document.getElementById('manualStartTime').value || null;
            let endTime = document.getElementById('manualEndTime').value || null;
            
            if (startTime && !endTime) {
                // Calculate end time (1 hour after start time)
                const startTimeObj = new Date(`2000-01-01T${startTime}`);
                const endTimeObj = new Date(startTimeObj.getTime() + 60 * 60 * 1000); // Add 1 hour
                endTime = endTimeObj.toTimeString().slice(0, 5); // Format as HH:MM
            }
            
            const data = {
                title: title,
                description: document.getElementById('manualEventDescription').value.trim(),
                start_date: startDate,
                end_date: endDate,
                start_time: startTime,
                end_time: endTime,
                event_type: document.getElementById('manualEventType').value,
                start_location: document.getElementById('manualStartLocation').value.trim(),
                end_location: document.getElementById('manualEndLocation').value.trim(),
                price: document.getElementById('manualPrice').value ? parseFloat(document.getElementById('manualPrice').value) : null,
                url: document.getElementById('manualUrl').value.trim() || null,
                city_id: document.getElementById('manualCityId').value || null,
                venue_id: document.getElementById('manualVenueId').value || null,
                source: document.getElementById('manualEventSource').value || null,
                source_url: document.getElementById('manualSourceUrl').value.trim() || null,
                // Social media fields
                social_media_platform: document.getElementById('manualSocialMediaPlatform').value || null,
                social_media_handle: document.getElementById('manualSocialMediaHandle').value || null,
                social_media_page_name: document.getElementById('manualSocialMediaPageName').value || null,
                social_media_posted_by: document.getElementById('manualSocialMediaPostedBy').value || null,
                social_media_url: document.getElementById('manualSocialMediaUrl').value || null,
                // Online/virtual status (from extracted data or defaults)
                is_online: window.extractedEventData?.is_online || false,
                // Registration fields (from extracted data or defaults)
                is_registration_required: window.extractedEventData?.is_registration_required || false,
                registration_url: window.extractedEventData?.registration_url || null,
                create_calendar_event: false
            };
            
            try {
                const response = await fetch('/api/admin/create-event-from-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Event created successfully! Event ID: ${result.event_id}`);
                    if (result.calendar_event_id) {
                        alert('Google Calendar event also created!');
                    }
                    closeModal('imageUploadModal');
                    loadEvents();
                } else {
                    alert('Error creating event: ' + result.error);
                }
            } catch (error) {
                alert('Error creating event: ' + error.message);
            }
        }
        
        // Handle create from venue form submission
        document.getElementById('createFromVenueForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Handle end date - if no end date provided, assume same as start date
            const startDate = document.getElementById('startDateFromVenue').value;
            let endDate = document.getElementById('endDateFromVenue').value || startDate;
            
            // Handle end time - if start time provided but no end time, assume 1 hour duration
            let startTime = document.getElementById('startTimeFromVenue').value || null;
            let endTime = document.getElementById('endTimeFromVenue').value || null;
            
            if (startTime && !endTime) {
                // Calculate end time (1 hour after start time)
                const startTimeObj = new Date(`2000-01-01T${startTime}`);
                const endTimeObj = new Date(startTimeObj.getTime() + 60 * 60 * 1000); // Add 1 hour
                endTime = endTimeObj.toTimeString().slice(0, 5); // Format as HH:MM
            }
            
            const formData = {
                venue_id: document.getElementById('venueSelect').value,
                title: document.getElementById('eventTitleFromVenue').value,
                description: document.getElementById('eventDescriptionFromVenue').value,
                start_date: startDate,
                end_date: endDate,
                start_time: startTime,
                end_time: endTime,
                event_type: document.getElementById('eventTypeFromVenue').value,
                url: document.getElementById('eventUrlFromVenue').value || null,
                source: document.getElementById('eventSourceFromVenue').value || null,
                source_url: document.getElementById('sourceUrlFromVenue').value.trim() || null,
                create_calendar_event: document.getElementById('createCalendarEventFromVenue').checked
            };
            
            try {
                const response = await fetch('/api/admin/create-event-from-venue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`Event created successfully! Event ID: ${result.event_id}`);
                    if (result.calendar_event_id) {
                        alert('Google Calendar event also created!');
                    }
                    closeModal('createFromVenueModal');
                    loadEvents();
                } else {
                    alert('Error creating event: ' + result.error);
                }
            } catch (error) {
                alert('Error creating event: ' + error.message);
            }
        });
        
        // Event Scraping Functions
        async function startSmithsonianScraping() {
            updateScrapingStatus(' Starting Smithsonian scraping...', 'info');
            
            try {
                const response = await fetch('/api/admin/scrape-smithsonian', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateScrapingStatus(` Smithsonian scraping completed! Found ${result.events_found} events, saved ${result.events_saved}`, 'success');
                    // Reload events table
                    await loadEvents();
                } else {
                    updateScrapingStatus(` Smithsonian scraping failed: ${result.error}`, 'error');
                }
            } catch (error) {
                updateScrapingStatus(` Smithsonian scraping error: ${error.message}`, 'error');
            }
        }
        
        async function startMuseumScraping() {
            showScrapingProgressModal('Museums');
            
            try {
                const response = await fetch('/api/admin/scrape-museums', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateScrapingProgress({
                        percentage: 100,
                        message: ` Scraping completed! Scraped ${result.museums_scraped} museums, saved ${result.events_saved} events`,
                        events_saved: result.events_saved
                    });
                    await loadEvents();
                    setTimeout(() => closeScrapingProgressModal(), 3000);
                } else {
                    updateScrapingProgress({
                        percentage: 0,
                        message: ` Scraping failed: ${result.error}`,
                        error: true
                    });
                }
            } catch (error) {
                updateScrapingProgress({
                    percentage: 0,
                    message: ` Scraping error: ${error.message}`,
                    error: true
                });
            }
        }
        
        async function startHirshhornScraping() {
            showScrapingProgressModal('Hirshhorn Museum');
            
            try {
                const response = await fetch('/api/admin/scrape-hirshhorn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateScrapingProgress({
                        percentage: 100,
                        message: ` Scraping completed! Found ${result.events_found} exhibitions, saved ${result.events_saved} events`,
                        events_saved: result.events_saved,
                        events_found: result.events_found
                    });
                    // Reload events table
                    await loadEvents();
                    // Close modal after 3 seconds
                    setTimeout(() => {
                        closeScrapingProgressModal();
                    }, 3000);
                } else {
                    updateScrapingProgress({
                        percentage: 0,
                        message: ` Scraping failed: ${result.error}`,
                        error: true
                    });
                }
            } catch (error) {
                updateScrapingProgress({
                    percentage: 0,
                    message: ` Scraping error: ${error.message}`,
                    error: true
                });
            }
        }
        
        async function startAllVenuesScraping() {
            showScrapingProgressModal('All Venues');
            
            try {
                const response = await fetch('/api/admin/scrape-all-venues', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateScrapingProgress({
                        percentage: 100,
                        message: ` Scraping completed! Scraped ${result.venues_scraped} venues, saved ${result.events_saved} events`,
                        events_saved: result.events_saved
                    });
                    await loadEvents();
                    setTimeout(() => closeScrapingProgressModal(), 3000);
                } else {
                    updateScrapingProgress({
                        percentage: 0,
                        message: ` Scraping failed: ${result.error}`,
                        error: true
                    });
                }
            } catch (error) {
                updateScrapingProgress({
                    percentage: 0,
                    message: ` Scraping error: ${error.message}`,
                    error: true
                });
            }
        }
        
        async function startWebstersScraping() {
            updateScrapingStatus(' Scraping Webster\'s Bookstore Cafe events...', 'info');
            try {
                const response = await fetch('/api/admin/scrape-websters', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let statusMsg = ` Webster's scraping completed! Found ${result.events_found} events`;
                    if (result.events_saved > 0) {
                        statusMsg += `, created ${result.events_saved} new events`;
                    }
                    if (result.events_skipped > 0) {
                        statusMsg += `, ${result.events_skipped} already existed`;
                    }
                    updateScrapingStatus(statusMsg, 'success');
                    // Reload events table
                    await loadEvents();
                } else {
                    updateScrapingStatus(` Webster's scraping failed: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error scraping Webster\'s events:', error);
                updateScrapingStatus(` Webster's scraping error: ${error.message}`, 'error');
            }
        }
        
        async function startNGAScraping() {
            showScrapingProgressModal('National Gallery of Art');
            
            try {
                const response = await fetch('/api/admin/scrape-nga', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Progress modal will be updated via polling
                    // Auto-close after a delay
                    setTimeout(() => {
                        closeScrapingProgressModal();
                        loadEvents();
                    }, 2000);
                } else {
                    updateScrapingStatus(` Error: ${result.error || 'Unknown error'}`, 'error');
                    closeScrapingProgressModal();
                }
            } catch (error) {
                console.error('NGA scraping error:', error);
                updateScrapingStatus(` Error: ${error.message}`, 'error');
                closeScrapingProgressModal();
            }
        }
        
        async function startSAAMScraping() {
            updateScrapingStatus(' Starting SAAM scraping (exhibitions, tours, talks)...', 'info');
            
            try {
                const response = await fetch('/api/admin/scrape-saam', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateScrapingStatus(` SAAM scraping completed! Found ${result.events_found} events, saved ${result.events_saved} new, updated ${result.events_updated} existing`, 'success');
                    // Reload events table
                    await loadEvents();
                } else {
                    updateScrapingStatus(` SAAM scraping failed: ${result.error}`, 'error');
                }
            } catch (error) {
                updateScrapingStatus(` SAAM scraping error: ${error.message}`, 'error');
            }
        }
        
        async function startNPGScraping() {
            updateScrapingStatus(' Starting NPG scraping (exhibitions, tours, talks, programs)...', 'info');
            
            try {
                const response = await fetch('/api/admin/scrape-npg', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateScrapingStatus(` NPG scraping completed! Found ${result.events_found} events, saved ${result.events_saved} new, updated ${result.events_updated} existing`, 'success');
                    // Reload events table
                    await loadEvents();
                } else {
                    updateScrapingStatus(` NPG scraping failed: ${result.error}`, 'error');
                }
            } catch (error) {
                updateScrapingStatus(` NPG scraping failed: ${error.message}`, 'error');
            }
        }

        async function startAsianArtScraping() {
            updateScrapingStatus(' Starting Asian Art Museum scraping (exhibitions, events, tours)...', 'info');
            
            try {
                const response = await fetch('/api/admin/scrape-asian-art', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateScrapingStatus(` Asian Art Museum scraping completed! Found ${result.events_found} events, saved ${result.events_saved} new, updated ${result.events_updated} existing`, 'success');
                    // Reload events table
                    await loadEvents();
                } else {
                    updateScrapingStatus(` Asian Art Museum scraping failed: ${result.error}`, 'error');
                }
            } catch (error) {
                updateScrapingStatus(` Asian Art Museum scraping error: ${error.message}`, 'error');
            }
        }
        
        async function startAfricanArtScraping() {
            updateScrapingStatus(' Starting African Art Museum scraping (exhibitions, events, tours)...', 'info');
            
            try {
                const response = await fetch('/api/admin/scrape-african-art', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateScrapingStatus(` African Art Museum scraping completed! Found ${result.events_found} events, saved ${result.events_saved} new, updated ${result.events_updated} existing`, 'success');
                    // Reload events table
                    await loadEvents();
                } else {
                    updateScrapingStatus(` African Art Museum scraping failed: ${result.error}`, 'error');
                }
            } catch (error) {
                updateScrapingStatus(` African Art Museum scraping error: ${error.message}`, 'error');
            }
        }
        
        async function startFindingAweScraping() {
            updateScrapingStatus(' Scraping Finding Awe events from NGA...', 'info');
            try {
                const response = await fetch('/api/admin/scrape-finding-awe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let statusMsg = ` Finding Awe scraping completed! Found ${result.events_found} events`;
                    if (result.events_saved > 0) {
                        statusMsg += `, created ${result.events_saved} new events`;
                    }
                    if (result.events_skipped > 0) {
                        statusMsg += `, ${result.events_skipped} already existed`;
                    }
                    updateScrapingStatus(statusMsg, 'success');
                    // Reload events table
                    await loadEvents();
                } else {
                    updateScrapingStatus(` Finding Awe scraping failed: ${result.error}`, 'error');
                }
            } catch (error) {
                updateScrapingStatus(` Finding Awe scraping error: ${error.message}`, 'error');
            }
        }
        
        async function discoverNewVenues() {
            updateScrapingStatus(' Discovering new venues...', 'info');
            
            try {
                const response = await fetch('/api/admin/discover-new-venues', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateScrapingStatus(` Venue discovery completed! Found ${result.events_found} events from new venues`, 'success');
                    // Reload events table
                    await loadEvents();
                } else {
                    updateScrapingStatus(` Venue discovery failed: ${result.error}`, 'error');
                }
            } catch (error) {
                updateScrapingStatus(` Venue discovery error: ${error.message}`, 'error');
            }
        }
        
        function updateScrapingStatus(message, type = 'info') {
            const statusDiv = document.getElementById('scrapingStatus');
            if (!statusDiv) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const statusMessage = `[${timestamp}] ${message}`;
            
            // Clear previous status after 10 seconds for success/info messages
            if (type === 'success' || type === 'info') {
                statusDiv.innerHTML = statusMessage;
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 10000);
            } else {
                // Keep error messages visible longer
                statusDiv.innerHTML = statusMessage;
                statusDiv.style.color = type === 'error' ? '#dc3545' : '#007bff';
            }
        }
        
        // Progress modal functions
        let progressPollInterval = null;
        
        function showScrapingProgressModal(sourceName = 'Scraping') {
            // Create modal if it doesn't exist
            let modal = document.getElementById('scrapingProgressModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'scrapingProgressModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2> ${sourceName} Progress</h2>
                            <button onclick="closeScrapingProgressModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        <div id="progressBarContainer" style="margin-bottom: 20px;">
                            <div style="background: #e5e7eb; border-radius: 10px; height: 30px; overflow: hidden; position: relative;">
                                <div id="progressBar" style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;"></div>
                            </div>
                            <div id="progressPercentage" style="text-align: center; margin-top: 8px; font-weight: bold; color: #4a5568;">0%</div>
                        </div>
                        <div id="progressMessage" style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            Starting...
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin-bottom: 10px; color: #4a5568;"> Statistics</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Events Found</div>
                                    <div id="eventsFound" style="font-size: 28px; font-weight: bold; color: #3b82f6;">0</div>
                                </div>
                                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Events Saved</div>
                                    <div id="eventsSaved" style="font-size: 28px; font-weight: bold; color: #10b981;">0</div>
                                </div>
                            </div>
                            <div id="additionalStats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <div id="venuesProcessedContainer" style="padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e7eb; display: none;">
                                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Venues Processed</div>
                                    <div id="venuesProcessed" style="font-size: 20px; font-weight: bold; color: #8b5cf6;">0/0</div>
                                </div>
                                <div id="sourcesProcessedContainer" style="padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e7eb; display: none;">
                                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Sources Processed</div>
                                    <div id="sourcesProcessed" style="font-size: 20px; font-weight: bold; color: #f59e0b;">0/0</div>
                                </div>
                            </div>
                            <div id="currentVenueContainer" style="margin-top: 10px; padding: 10px; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6; display: none;">
                                <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Currently Processing</div>
                                <div id="currentVenue" style="font-size: 14px; font-weight: 600; color: #1e40af;"></div>
                            </div>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 10px; color: #4a5568;"> Recent Events</h3>
                            <div id="recentEvents" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 10px;">
                                <div style="color: #6b7280; text-align: center; padding: 20px;">No events extracted yet...</div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            modal.style.display = 'block';
            
            // Start polling for progress
            if (progressPollInterval) {
                clearInterval(progressPollInterval);
            }
            progressPollInterval = setInterval(pollScrapingProgress, 1000); // Poll every second
        }
        
        function closeScrapingProgressModal() {
            const modal = document.getElementById('scrapingProgressModal');
            if (modal) {
                modal.style.display = 'none';
            }
            if (progressPollInterval) {
                clearInterval(progressPollInterval);
                progressPollInterval = null;
            }
        }
        
        async function pollScrapingProgress() {
            // Check if modal is still open before polling
            const modal = document.getElementById('scrapingProgressModal');
            if (!modal || modal.style.display === 'none') {
                // Modal is closed, stop polling
                if (progressPollInterval) {
                    clearInterval(progressPollInterval);
                    progressPollInterval = null;
                }
                return;
            }
            
            try {
                // Use AbortController for timeout (more compatible)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch('/api/scrape-progress', {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const progress = await response.json();
                
                if (progress.error) {
                    console.error('Error fetching progress:', progress.error);
                    return;
                }
                
                updateScrapingProgress(progress);
                
                // Stop polling if scraping is complete
                if (progress.percentage >= 100 || (progress.message && progress.message.toLowerCase().includes('complete'))) {
                    if (progressPollInterval) {
                        clearInterval(progressPollInterval);
                        progressPollInterval = null;
                    }
                    // Auto-close modal after 3 seconds
                    setTimeout(() => {
                        closeScrapingProgressModal();
                    }, 3000);
                }
            } catch (error) {
                // Only log if it's not an abort/timeout error
                if (error.name !== 'AbortError' && error.name !== 'TimeoutError') {
                    console.error('Error polling progress:', error);
                }
                // Don't stop polling on network errors - they might be temporary
            }
        }
        
        function updateScrapingProgress(progress) {
            const progressBar = document.getElementById('progressBar');
            const progressPercentage = document.getElementById('progressPercentage');
            const progressMessage = document.getElementById('progressMessage');
            const eventsFound = document.getElementById('eventsFound');
            const eventsSaved = document.getElementById('eventsSaved');
            const recentEvents = document.getElementById('recentEvents');
            
            if (!progressBar) return;
            
            const percentage = progress.percentage || progress.progress || 0;
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
            progressPercentage.textContent = percentage + '%';
            
            // Build a more detailed message
            let message = progress.message || 'Processing...';
            if (progress.current_step) {
                message = `Step ${progress.current_step}/${progress.total_steps || 3}: ${message}`;
            }
            if (progress.current_venue) {
                message += `<br><small style="opacity: 0.8;"> ${progress.current_venue}</small>`;
            }
            
            const isError = progress.error || false;
            progressMessage.innerHTML = message;
            progressMessage.style.borderLeftColor = isError ? '#ef4444' : '#3b82f6';
            progressMessage.style.background = isError ? '#fef2f2' : '#f0f9ff';
            
            if (eventsFound) {
                eventsFound.textContent = progress.events_found || 0;
            }
            if (eventsSaved) {
                eventsSaved.textContent = progress.events_saved || 0;
            }
            
            // Show/hide venues processed
            if (progress.venues_processed !== undefined && progress.total_venues !== undefined) {
                const container = document.getElementById('venuesProcessedContainer');
                const venuesInfo = document.getElementById('venuesProcessed');
                if (container && venuesInfo) {
                    container.style.display = 'block';
                    venuesInfo.textContent = `${progress.venues_processed}/${progress.total_venues}`;
                }
            }
            
            // Show/hide sources processed
            if (progress.sources_processed !== undefined && progress.total_sources !== undefined) {
                const container = document.getElementById('sourcesProcessedContainer');
                const sourcesInfo = document.getElementById('sourcesProcessed');
                if (container && sourcesInfo) {
                    container.style.display = 'block';
                    sourcesInfo.textContent = `${progress.sources_processed}/${progress.total_sources}`;
                }
            }
            
            // Show/hide current venue
            if (progress.current_venue) {
                const container = document.getElementById('currentVenueContainer');
                const currentVenueEl = document.getElementById('currentVenue');
                if (container && currentVenueEl) {
                    container.style.display = 'block';
                    currentVenueEl.textContent = progress.current_venue;
                }
            }
            
            // Update recent events with more detail
            if (recentEvents && progress.recent_events && progress.recent_events.length > 0) {
                recentEvents.innerHTML = progress.recent_events.slice(0, 10).map(event => {
                    const timeStr = event.start_time ? ` at ${event.start_time}` : '';
                    const locationStr = event.start_location ? `  ${event.start_location}` : '';
                    return `
                    <div style="padding: 10px; margin-bottom: 6px; background: white; border-radius: 6px; border-left: 4px solid #3b82f6; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-weight: bold; color: #1f2937; margin-bottom: 4px;">${event.title || 'Untitled Event'}</div>
                        <div style="font-size: 12px; color: #6b7280; display: flex; gap: 8px; flex-wrap: wrap;">
                            <span style="background: #e0e7ff; color: #4338ca; padding: 2px 6px; border-radius: 4px; font-weight: 500;">${event.event_type || 'event'}</span>
                            <span>${event.start_date || 'No date'}${timeStr}</span>
                            ${locationStr ? `<span>${locationStr.replace('  ', '')}</span>` : ''}
                        </div>
                    </div>
                `;
                }).join('');
            } else if (recentEvents && (!progress.recent_events || progress.recent_events.length === 0)) {
                recentEvents.innerHTML = '<div style="color: #6b7280; text-align: center; padding: 20px;">No events extracted yet...</div>';
            }
        }

        console.log('Minimal script test - loaded');
    </script>
</body>
</html>

